<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Create Digital Business Card</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
body{
  margin:0;
  font-family:'Poppins',system-ui;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  min-height:100vh;
  color: #1e293b;
}

.wrap{
  max-width:480px;
  margin:auto;
  padding:20px;
}

/* CLEAR VISIBLE HEADINGS WITH DARK COLOR */
h2{
  margin-top:20px;
  margin-bottom:10px;
  color:#0f172a;
  display:flex;
  align-items:center;
  gap:10px;
  font-size:18px;
  font-weight:600;
  background: rgba(255, 255, 255, 0.95);
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 2px solid rgba(102, 126, 234, 0.3);
}

.section-heading {
  color: #0f172a;
  font-size: 18px;
  font-weight: 600;
  margin: 20px 0 10px 0;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  border: 2px solid rgba(102, 126, 234, 0.3);
  display: flex;
  align-items: center;
  gap: 10px;
}

input,textarea,select{
  width:100%;
  padding:14px;
  margin:8px 0;
  border-radius:12px;
  border:2px solid rgba(102, 126, 234, 0.3);
  box-sizing:border-box;
  font-size:15px;
  background:rgba(255,255,255,0.95);
  color: #1e293b;
  font-family: 'Poppins', sans-serif;
}

input:focus, textarea:focus, select:focus {
  outline: none;
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}

button{
  width:100%;
  padding:18px;
  border:none;
  border-radius:14px;
  background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color:white;
  font-size:17px;
  margin-top:20px;
  cursor:pointer;
  font-weight:600;
  box-shadow:0 8px 25px rgba(102,126,234,0.4);
  font-family: 'Poppins', sans-serif;
  transition: all 0.3s;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(102,126,234,0.5);
}

.form-section{
  background:rgba(255,255,255,0.95);
  border-radius:20px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
  border: 2px solid rgba(255,255,255,0.2);
}

/* Social Media Section */
.social-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-top: 10px;
}

.social-input {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
  transition: all 0.3s;
}

.social-input:hover {
  border-color: #667eea;
  background: white;
}

.social-input i {
  color: #666;
  font-size: 18px;
  width: 24px;
}

.social-input input {
  flex: 1;
  border: none;
  background: transparent;
  padding: 0;
  margin: 0;
  font-size: 14px;
  color: #1e293b;
}

.social-input input:focus {
  outline: none;
}

/* Products - Grid Layout */
.products-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 20px;
  margin-top: 10px;
}

.product-box {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  border: 2px solid #e2e8f0;
  transition: all 0.3s;
}

.product-box:hover {
  border-color: #667eea;
  box-shadow: 0 8px 25px rgba(102,126,234,0.2);
}

.product-box h3 {
  margin-top: 0;
  margin-bottom: 15px;
  color: #1e293b;
  font-size: 16px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 10px;
  border-bottom: 2px solid #f1f5f9;
}

.product-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.remove-product {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 14px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: all 0.3s;
}

.remove-product:hover {
  background: #dc2626;
  transform: scale(1.05);
}

.price-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin: 15px 0;
}

.price-field {
  background: #f8fafc;
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.price-field label {
  display: block;
  font-size: 12px;
  color: #64748b;
  margin-bottom: 4px;
  font-weight: 600;
}

.price-field input {
  margin: 0;
  padding: 8px;
  font-size: 14px;
  border: 1px solid #e2e8f0;
}

.badgeGrid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:8px;
  margin-top:15px;
  padding-top:15px;
  border-top:1px solid #e2e8f0;
}
.badgeGrid label{
  display:flex;
  gap:8px;
  align-items:center;
  cursor:pointer;
  color: #475569;
  padding: 6px 8px;
  border-radius: 6px;
  transition: all 0.2s;
}

.badgeGrid label:hover {
  background: #f1f5f9;
}

.badgeGrid input[type="checkbox"] {
  accent-color: #667eea;
}

/* Delivery Settings Section */
.delivery-settings {
  background: #f8fafc;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  border: 2px solid #e2e8f0;
}

.delivery-settings h3 {
  color: #1e293b;
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.delivery-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 15px;
  margin-bottom: 15px;
}

.delivery-field {
  background: white;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #e2e8f0;
}

.delivery-field label {
  display: block;
  font-size: 12px;
  color: #64748b;
  margin-bottom: 6px;
  font-weight: 600;
}

.delivery-field input {
  margin: 0;
  padding: 8px;
  border: 1px solid #e2e8f0;
}

.dayBox{
  background:#fff;
  padding:15px;
  border-radius:12px;
  margin-bottom:10px;
  display:grid;
  grid-template-columns:28px 1fr;
  gap:12px;
  align-items:center;
  border:2px solid #e2e8f0;
  transition: all 0.2s;
}

.dayBox:hover {
  border-color: #667eea;
}

.dayCheck{display:flex;justify-content:center}
.dayContent{display:flex;flex-direction:column;gap:8px}
.dayRow{display:flex;align-items:center;gap:12px}
.dayRow label{font-weight:600;min-width:80px; color: #475569;}

.holidayBox{
  background:#fff;
  padding:16px;
  border-radius:12px;
  margin:12px 0;
  border:1px solid #e2e8f0;
}
.holidayHeader{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:12px;
}
.holidayHeader h2 {
  background: transparent;
  border: none;
  padding: 0;
  margin: 0;
  box-shadow: none;
}
.addHolidayBtn{
  background:#10b981;
  color:white;
  border:none;
  padding:10px 20px;
  border-radius:10px;
  cursor:pointer;
  font-size:14px;
  font-weight:600;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  width: auto;
}
.addHolidayBtn:hover {
  background: #0da271;
  transform: translateY(-2px);
}
.holidayItem{
  display:grid;
  grid-template-columns:1fr 120px auto;
  gap:12px;
  align-items:center;
  margin:10px 0;
  padding:12px;
  background:#f8fafc;
  border-radius:12px;
  border:2px solid #e2e8f0;
}
.holidayItem input[type="text"]{
  padding:12px;
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:14px;
  background:white;
  color: #1e293b;
}
.holidayItem input[type="date"]{
  padding:12px;
  border:1px solid #e2e8f0;
  border-radius:8px;
  font-size:14px;
  min-width:120px;
  background:white;
  color:#334155;
}
.removeHoliday{
  background:#ef4444;
  color:white;
  border:none;
  border-radius:8px;
  padding:10px 14px;
  cursor:pointer;
  font-size:16px;
  font-weight:bold;
  min-width:40px;
  height:40px;
  display:flex;
  align-items:center;
  justify-content:center;
  transition: all 0.3s;
}
.removeHoliday:hover{
  background:#dc2626;
  transform: scale(1.05);
}

@media (max-width:480px){
  .holidayItem{
    grid-template-columns:1fr;
    gap:8px;
  }
  .holidayItem input[type="date"]{
    min-width:100%;
  }
  .social-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  .delivery-row {
    grid-template-columns: 1fr;
  }
  .price-grid {
    grid-template-columns: 1fr;
  }
}

/* Payment Modal */
.payment-modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(5px);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}
.payment-content {
  background: white;
  border-radius: 20px;
  width: 90%;
  max-width: 400px;
  max-height: 90vh;
  overflow-y: auto;
  padding: 0;
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}
.payment-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 20px 20px 0 0;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.payment-header h2 {
  margin: 0;
  color: white;
  background: transparent;
  border: none;
  padding: 0;
  box-shadow: none;
  font-size: 20px;
}
.close-payment {
  background: rgba(255,255,255,0.2);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 8px 12px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s;
}
.close-payment:hover {
  background: rgba(255,255,255,0.3);
}

/* WhatsApp Preview */
.whatsapp-preview {
  margin: 20px;
  padding: 15px;
  background: #f8fafc;
  border-radius: 12px;
  border-left: 4px solid #25D366;
}
.whatsapp-preview h4 {
  color: #25D366;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.preview-message {
  background: white;
  padding: 12px;
  border-radius: 8px;
  font-size: 14px;
  color: #1e293b;
  margin-bottom: 10px;
  line-height: 1.5;
}

/* Form Labels */
.form-label {
  color: #0f172a;
  font-weight: 600;
  margin-bottom: 5px;
  display: block;
  font-size: 14px;
}

/* File Input Styling */
input[type="file"] {
  padding: 10px;
  background: white;
  border: 2px dashed #cbd5f5;
  border-radius: 10px;
  cursor: pointer;
}

input[type="file"]:hover {
  border-color: #667eea;
  background: #f8fafc;
}

/* Icon colors in headings */
h2 i {
  color: #667eea;
}

/* Info Box */
.info-box {
  background: #e0f2fe;
  border-left: 4px solid #3b82f6;
  padding: 15px;
  border-radius: 10px;
  margin: 15px 0;
  font-size: 13px;
  color: #1e293b;
}

.info-box i {
  color: #3b82f6;
  margin-right: 8px;
}

/* Toggle Switch */
.toggle-switch {
  display: flex;
  align-items: center;
  gap: 10px;
  margin: 15px 0;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
}

.toggle-switch input[type="checkbox"] {
  width: 50px;
  height: 24px;
  appearance: none;
  background: #cbd5e1;
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: all 0.3s;
}

.toggle-switch input[type="checkbox"]:checked {
  background: #10b981;
}

.toggle-switch input[type="checkbox"]::before {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: all 0.3s;
}

.toggle-switch input[type="checkbox"]:checked::before {
  left: 28px;
}

.toggle-switch span {
  font-weight: 600;
  color: #1e293b;
}
</style>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
<div class="wrap">

<!-- Profile Information -->
<div class="form-section">
<h2><i class="fas fa-user" style="color:#667eea;"></i> Profile Information</h2>
<input type="file" id="profileImage" accept="image/*">
<input id="fullName" placeholder="Full Name *" required>
<input id="phoneNumber" placeholder="Phone Number *" type="tel" required>
<input id="email" placeholder="Email Address" type="email">
<input id="address" placeholder="Business Address">
</div>

<!-- Business Details -->
<div class="form-section">
<h2><i class="fas fa-building" style="color:#667eea;"></i> Business Details</h2>
<input id="businessName" placeholder="Business Title">
<textarea id="businessAbout" placeholder="About your business" rows="4"></textarea>

<h2 style="margin-top:25px"><i class="fas fa-link" style="color:#667eea;"></i> Website & Social Media</h2>
<input type="url" id="website" placeholder="https://yourwebsite.com">

<div class="social-grid">
  <div class="social-input">
    <i class="fab fa-facebook" style="color:#1877F2;"></i>
    <input type="text" id="facebook" placeholder="Facebook URL">
  </div>
  <div class="social-input">
    <i class="fab fa-instagram" style="color:#E4405F;"></i>
    <input type="text" id="instagram" placeholder="Instagram URL">
  </div>
  <div class="social-input">
    <i class="fab fa-twitter" style="color:#1DA1F2;"></i>
    <input type="text" id="twitter" placeholder="Twitter URL">
  </div>
  <div class="social-input">
    <i class="fab fa-linkedin" style="color:#0A66C2;"></i>
    <input type="text" id="linkedin" placeholder="LinkedIn URL">
  </div>
  <div class="social-input">
    <i class="fab fa-youtube" style="color:#FF0000;"></i>
    <input type="text" id="youtube" placeholder="YouTube URL">
  </div>
  <div class="social-input">
    <i class="fab fa-tiktok" style="color:#000000;"></i>
    <input type="text" id="tiktok" placeholder="TikTok URL">
  </div>
</div>
</div>

<!-- Business Hours -->
<div class="form-section">
<h2><i class="fas fa-clock" style="color:#667eea;"></i> Business Hours</h2>
<div id="daysContainer"></div>
</div>

<!-- Special Holidays -->
<div class="form-section">
<h2><i class="fas fa-calendar-times" style="color:#667eea;"></i> Special Holidays</h2>
<div id="holidaysContainer">
  <div class="holidayItem">
   <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr" value="Eid ul-Fitr">
   <input type="date" class="holidayDate">
   <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
  </div>
</div>
<button type="button" class="addHolidayBtn" onclick="addHoliday()"><i class="fas fa-plus"></i> Add Holiday</button>
</div>

<!-- Delivery Settings - NEW SECTION -->
<div class="form-section">
<h2><i class="fas fa-truck" style="color:#667eea;"></i> Delivery Settings</h2>
<div class="delivery-settings">
  <h3><i class="fas fa-map-marker-alt"></i> Delivery Charges</h3>
  
  <div class="delivery-row">
    <div class="delivery-field">
      <label><i class="fas fa-city"></i> Within City</label>
      <input type="number" id="deliveryChargeCity" placeholder="150" value="150" min="0">
      <small style="color:#64748b;">PKR</small>
    </div>
    <div class="delivery-field">
      <label><i class="fas fa-map-marked-alt"></i> Other Cities</label>
      <input type="number" id="deliveryChargeOther" placeholder="300" value="300" min="0">
      <small style="color:#64748b;">PKR</small>
    </div>
  </div>
  
  <div class="delivery-row">
    <div class="delivery-field">
      <label><i class="fas fa-clock"></i> Within City Time</label>
      <input type="text" id="deliveryTimeCity" placeholder="1-2 days" value="1-2 days">
    </div>
    <div class="delivery-field">
      <label><i class="fas fa-clock"></i> Other Cities Time</label>
      <input type="text" id="deliveryTimeOther" placeholder="3-5 days" value="3-5 days">
    </div>
  </div>
  
  <div class="delivery-field">
    <label><i class="fas fa-gift"></i> Free Delivery Minimum</label>
    <input type="number" id="freeDeliveryMin" placeholder="2000" value="2000" min="0">
    <small style="color:#64748b;">Minimum order amount for free delivery (PKR)</small>
  </div>
  
  <div class="info-box">
    <i class="fas fa-info-circle"></i>
    Delivery charges will be calculated based on customer's address and order total.
  </div>
</div>
</div>

<!-- Products & Offers -->
<div class="form-section">
<h2><i class="fas fa-gift" style="color:#667eea;"></i> Products & Offers</h2>
<div id="productsContainer" class="products-container"></div>
<button type="button" onclick="addProduct()" style="background:linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);margin-top:12px">
 <i class="fas fa-plus"></i> Add Product
</button>
</div>

<!-- Payment & WhatsApp -->
<button type="button" onclick="openPaymentModal()" style="background:linear-gradient(135deg, #059669 0%, #10b981 100%);margin-top:24px;" id="paymentButton">
  <i class="fas fa-credit-card"></i> Configure Payment & WhatsApp
</button>

<!-- Generate Card -->
<button type="button" onclick="generate()" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);margin-top:24px">
 <i class="fas fa-magic"></i> Generate Digital Card
</button>
</div>

<!-- Payment Modal -->
<div class="payment-modal" id="paymentModal">
  <div class="payment-content">
    <div class="payment-header">
      <h2><i class="fas fa-credit-card"></i> Payment Setup</h2>
      <button class="close-payment" onclick="closePaymentModal()">√ó</button>
    </div>
    
    <div style="padding:20px;">
      <h3 style="color: #1e293b; margin-bottom: 15px; font-size: 18px; font-weight: 600;">üí≥ Payment Methods</h3>
      
      <div style="margin:20px 0;">
        <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">WhatsApp Business Number *</label>
        <input type="text" id="whatsappNumber" placeholder="+92 300 1234567" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;color: #1e293b;">
        <small style="color:#666;display:block;margin-top:5px;">This number receives order confirmations and customer inquiries</small>
      </div>
      
      <div class="whatsapp-preview">
        <h4><i class="fab fa-whatsapp"></i> WhatsApp Greeting Preview</h4>
        <div class="preview-message" id="whatsappPreview">
          Hello! üëã Welcome to [Business Name]. 
          How may I assist you today?
        </div>
      </div>
      
      <div style="margin:20px 0;">
        <h4 style="color: #1e293b; margin-bottom: 10px; font-size: 16px; font-weight: 600;">üí∞ Mobile Wallets</h4>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0;">
          <select id="mobileWalletType" style="padding:12px;border:2px solid #e2e8f0;border-radius:10px;color: #1e293b;background:white;">
            <option value="jazzcash">JazzCash</option>
            <option value="easypaisa">EasyPaisa</option>
          </select>
          <input type="text" id="jazzcashNumber" placeholder="0300 1234567" style="padding:12px;border:2px solid #e2e8f0;border-radius:10px;color: #1e293b;background:white;">
        </div>
        
        <div style="margin:15px 0;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">QR Code / Barcode</label>
          <input type="file" id="jazzcashBarcode" accept="image/*" style="width:100%;padding:10px;border:2px dashed #e2e8f0;border-radius:10px;background:white;">
          <small style="color:#666;margin-top:5px;display:block;">Upload JazzCash/EasyPaisa QR code for easy payments</small>
        </div>
      </div>
      
      <div style="margin:20px 0;">
        <h4 style="color: #1e293b; margin-bottom: 10px; font-size: 16px; font-weight: 600;">üîß Additional Settings</h4>
        
        <div class="toggle-switch">
          <input type="checkbox" id="enableCOD" checked>
          <span>Enable Cash on Delivery</span>
        </div>
        
        <div style="margin-top:15px;">
          <label style="font-weight:600;display:block;margin-bottom:8px;color: #475569;">Order Confirmation Message</label>
          <textarea id="orderConfirmationMessage" rows="3" style="width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:10px;color: #1e293b;">Thank you for your order! ‚úÖ We have received your order and will process it shortly. Your order details have been confirmed. We'll update you on the delivery status via WhatsApp.</textarea>
        </div>
      </div>
      
      <button onclick="savePaymentMethods()" style="width:100%;padding:15px;background:linear-gradient(135deg, #25D366 0%, #128C7E 100%);color:white;border:none;border-radius:12px;font-size:16px;font-weight:600;margin-top:20px;cursor:pointer;">
        <i class="fab fa-whatsapp"></i> Save Payment Configuration
      </button>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
const db = supabase.createClient(
 "https://dfvnefbxgayxqgjjgtrr.supabase.co",
 "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ========== BUSINESS HOURS ==========
const days = ["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];
const daysContainer = document.getElementById('daysContainer');

days.forEach(d => {
 const dayBox = document.createElement("div");
 dayBox.className = "dayBox";
 dayBox.innerHTML = `
  <div class="dayCheck">
   <input type="checkbox" checked class="dayOpen">
  </div>
  <div class="dayContent">
   <div class="dayRow">
    <label style="min-width:100px">${d}</label>
    <select class="dayStatus" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
     <option value="open">Open</option>
     <option value="closed">Closed</option>
    </select>
   </div>
   <div class="dayRow">
    <input type="time" class="dayStart" value="09:00" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
    <span>to</span>
    <input type="time" class="dayEnd" value="17:00" style="width:100px;padding:6px;border:1px solid #e2e8f0;border-radius:6px;">
   </div>
  </div>
 `;
 daysContainer.appendChild(dayBox);
 
 const statusSelect = dayBox.querySelector('.dayStatus');
 const timeInputs = dayBox.querySelectorAll('.dayStart, .dayEnd');
 const openCheckbox = dayBox.querySelector('.dayOpen');
 
 statusSelect.addEventListener('change', function() {
  if(this.value === 'closed') {
   timeInputs.forEach(input => input.disabled = true);
   openCheckbox.checked = false;
  } else {
   timeInputs.forEach(input => input.disabled = false);
   openCheckbox.checked = true;
  }
 });
});

// ========== HOLIDAY MANAGEMENT ==========
function addHoliday() {
 const container = document.getElementById('holidaysContainer');
 const holidayItem = document.createElement('div');
 holidayItem.className = 'holidayItem';
 holidayItem.innerHTML = `
  <input type="text" class="holidayName" placeholder="E.g., Eid ul-Fitr">
  <input type="date" class="holidayDate">
  <button type="button" class="removeHoliday" onclick="removeHoliday(this)">√ó</button>
 `;
 container.appendChild(holidayItem);
}

function removeHoliday(button) {
 button.parentElement.remove();
}

// ========== PRODUCT MANAGEMENT ==========
let productCount = 0;

function addProduct(){
 productCount++;
 const container = document.getElementById('productsContainer');
 const productBox = document.createElement("div");
 productBox.className = "product-box";
 productBox.innerHTML = `
  <div class="product-header">
   <h3><i class="fas fa-tag"></i> Product ${productCount}</h3>
   <button type="button" class="remove-product" onclick="removeProduct(this)">
    <i class="fas fa-trash"></i> Remove
   </button>
  </div>
  
  <div style="margin-bottom:15px;">
   <label style="font-weight:600;color:#475569;margin-bottom:5px;display:block;">Product Image</label>
   <input type="file" class="productImg" accept="image/*" style="width:100%;">
  </div>
  
  <input class="productTitle" placeholder="Product Title *" style="margin:8px 0;padding:12px;border:1px solid #e2e8f0;border-radius:8px;">
  <textarea class="productDesc" placeholder="Product Description" rows="2" style="margin:8px 0;padding:12px;border:1px solid #e2e8f0;border-radius:8px;"></textarea>
  
  <div class="price-grid">
   <div class="price-field">
    <label>Original Price (PKR)</label>
    <input type="number" class="originalPrice" placeholder="2999" style="width:100%;">
   </div>
   <div class="price-field">
    <label>Discounted Price (PKR)</label>
    <input type="number" class="discountPrice" placeholder="1999" style="width:100%;">
   </div>
  </div>
  
  <div style="margin-top:10px;">
   <label style="font-weight:600;color:#475569;">Product Badges</label>
   <div class="badgeGrid">
    <label><input type="checkbox" value="üî• Hot Deal"> üî• Hot Deal</label>
    <label><input type="checkbox" value="‚≠ê Best Seller"> ‚≠ê Best Seller</label>
    <label><input type="checkbox" value="üí∏ Discount"> üí∏ Discount</label>
    <label><input type="checkbox" value="‚è≥ Limited Stock"> ‚è≥ Limited Stock</label>
    <label><input type="checkbox" value="üõí In Stock"> üõí In Stock</label>
    <label><input type="checkbox" value="üöö Free Delivery"> üöö Free Delivery</label>
   </div>
  </div>
 `;
 container.appendChild(productBox);
}

function removeProduct(button) {
 if(confirm('Remove this product?')) {
   button.closest('.product-box').remove();
   productCount--;
 }
}

// ========== IMAGE COMPRESSION ==========
function resizeImage(file){
 return new Promise((resolve, reject) => {
  if(!file) resolve('');
  const img = new Image();
  img.onload = () => {
   const canvas = document.createElement("canvas");
   const max = 1024;
   const ratio = Math.min(max/img.width, max/img.height, 1);
   canvas.width = img.width * ratio;
   canvas.height = img.height * ratio;
   const ctx = canvas.getContext("2d");
   ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
   resolve(canvas.toDataURL("image/jpeg", 0.85));
  };
  img.onerror = reject;
  img.src = URL.createObjectURL(file);
 });
}

// ========== PAYMENT MODAL ==========
function openPaymentModal() {
  document.getElementById('paymentModal').style.display = 'flex';
  
  // Update WhatsApp preview with business name
  const businessName = document.getElementById('businessName').value || 'our business';
  document.getElementById('whatsappPreview').innerHTML = 
    `Hello! üëã Welcome to ${businessName}. How may I assist you today?`;
}

function closePaymentModal() {
  document.getElementById('paymentModal').style.display = 'none';
}

function savePaymentMethods() {
  const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
  const jazzcashType = document.getElementById('mobileWalletType').value;
  const jazzcashNumber = document.getElementById('jazzcashNumber').value.trim();
  const enableCOD = document.getElementById('enableCOD').checked;
  const orderConfirmationMessage = document.getElementById('orderConfirmationMessage').value;
  
  if(!whatsappNumber) {
    alert('Please enter WhatsApp number for customer service');
    return;
  }
  
  const paymentMethods = {
    whatsapp: { 
      active: true, 
      number: whatsappNumber,
      greeting: "Hello! üëã Welcome to " + (document.getElementById('businessName').value || 'our business') + ". How may I assist you today?",
      confirmationMessage: orderConfirmationMessage
    },
    jazzcash: { 
      active: jazzcashNumber.length > 0, 
      type: jazzcashType,
      barcode: '',
      number: jazzcashNumber
    },
    cod: {
      active: enableCOD
    }
  };
  
  // Save barcode if exists
  const barcodeFile = document.getElementById('jazzcashBarcode').files[0];
  if(barcodeFile) {
    resizeImage(barcodeFile).then(barcode => {
      paymentMethods.jazzcash.barcode = barcode;
      savePaymentToStorage(paymentMethods);
    });
  } else {
    savePaymentToStorage(paymentMethods);
  }
}

function savePaymentToStorage(paymentMethods) {
  localStorage.setItem('paymentMethods', JSON.stringify(paymentMethods));
  alert('‚úÖ Payment methods saved successfully!');
  closePaymentModal();
}

// ========== GENERATE CARD ==========
async function generate(){
 if(!fullName.value || !phoneNumber.value){
  alert("Name & Phone number are required");
  return;
 }

 const id = crypto.randomUUID();

 // Collect business hours
 const businessHoursArray = [];
 const dayBoxes = document.querySelectorAll(".dayBox");
 dayBoxes.forEach(box => {
  const open = box.querySelector(".dayOpen").checked;
  const status = box.querySelector(".dayStatus").value;
  const start = box.querySelector(".dayStart").value;
  const end = box.querySelector(".dayEnd").value;
  
  businessHoursArray.push({
   open: open && status === 'open',
   status: status,
   start: (open && status === 'open') ? start : null,
   end: (open && status === 'open') ? end : null
  });
 });

 // Collect holidays
 const holidaysArray = [];
 const holidayItems = document.querySelectorAll(".holidayItem");
 holidayItems.forEach(item => {
  const name = item.querySelector(".holidayName").value;
  const date = item.querySelector(".holidayDate").value;
  if(name.trim() && date) {
   holidaysArray.push({
    name: name.trim(),
    date: date
   });
  }
 });

 // Collect delivery settings
 const deliverySettings = {
   deliveryChargeCity: parseFloat(document.getElementById('deliveryChargeCity').value) || 150,
   deliveryChargeOther: parseFloat(document.getElementById('deliveryChargeOther').value) || 300,
   deliveryTimeCity: document.getElementById('deliveryTimeCity').value || "1-2 days",
   deliveryTimeOther: document.getElementById('deliveryTimeOther').value || "3-5 days",
   freeDeliveryMin: parseFloat(document.getElementById('freeDeliveryMin').value) || 2000
 };

 // Collect products
 const productsArray = [];
 const productBoxes = document.querySelectorAll(".product-box");
 
 for(let i = 0; i < productBoxes.length; i++){
  const box = productBoxes[i];
  const title = box.querySelector(".productTitle").value;
  const desc = box.querySelector(".productDesc").value;
  const file = box.querySelector(".productImg").files[0];
  const originalPrice = box.querySelector(".originalPrice").value;
  const discountPrice = box.querySelector(".discountPrice").value;
  
  if(title || desc || file){
   const badges = Array.from(box.querySelectorAll("input[type=checkbox]:checked"))
    .map(cb => cb.value);
   
   const productData = {
    title: title || "",
    desc: desc || "",
    originalPrice: originalPrice ? parseFloat(originalPrice) : null,
    discountPrice: discountPrice ? parseFloat(discountPrice) : null,
    badges: badges,
    image: ""
   };
   
   if(file){
    productData.image = await resizeImage(file);
   }
   
   productsArray.push(productData);
  }
 }

 // Load payment methods
 let paymentMethods = {
   whatsapp: { active: false, number: '', greeting: '', confirmationMessage: '' },
   jazzcash: { active: false, type: 'jazzcash', barcode: '', number: '' },
   cod: { active: true }
 };
 
 const savedPayment = localStorage.getItem('paymentMethods');
 if(savedPayment) {
   paymentMethods = JSON.parse(savedPayment);
 }

 // Social Media
 const socialMedia = {
   facebook: document.getElementById('facebook').value.trim(),
   instagram: document.getElementById('instagram').value.trim(),
   twitter: document.getElementById('twitter').value.trim(),
   linkedin: document.getElementById('linkedin').value.trim(),
   youtube: document.getElementById('youtube').value.trim(),
   tiktok: document.getElementById('tiktok').value.trim()
 };

 // Prepare card data - COMPLETE E-COMMERCE SETUP
 const cardData = {
  name: fullName.value.trim(),
  phone: phoneNumber.value.trim(),
  email: email.value.trim(),
  address: address.value.trim(),
  website: website.value.trim(),
  businessName: businessName.value.trim(),
  business: {
   about: businessAbout.value.trim()
  },
  socialMedia: socialMedia,
  businessHours: businessHoursArray,
  holidays: holidaysArray,
  products: productsArray,
  payments: paymentMethods,
  deliverySettings: deliverySettings,
  ecommerce: true,
  version: "2.0",
  createdAt: new Date().toISOString()
 };

 // Add profile image
 if(profileImage.files[0]){
  cardData.profileImage = await resizeImage(profileImage.files[0]);
 }

 // Save to Supabase
 const { data: inserted, error } = await db.from("cards").insert({
   id: id,
   data: JSON.stringify(cardData)
 }).select().single();

 if(error){
   console.error("Supabase error:", error);
   alert("Failed to save card: " + error.message);
   return;
 }

 // Store ID and redirect
 localStorage.setItem("lastCardId", inserted.id);
 
 // Clear payment methods from localStorage after successful save
 localStorage.removeItem('paymentMethods');
 
 // Redirect to card view
 location.href = "card.html?id=" + inserted.id;
}

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
  // Add initial product
  addProduct();
  
  // Set today's date for holiday fields
  const today = new Date().toISOString().split('T')[0];
  const holidayDateFields = document.querySelectorAll('.holidayDate');
  holidayDateFields.forEach(field => {
    if(!field.value) {
      field.value = today;
    }
  });
  
  // Load saved payment methods if any
  const savedPayment = localStorage.getItem('paymentMethods');
  if(savedPayment) {
    const payment = JSON.parse(savedPayment);
    if(payment.whatsapp?.number) {
      document.getElementById('whatsappNumber').value = payment.whatsapp.number;
    }
    if(payment.jazzcash?.number) {
      document.getElementById('jazzcashNumber').value = payment.jazzcash.number;
      document.getElementById('mobileWalletType').value = payment.jazzcash.type || 'jazzcash';
    }
    if(payment.cod?.active !== undefined) {
      document.getElementById('enableCOD').checked = payment.cod.active;
    }
    if(payment.whatsapp?.confirmationMessage) {
      document.getElementById('orderConfirmationMessage').value = payment.whatsapp.confirmationMessage;
    }
  }
  
  // Update WhatsApp preview when business name changes
  document.getElementById('businessName').addEventListener('input', function() {
    const businessName = this.value || 'our business';
    document.getElementById('whatsappPreview').innerHTML = 
      `Hello! üëã Welcome to ${businessName}. How may I assist you today?`;
  });
});
</script>
</body>
</html>
