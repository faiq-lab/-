<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dubai Commerce â€¢ Elite Shopping System</title>
    
    <!-- Core Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet (Free Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root {
            --dubai-gold: linear-gradient(135deg, #bf9530, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            --dubai-sand: #f5e6d3;
            --dubai-teal: #008080;
            --dubai-navy: #1a2a4f;
            --glass-premium: rgba(255, 255, 255, 0.95);
            --shadow-arabic: 0 20px 40px -12px rgba(0,0,0,0.25);
            --border-luxury: 1px solid rgba(191, 149, 48, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #fefcf7 0%, #fff9f0 100%);
            color: #1e293b;
            min-height: 100vh;
        }

        /* Dubai Luxury Cards */
        .dubai-card {
            background: var(--glass-premium);
            backdrop-filter: blur(20px);
            border: var(--border-luxury);
            border-radius: 32px;
            box-shadow: var(--shadow-arabic);
            padding: 28px;
            margin-bottom: 24px;
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
            overflow: hidden;
        }

        .dubai-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--dubai-gold);
        }

        .dubai-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 30px 60px -15px rgba(170, 119, 28, 0.25);
        }

        /* Progress Indicator - Arabic Style */
        .checkout-progress {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            padding: 20px 40px;
            background: rgba(255,255,255,0.7);
            border-radius: 50px;
            border: var(--border-luxury);
        }

        .progress-step {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 2;
        }

        .step-circle {
            width: 48px;
            height: 48px;
            background: white;
            border: 3px solid #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: #64748b;
            transition: all 0.3s;
        }

        .progress-step.active .step-circle {
            background: linear-gradient(135deg, #bf9530, #b38728);
            border-color: #bf9530;
            color: white;
            box-shadow: 0 0 20px rgba(191, 149, 48, 0.5);
        }

        .progress-step.completed .step-circle {
            background: #10b981;
            border-color: #10b981;
            color: white;
        }

        .step-label {
            margin-top: 10px;
            font-weight: 600;
            font-size: 13px;
            color: #1e293b;
        }

        /* Product Cards */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .product-item {
            background: white;
            border-radius: 24px;
            padding: 20px;
            border: 1px solid rgba(191, 149, 48, 0.2);
            transition: all 0.3s;
            cursor: pointer;
        }

        .product-item:hover {
            border-color: #bf9530;
            box-shadow: 0 15px 30px -10px rgba(191,149,48,0.2);
        }

        .product-image {
            width: 100%;
            height: 180px;
            object-fit: contain;
            margin-bottom: 16px;
        }

        .product-price {
            font-size: 22px;
            font-weight: 800;
            color: #b38728;
        }

        .dubai-badge {
            background: var(--dubai-gold);
            color: #1a2a4f;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            font-size: 12px;
        }

        /* Map Container */
        .location-map {
            height: 280px;
            width: 100%;
            border-radius: 20px;
            margin-top: 16px;
            border: 3px solid white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        /* Delivery Options */
        .delivery-card {
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .delivery-card.selected {
            border-color: #bf9530;
            background: linear-gradient(145deg, #fffcf5, #fff7e6);
        }

        /* Wallet Grid */
        .wallet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .wallet-option {
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            background: white;
        }

        .wallet-option:hover {
            border-color: #bf9530;
            transform: scale(0.98);
        }

        .wallet-option.selected {
            background: linear-gradient(145deg, #fef9e7, #fff8e7);
            border-color: #bf9530;
        }

        .wallet-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        /* Auto Address Detection */
        .address-autocomplete {
            position: relative;
        }

        .suggestion-box {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            max-height: 250px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
        }

        .suggestion-item:hover {
            background: #f8fafc;
        }

        /* Summary Total */
        .total-gold {
            font-size: 28px;
            font-weight: 800;
            background: var(--dubai-gold);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .checkout-progress {
                padding: 15px 20px;
            }
            .step-circle {
                width: 40px;
                height: 40px;
            }
        }

        .hidden-section {
            display: none;
        }

        .active-section {
            display: block;
            animation: fadeSlide 0.4s ease;
        }

        @keyframes fadeSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .crypto-address {
            background: #0a1929;
            color: #fff;
            padding: 12px;
            border-radius: 12px;
            font-family: monospace;
            letter-spacing: 2px;
        }

        .btn-dubai {
            background: var(--dubai-gold);
            border: none;
            color: #1e293b;
            font-weight: 700;
            padding: 14px 32px;
            border-radius: 40px;
            transition: 0.3s;
        }

        .btn-dubai:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(191,149,48,0.4);
            color: #0f172a;
        }
    </style>
</head>
<body>

<div class="container py-4">
    <!-- Header - Dubai Royal -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-6 fw-800" style="background: var(--dubai-gold); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                <i class="fas fa-crown me-2" style="color: #bf9530;"></i>Dubai Commerce
            </h1>
            <p class="text-muted">Luxury Shopping â€¢ Automated Delivery â€¢ Smart Payments</p>
        </div>
        <div>
            <span class="dubai-badge">
                <i class="fas fa-map-pin me-1"></i> Deliver to: <span id="header-location">Dubai Marina</span>
            </span>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="checkout-progress mb-5">
        <div class="progress-step active" data-step="1">
            <div class="step-circle">1</div>
            <span class="step-label">SHOP</span>
        </div>
        <div class="progress-step" data-step="2">
            <div class="step-circle">2</div>
            <span class="step-label">ADDRESS</span>
        </div>
        <div class="progress-step" data-step="3">
            <div class="step-circle">3</div>
            <span class="step-label">DELIVERY</span>
        </div>
        <div class="progress-step" data-step="4">
            <div class="step-circle">4</div>
            <span class="step-label">PAYMENT</span>
        </div>
        <div class="progress-step" data-step="5">
            <div class="step-circle">5</div>
            <span class="step-label">CONFIRM</span>
        </div>
    </div>

    <!-- ==================== SECTION 1: SHOPPING ==================== -->
    <div id="shop-section" class="active-section">
        <div class="row">
            <div class="col-lg-8">
                <div class="dubai-card">
                    <h4 class="fw-700 mb-4"><i class="fas fa-store-alt me-2" style="color: #bf9530;"></i> Elite Collection</h4>
                    
                    <div class="product-grid" id="product-list">
                        <!-- Dynamic Products from Dubai -->
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="dubai-card sticky-top" style="top: 20px;">
                    <h5 class="fw-700 mb-3"><i class="fas fa-shopping-bag me-2"></i> Your Cart</h5>
                    <div id="cart-mini-container">
                        <!-- Cart items here -->
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span class="fw-700" id="cart-subtotal">$0.00</span>
                    </div>
                    <button class="btn-dubai w-100 mt-3" onclick="proceedToAddress()" id="checkout-btn">
                        Proceed to Checkout <i class="fas fa-arrow-right ms-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION 2: ADDRESS & AUTO DETECTION ==================== -->
    <div id="address-section" class="hidden-section">
        <div class="row">
            <div class="col-lg-7">
                <div class="dubai-card">
                    <h4 class="fw-700 mb-4"><i class="fas fa-map-marker-alt me-2" style="color: #bf9530;"></i> Smart Address Verification</h4>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-600 mb-1">Full Name</label>
                            <input type="text" class="form-control form-control-lg" id="address-name" placeholder="Sheikh / Sheikhah">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-600 mb-1">Phone (WhatsApp)</label>
                            <input type="tel" class="form-control form-control-lg" id="address-phone" placeholder="+971 XX XXX XXXX">
                        </div>
                    </div>
                    
                    <div class="address-autocomplete mb-3">
                        <label class="fw-600 mb-1">Search Your Address</label>
                        <input type="text" class="form-control form-control-lg" id="address-search" placeholder="Start typing your location...">
                        <div class="suggestion-box" id="address-suggestions"></div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="fw-600 mb-1">Street / Building / Apartment</label>
                            <input type="text" class="form-control" id="address-street" placeholder="Burj Khalifa, Downtown">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="fw-600 mb-1">Postal Code</label>
                            <input type="text" class="form-control" id="address-postal" placeholder="00000">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="fw-600 mb-1">City / Emirate</label>
                            <select class="form-control" id="address-city">
                                <option value="">Select City</option>
                                <option value="Dubai">Dubai</option>
                                <option value="Abu Dhabi">Abu Dhabi</option>
                                <option value="Sharjah">Sharjah</option>
                                <option value="Ajman">Ajman</option>
                                <option value="Ras Al Khaimah">Ras Al Khaimah</option>
                                <option value="Fujairah">Fujairah</option>
                                <option value="Umm Al Quwain">Umm Al Quwain</option>
                                <option value="London">London (International)</option>
                                <option value="New York">New York (International)</option>
                                <option value="Mumbai">Mumbai</option>
                                <option value="Karachi">Karachi</option>
                                <option value="Lahore">Lahore</option>
                                <option value="Islamabad">Islamabad</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="fw-600 mb-1">Country</label>
                            <input type="text" class="form-control" id="address-country" value="United Arab Emirates" readonly>
                        </div>
                    </div>
                    
                    <!-- Free Map - Leaflet -->
                    <label class="fw-600 mb-2"><i class="fas fa-globe-asia me-2"></i> Pin Your Location (Drag Me)</label>
                    <div id="address-map" class="location-map"></div>
                    
                    <div class="mt-3 text-end">
                        <button class="btn btn-outline-secondary me-2" onclick="backToShop()">Back</button>
                        <button class="btn-dubai" onclick="verifyAddressAndCalculate()">Verify & Calculate Delivery</button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="dubai-card">
                    <h5 class="fw-700 mb-3"><i class="fas fa-truck me-2"></i> Live Delivery Intelligence</h5>
                    <div id="delivery-intelligence">
                        <p class="text-muted">Enter address to calculate real-time shipping</p>
                    </div>
                    <hr>
                    <div id="address-summary" class="mt-3 small">
                        <!-- Auto populated -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION 3: DELIVERY OPTIONS ==================== -->
    <div id="delivery-section" class="hidden-section">
        <div class="row">
            <div class="col-lg-8">
                <div class="dubai-card">
                    <h4 class="fw-700 mb-4"><i class="fas fa-shipping-fast me-2" style="color: #bf9530;"></i> Choose Delivery Speed</h4>
                    
                    <div id="delivery-options-container">
                        <!-- Dynamic from address base -->
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-secondary me-2" onclick="backToAddress()">Back</button>
                        <button class="btn-dubai" onclick="confirmDelivery()">Confirm & Choose Payment</button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="dubai-card">
                    <h5 class="fw-700 mb-3">Order Snapshot</h5>
                    <div id="delivery-order-summary"></div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span>Estimated Arrival:</span>
                        <span class="fw-700" id="eta-display">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION 4: PAYMENT GATEWAY ==================== -->
    <div id="payment-section" class="hidden-section">
        <div class="row">
            <div class="col-lg-7">
                <div class="dubai-card">
                    <h4 class="fw-700 mb-4"><i class="fas fa-wallet me-2" style="color: #bf9530;"></i> Smart Payment Hub</h4>
                    
                    <!-- Country based detection -->
                    <div class="alert alert-warning bg-light border-0" id="country-payment-note">
                        <i class="fas fa-globe me-2"></i> Detected: <span id="detected-country-name">UAE</span> â€” Showing relevant payment methods
                    </div>
                    
                    <!-- Wallets Section - Dynamic, No JazzCash fixed -->
                    <h6 class="fw-700 mt-3 mb-3"><i class="fas fa-mobile-alt me-2"></i> Digital Wallets</h6>
                    <div class="wallet-grid" id="wallets-container"></div>
                    
                    <!-- Cards & Banks -->
                    <h6 class="fw-700 mt-4 mb-3"><i class="fas fa-credit-card me-2"></i> Cards & Banks</h6>
                    <div class="wallet-grid" id="cards-container"></div>
                    
                    <!-- Cryptocurrency -->
                    <h6 class="fw-700 mt-4 mb-3"><i class="fab fa-bitcoin me-2"></i> Cryptocurrency</h6>
                    <div class="wallet-grid" id="crypto-container"></div>
                    
                    <!-- Selected Payment Details -->
                    <div id="payment-details-panel" class="mt-4 p-3 bg-light rounded-3" style="display: none;"></div>
                    
                    <div class="mt-4 d-flex justify-content-between">
                        <button class="btn btn-outline-secondary" onclick="backToDelivery()">Back</button>
                        <button class="btn-dubai" onclick="processSecurePayment()" id="pay-now-btn">
                            <i class="fas fa-lock me-2"></i>Pay Securely
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-5">
                <div class="dubai-card">
                    <h5 class="fw-700 mb-3">Payment Summary</h5>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Subtotal:</span>
                        <span id="payment-subtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Delivery:</span>
                        <span id="payment-delivery">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Tax (5% VAT):</span>
                        <span id="payment-tax">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-800 fs-5">
                        <span>Total:</span>
                        <span id="payment-total" class="total-gold">$0.00</span>
                    </div>
                    <div class="mt-3 small text-muted">
                        <i class="fas fa-shield-alt me-1"></i> 256-bit SSL Encrypted
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION 5: ORDER CONFIRMATION ==================== -->
    <div id="confirmation-section" class="hidden-section">
        <div class="dubai-card text-center p-5">
            <div class="mb-4">
                <i class="fas fa-check-circle fa-6x" style="color: #10b981;"></i>
            </div>
            <h2 class="fw-800 mb-2">âœ¨ Order Confirmed âœ¨</h2>
            <p class="lead mb-4">Your luxury order has been placed successfully</p>
            
            <div class="row justify-content-center">
                <div class="col-md-8">
                    <div class="bg-light p-4 rounded-4 text-start">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Order Number:</span>
                            <span class="fw-700" id="confirm-order-number">ORD-2025-0001</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Address:</span>
                            <span id="confirm-address">Dubai Marina</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Delivery Method:</span>
                            <span id="confirm-delivery">Express</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Payment Method:</span>
                            <span id="confirm-payment">Wallet</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>Estimated Delivery:</span>
                            <span id="confirm-eta">Tomorrow</span>
                        </div>
                        <div class="d-flex justify-content-between fw-700 fs-5 mt-3">
                            <span>Total Paid:</span>
                            <span id="confirm-total" style="color: #b38728;">$0.00</span>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex gap-3 justify-content-center">
                        <button class="btn btn-outline-primary" onclick="trackOrderNow()">
                            <i class="fas fa-shipping-fast me-2"></i>Track
                        </button>
                        <button class="btn-dubai" onclick="resetToShop()">
                            <i class="fas fa-store me-2"></i>Shop Again
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --------------------------------------------------------------
    // DUBAI COMMERCE SYSTEM - FULLY AUTOMATED | SMART PAYMENTS | MAPS
    // --------------------------------------------------------------
    
    // ---------- GLOBAL STATE ----------
    let currentStep = 1;
    let cart = [];
    let products = [];
    let userAddress = null;
    let selectedDelivery = null;
    let selectedPayment = null;
    let deliveryChargesConfig = null; // from index control
    let etaConfig = null;
    let map = null;
    let mapMarker = null;
    
    // ---------- INITIALIZATION ----------
    document.addEventListener('DOMContentLoaded', function() {
        // Load products (Dubai Collection)
        loadProductCatalog();
        // Load delivery config from localStorage or defaults
        loadDeliveryConfig();
        // Initialize empty cart
        updateCartUI();
        // Setup address autocomplete simulation
        setupAddressAutocomplete();
        // Load payment methods based on country
    });
    
    // ---------- PRODUCT CATALOG (Dubai Edition) ----------
    function loadProductCatalog() {
        products = [
            { id: 1, name: 'Dubai Gold Date Box', price: 349.99, image: 'https://images.unsplash.com/photo-1599493595981-1df4c7dc984d?w=400', category: 'Luxury', weight: 1.2 },
            { id: 2, name: 'Saffron Elite (10g)', price: 189.99, image: 'https://images.unsplash.com/photo-1596040033229-a9821ebd058d?w=400', category: 'Spices', weight: 0.1 },
            { id: 3, name: 'Arabian Oud Perfume', price: 599.99, image: 'https://images.unsplash.com/photo-1590736704728-f4730bb30770?w=400', category: 'Fragrance', weight: 0.3 },
            { id: 4, name: 'Camel Milk Chocolate', price: 79.99, image: 'https://images.unsplash.com/photo-1587132137056-bfbf0166836e?w=400', category: 'Gourmet', weight: 0.5 },
            { id: 5, name: 'Gold Plated Lamp', price: 1299.99, image: 'https://images.unsplash.com/photo-1543198126-a4ad8e3be0b6?w=400', category: 'Decor', weight: 2.5 },
            { id: 6, name: 'Pashmina Shawl', price: 449.99, image: 'https://images.unsplash.com/photo-1601924921557-45e6dea0a157?w=400', category: 'Fashion', weight: 0.4 },
        ];
        
        renderProductGrid();
    }
    
    function renderProductGrid() {
        const grid = document.getElementById('product-list');
        if (!grid) return;
        
        let html = '';
        products.forEach(p => {
            html += `
                <div class="product-item">
                    <img src="${p.image}" class="product-image" alt="${p.name}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="fw-700 mb-1">${p.name}</h6>
                            <span class="dubai-badge">${p.category}</span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="product-price">$${p.price.toFixed(2)}</span>
                        <button class="btn btn-sm btn-outline-warning" onclick="addToCart(${p.id})">
                            <i class="fas fa-plus me-1"></i>Add
                        </button>
                    </div>
                </div>
            `;
        });
        grid.innerHTML = html;
    }
    
    // ---------- CART MANAGEMENT ----------
    function addToCart(productId) {
        const product = products.find(p => p.id === productId);
        if (!product) return;
        
        const existing = cart.find(item => item.id === productId);
        if (existing) {
            existing.quantity += 1;
        } else {
            cart.push({
                id: product.id,
                name: product.name,
                price: product.price,
                weight: product.weight,
                quantity: 1,
                image: product.image
            });
        }
        updateCartUI();
        showToast('Added to cart', 'success');
    }
    
    function removeFromCart(productId) {
        cart = cart.filter(item => item.id !== productId);
        updateCartUI();
    }
    
    function updateQuantity(productId, change) {
        const item = cart.find(i => i.id === productId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(productId);
            } else {
                updateCartUI();
            }
        }
    }
    
    function updateCartUI() {
        const container = document.getElementById('cart-mini-container');
        const subtotalEl = document.getElementById('cart-subtotal');
        const checkoutBtn = document.getElementById('checkout-btn');
        
        if (!container) return;
        
        if (cart.length === 0) {
            container.innerHTML = '<p class="text-muted text-center py-3">Your cart is empty</p>';
            subtotalEl.innerText = '$0.00';
            if (checkoutBtn) checkoutBtn.disabled = true;
            return;
        }
        
        let html = '';
        let subtotal = 0;
        
        cart.forEach(item => {
            subtotal += item.price * item.quantity;
            html += `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                    <div class="flex-grow-1">
                        <h6 class="fw-600 mb-0">${item.name}</h6>
                        <small>$${item.price.toFixed(2)} x ${item.quantity}</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="fw-700 me-3">$${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="btn btn-sm btn-link text-danger p-0 me-2" onclick="updateQuantity(${item.id}, -1)">
                            <i class="fas fa-minus"></i>
                        </button>
                        <button class="btn btn-sm btn-link p-0" onclick="updateQuantity(${item.id}, 1)">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        
        container.innerHTML = html;
        subtotalEl.innerText = `$${subtotal.toFixed(2)}`;
        if (checkoutBtn) checkoutBtn.disabled = false;
    }
    
    // ---------- STEP NAVIGATION ----------
    function proceedToAddress() {
        if (cart.length === 0) {
            alert('Your cart is empty');
            return;
        }
        switchStep(2);
    }
    
    function backToShop() {
        switchStep(1);
    }
    
    function backToAddress() {
        switchStep(2);
    }
    
    function backToDelivery() {
        switchStep(3);
    }
    
    function switchStep(step) {
        // Hide all sections
        document.querySelectorAll('#shop-section, #address-section, #delivery-section, #payment-section, #confirmation-section')
            .forEach(el => el.classList.add('hidden-section'));
        
        // Show selected
        if (step === 1) document.getElementById('shop-section').classList.remove('hidden-section');
        if (step === 2) document.getElementById('address-section').classList.remove('hidden-section');
        if (step === 3) document.getElementById('delivery-section').classList.remove('hidden-section');
        if (step === 4) document.getElementById('payment-section').classList.remove('hidden-section');
        if (step === 5) document.getElementById('confirmation-section').classList.remove('hidden-section');
        
        // Update progress steps
        document.querySelectorAll('.progress-step').forEach((el, idx) => {
            el.classList.remove('active', 'completed');
            if (idx + 1 < step) el.classList.add('completed');
            if (idx + 1 === step) el.classList.add('active');
        });
        
        currentStep = step;
        
        // Initialize specific sections
        if (step === 2) initAddressMap();
        if (step === 3) renderDeliveryOptions();
        if (step === 4) renderPaymentMethods();
    }
    
    // ---------- ADDRESS & MAP (LEAFLET) ----------
    function initAddressMap() {
        if (map) return;
        
        // Default Dubai coordinates
        const dubaiLatLng = [25.2048, 55.2708];
        
        map = L.map('address-map').setView(dubaiLatLng, 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap'
        }).addTo(map);
        
        mapMarker = L.marker(dubaiLatLng, { draggable: true }).addTo(map);
        
        mapMarker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            reverseGeocode(pos.lat, pos.lng);
        });
    }
    
    function reverseGeocode(lat, lng) {
        // Simulate reverse geocoding
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`)
            .then(res => res.json())
            .then(data => {
                if (data.display_name) {
                    document.getElementById('address-search').value = data.display_name.split(',')[0];
                    document.getElementById('address-street').value = data.road || '';
                    document.getElementById('address-city').value = data.city || data.town || 'Dubai';
                }
            })
            .catch(() => {
                // Fallback
                document.getElementById('address-city').value = 'Dubai';
            });
    }
    
    function setupAddressAutocomplete() {
        const searchInput = document.getElementById('address-search');
        const suggestionsBox = document.getElementById('address-suggestions');
        
        searchInput.addEventListener('input', function(e) {
            const query = e.target.value;
            if (query.length < 3) {
                suggestionsBox.style.display = 'none';
                return;
            }
            
            // Simulated autocomplete
            const mockResults = [
                'Burj Khalifa, Downtown Dubai',
                'Dubai Marina, Dubai',
                'Palm Jumeirah, Dubai',
                'Jumeirah Beach Residence, Dubai',
                'Deira, Dubai',
                'Al Barsha, Dubai'
            ].filter(item => item.toLowerCase().includes(query.toLowerCase()));
            
            if (mockResults.length > 0) {
                let html = '';
                mockResults.forEach(r => {
                    html += `<div class="suggestion-item" onclick="selectAddressSuggestion('${r}')">${r}</div>`;
                });
                suggestionsBox.innerHTML = html;
                suggestionsBox.style.display = 'block';
            } else {
                suggestionsBox.style.display = 'none';
            }
        });
    }
    
    function selectAddressSuggestion(address) {
        document.getElementById('address-search').value = address;
        document.getElementById('address-suggestions').style.display = 'none';
        document.getElementById('address-street').value = address;
    }
    
    // ---------- DELIVERY CONFIG (FROM INDEX CONTROL) ----------
    function loadDeliveryConfig() {
        // This would come from localStorage or a config file, controlled by index.html
        const defaultConfig = {
            baseRates: {
                'Dubai': { standard: 15, express: 25, sameDay: 40 },
                'Abu Dhabi': { standard: 25, express: 40, sameDay: 65 },
                'Sharjah': { standard: 20, express: 35, sameDay: 55 },
                'International': { standard: 55, express: 85, sameDay: null },
                'Karachi': { standard: 45, express: 70, sameDay: null },
                'Lahore': { standard: 45, express: 70, sameDay: null },
                'Mumbai': { standard: 50, express: 80, sameDay: null },
                'London': { standard: 120, express: 190, sameDay: null },
                'New York': { standard: 140, express: 220, sameDay: null }
            },
            eta: {
                'Dubai': { standard: '2-3 days', express: '1 day', sameDay: 'Today' },
                'Abu Dhabi': { standard: '3-4 days', express: '2 days', sameDay: 'Tomorrow' },
                'Sharjah': { standard: '2-3 days', express: '1 day', sameDay: 'Today' },
                'International': { standard: '5-7 days', express: '3-4 days', sameDay: null },
                'Karachi': { standard: '4-6 days', express: '2-3 days', sameDay: null }
            }
        };
        
        deliveryChargesConfig = JSON.parse(localStorage.getItem('dubai_delivery_config')) || defaultConfig;
        etaConfig = deliveryChargesConfig.eta;
    }
    
    function verifyAddressAndCalculate() {
        const name = document.getElementById('address-name').value.trim();
        const phone = document.getElementById('address-phone').value.trim();
        const street = document.getElementById('address-street').value.trim();
        const city = document.getElementById('address-city').value;
        const country = document.getElementById('address-country').value;
        
        if (!name || !phone || !street || !city) {
            alert('Please complete all address fields');
            return;
        }
        
        // Store address
        userAddress = {
            name, phone, street, city, country,
            coordinates: mapMarker ? mapMarker.getLatLng() : { lat: 25.2048, lng: 55.2708 }
        };
        
        // Update header
        document.getElementById('header-location').innerText = city;
        
        // Calculate delivery
        const deliveryRates = deliveryChargesConfig.baseRates[city] || deliveryChargesConfig.baseRates['International'];
        
        let html = '<h6 class="fw-700">Available Delivery:</h6>';
        if (deliveryRates.standard) html += `<p>ðŸšš Standard: $${deliveryRates.standard} (${etaConfig[city]?.standard || '3-5 days'})</p>`;
        if (deliveryRates.express) html += `<p>âš¡ Express: $${deliveryRates.express} (${etaConfig[city]?.express || '2-3 days'})</p>`;
        if (deliveryRates.sameDay) html += `<p>ðŸ•’ Same Day: $${deliveryRates.sameDay} (${etaConfig[city]?.sameDay || 'Today'})</p>`;
        
        document.getElementById('delivery-intelligence').innerHTML = html;
        document.getElementById('address-summary').innerHTML = `<span class="text-success"><i class="fas fa-check-circle me-1"></i> Address verified: ${street}, ${city}</span>`;
        
        // Automatically go to delivery section after 1 sec
        setTimeout(() => {
            switchStep(3);
        }, 1200);
    }
    
    // ---------- DELIVERY OPTIONS (DYNAMIC) ----------
    function renderDeliveryOptions() {
        if (!userAddress) {
            alert('Please set address first');
            switchStep(2);
            return;
        }
        
        const city = userAddress.city;
        const rates = deliveryChargesConfig.baseRates[city] || deliveryChargesConfig.baseRates['International'];
        const eta = etaConfig[city] || etaConfig['International'];
        
        let container = document.getElementById('delivery-options-container');
        let html = '';
        
        if (rates.standard) {
            html += `
                <div class="delivery-card" onclick="selectDelivery('standard', ${rates.standard}, '${eta.standard || '3-5 days'}')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="fw-700">ðŸšš Standard Delivery</h6>
                            <p class="mb-0 text-muted">${eta.standard || '3-5 business days'}</p>
                        </div>
                        <div class="text-end">
                            <span class="fw-800 fs-5">$${rates.standard}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        if (rates.express) {
            html += `
                <div class="delivery-card" onclick="selectDelivery('express', ${rates.express}, '${eta.express || '2-3 days'}')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="fw-700">âš¡ Express Delivery</h6>
                            <p class="mb-0 text-muted">${eta.express || '2-3 days'}</p>
                        </div>
                        <div class="text-end">
                            <span class="fw-800 fs-5">$${rates.express}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        if (rates.sameDay) {
            html += `
                <div class="delivery-card" onclick="selectDelivery('sameDay', ${rates.sameDay}, '${eta.sameDay || 'Today'}')">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="fw-700">ðŸ•’ Same Day Delivery</h6>
                            <p class="mb-0 text-muted">${eta.sameDay || 'Within 24h'}</p>
                        </div>
                        <div class="text-end">
                            <span class="fw-800 fs-5">$${rates.sameDay}</span>
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        // Update order summary
        updateDeliveryOrderSummary();
    }
    
    function selectDelivery(type, cost, eta) {
        // Remove selected class
        document.querySelectorAll('.delivery-card').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        selectedDelivery = { type, cost, eta };
        document.getElementById('eta-display').innerText = eta;
        
        // Update payment summary later
    }
    
    function confirmDelivery() {
        if (!selectedDelivery) {
            alert('Please select a delivery method');
            return;
        }
        switchStep(4);
        updatePaymentSummary();
    }
    
    function updateDeliveryOrderSummary() {
        let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        let html = '';
        cart.forEach(item => {
            html += `<div class="d-flex justify-content-between small mb-1"><span>${item.name} x${item.quantity}</span><span>$${(item.price * item.quantity).toFixed(2)}</span></div>`;
        });
        html += `<hr><div class="d-flex justify-content-between fw-700"><span>Subtotal</span><span>$${subtotal.toFixed(2)}</span></div>`;
        document.getElementById('delivery-order-summary').innerHTML = html;
    }
    
    // ---------- PAYMENT METHODS (ADAPTIVE) ----------
    function renderPaymentMethods() {
        const country = userAddress?.city || 'Dubai';
        let detectedCountry = 'UAE';
        if (['Karachi', 'Lahore', 'Islamabad'].includes(country)) detectedCountry = 'Pakistan';
        if (['Mumbai'].includes(country)) detectedCountry = 'India';
        if (['London'].includes(country)) detectedCountry = 'UK';
        if (['New York'].includes(country)) detectedCountry = 'USA';
        
        document.getElementById('detected-country-name').innerText = detectedCountry;
        
        // Wallets Container - No JazzCash/Easypaisa sticking, dynamic per country
        let walletsHtml = '';
        let cardsHtml = '';
        let cryptoHtml = '';
        
        if (detectedCountry === 'UAE') {
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Apple Pay')"><div class="wallet-icon"><i class="fab fa-apple-pay"></i></div><span>Apple Pay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Google Pay')"><div class="wallet-icon"><i class="fab fa-google-pay"></i></div><span>Google Pay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Samsung Pay')"><div class="wallet-icon"><i class="fas fa-mobile-alt"></i></div><span>Samsung Pay</span></div>`;
        } else if (detectedCountry === 'Pakistan') {
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'NayaPay')"><div class="wallet-icon"><i class="fas fa-wallet"></i></div><span>NayaPay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'SadaPay')"><div class="wallet-icon"><i class="fas fa-credit-card"></i></div><span>SadaPay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Keenu Wallet')"><div class="wallet-icon"><i class="fas fa-mobile"></i></div><span>Keenu</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Finja')"><div class="wallet-icon"><i class="fas fa-building"></i></div><span>Finja</span></div>`;
        } else if (detectedCountry === 'India') {
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Paytm')"><div class="wallet-icon"><i class="fas fa-rupee-sign"></i></div><span>Paytm</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'PhonePe')"><div class="wallet-icon"><i class="fas fa-phone"></i></div><span>PhonePe</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Google Pay')"><div class="wallet-icon"><i class="fab fa-google-pay"></i></div><span>Google Pay</span></div>`;
        } else {
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Apple Pay')"><div class="wallet-icon"><i class="fab fa-apple-pay"></i></div><span>Apple Pay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'Google Pay')"><div class="wallet-icon"><i class="fab fa-google-pay"></i></div><span>Google Pay</span></div>`;
            walletsHtml += `<div class="wallet-option" onclick="selectPayment('wallet', 'PayPal')"><div class="wallet-icon"><i class="fab fa-paypal"></i></div><span>PayPal</span></div>`;
        }
        
        // Cards & Banks - Universal
        cardsHtml = `
            <div class="wallet-option" onclick="selectPayment('card', 'Visa/Mastercard')"><div class="wallet-icon"><i class="fas fa-credit-card"></i></div><span>Credit/Debit</span></div>
            <div class="wallet-option" onclick="selectPayment('bank', 'Bank Transfer')"><div class="wallet-icon"><i class="fas fa-university"></i></div><span>Bank Transfer</span></div>
        `;
        
        // Crypto - Universal
        cryptoHtml = `
            <div class="wallet-option" onclick="selectPayment('crypto', 'Bitcoin')"><div class="wallet-icon"><i class="fab fa-bitcoin"></i></div><span>Bitcoin</span></div>
            <div class="wallet-option" onclick="selectPayment('crypto', 'Ethereum')"><div class="wallet-icon"><i class="fab fa-ethereum"></i></div><span>Ethereum</span></div>
            <div class="wallet-option" onclick="selectPayment('crypto', 'USDT')"><div class="wallet-icon"><i class="fas fa-dollar-sign"></i></div><span>USDT (TRC20)</span></div>
            <div class="wallet-option" onclick="selectPayment('crypto', 'BNB')"><div class="wallet-icon"><i class="fas fa-coins"></i></div><span>BNB</span></div>
        `;
        
        document.getElementById('wallets-container').innerHTML = walletsHtml;
        document.getElementById('cards-container').innerHTML = cardsHtml;
        document.getElementById('crypto-container').innerHTML = cryptoHtml;
    }
    
    function selectPayment(category, method) {
        // Remove selected class from all wallet options
        document.querySelectorAll('.wallet-option').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
        
        selectedPayment = { category, method };
        
        // Show details panel
        const panel = document.getElementById('payment-details-panel');
        if (category === 'crypto') {
            panel.style.display = 'block';
            panel.innerHTML = `
                <h6 class="fw-700">${method} Address</h6>
                <div class="crypto-address">0x${Math.random().toString(36).substring(2, 10)}...${Math.random().toString(36).substring(2, 8)}</div>
                <small class="text-muted">Network: ${method === 'Bitcoin' ? 'BTC' : method === 'Ethereum' ? 'ERC20' : method === 'USDT' ? 'TRC20' : 'BSC'}</small>
            `;
        } else if (category === 'bank') {
            panel.style.display = 'block';
            panel.innerHTML = `
                <h6 class="fw-700">Bank Transfer Details</h6>
                <p class="mb-1">Bank: Emirates NBD / Standard Chartered</p>
                <p class="mb-1">Account: AE12 3456 7890 1234 5678</p>
                <p class="mb-0">IBAN: AE460090000000123456789</p>
            `;
        } else {
            panel.style.display = 'none';
        }
    }
    
    function updatePaymentSummary() {
        const subtotal = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
        const delivery = selectedDelivery ? selectedDelivery.cost : 0;
        const tax = subtotal * 0.05; // 5% VAT
        const total = subtotal + delivery + tax;
        
        document.getElementById('payment-subtotal').innerText = `$${subtotal.toFixed(2)}`;
        document.getElementById('payment-delivery').innerText = `$${delivery.toFixed(2)}`;
        document.getElementById('payment-tax').innerText = `$${tax.toFixed(2)}`;
        document.getElementById('payment-total').innerHTML = `$${total.toFixed(2)}`;
    }
    
    function processSecurePayment() {
        if (!selectedPayment) {
            alert('Please select a payment method');
            return;
        }
        
        const btn = document.getElementById('pay-now-btn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i> Processing...';
        btn.disabled = true;
        
        // Simulate gateway
        setTimeout(() => {
            // Generate order
            const orderNumber = 'ORD-' + Date.now().toString().slice(-6);
            document.getElementById('confirm-order-number').innerText = orderNumber;
            document.getElementById('confirm-address').innerText = `${userAddress?.street}, ${userAddress?.city}`;
            document.getElementById('confirm-delivery').innerText = selectedDelivery?.type.toUpperCase() || 'Express';
            document.getElementById('confirm-payment').innerText = selectedPayment?.method || 'Wallet';
            document.getElementById('confirm-eta').innerText = selectedDelivery?.eta || 'Tomorrow';
            
            const total = cart.reduce((s,i) => s + (i.price * i.quantity), 0) + (selectedDelivery?.cost || 0) + (cart.reduce((s,i) => s + (i.price * i.quantity), 0) * 0.05);
            document.getElementById('confirm-total').innerHTML = `$${total.toFixed(2)}`;
            
            // Clear cart
            cart = [];
            updateCartUI();
            
            btn.innerHTML = '<i class="fas fa-lock me-2"></i>Pay Securely';
            btn.disabled = false;
            
            switchStep(5);
        }, 2000);
    }
    
    // ---------- UTILITIES ----------
    function showToast(msg, type) {
        // Simple alert for now
        console.log(msg);
    }
    
    function trackOrderNow() {
        alert('ðŸ“¦ Your order is being prepared. Tracking link sent via SMS/Email.');
    }
    
    function resetToShop() {
        cart = [];
        userAddress = null;
        selectedDelivery = null;
        selectedPayment = null;
        updateCartUI();
        switchStep(1);
    }
    
    // Load delivery config from localStorage (simulate index control)
    window.controlDeliveryConfig = function(config) {
        localStorage.setItem('dubai_delivery_config', JSON.stringify(config));
        loadDeliveryConfig();
    };
</script>

<!-- Optional Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
