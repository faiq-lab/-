<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Business Card</title>
    
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            min-height: 100vh;
        }
        
        .card-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .digital-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 25px;
            margin-bottom: 20px;
        }
        
        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            margin-bottom: 15px;
        }
        
        .business-name {
            font-size: 24px;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .contact-item {
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            text-decoration: none;
            color: #1e293b;
            display: block;
            transition: 0.3s;
        }
        
        .contact-item:hover {
            background: #667eea;
            color: white;
        }
        
        .whatsapp-btn {
            background: #25D366;
            color: white;
            padding: 16px;
            border-radius: 50px;
            text-decoration: none;
            display: block;
            text-align: center;
            font-weight: 700;
            margin: 20px 0;
        }
        
        .product-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-box {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .live-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #10b981;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
        }
        
        .pulse {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="card-container">
        <div id="cardContent">
            <!-- Loading State -->
            <div class="digital-card loading">
                <div class="spinner"></div>
                <h5>Loading Your Digital Card...</h5>
                <p class="text-muted">Please wait while we fetch your data</p>
                <small class="text-muted" id="debugInfo"></small>
            </div>
        </div>
    </div>
    
    <div class="live-badge" id="liveBadge">
        <span class="pulse"></span>
        LIVE • Real Data
    </div>

    <script>
        // ========== SUPABASE CONNECTION ==========
        const supabase = supabase.createClient(
            "https://dfvnefbxgayxqgjjgtrr.supabase.co",
            "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
        );

        // ========== GET CARD ID FROM URL ==========
        function getCardId() {
            const urlParams = new URLSearchParams(window.location.search);
            const id = urlParams.get('id');
            console.log("Card ID from URL:", id);
            document.getElementById('debugInfo').innerHTML = `Card ID: ${id || 'Not found'}`;
            return id;
        }

        // ========== LOAD CARD DATA ==========
        async function loadCard() {
            const cardId = getCardId();
            
            if (!cardId) {
                showError('No Card ID provided. Please check the URL.');
                return;
            }

            try {
                // Try to get from Supabase directly
                console.log("Fetching card with ID:", cardId);
                
                // First check if it's a short ID
                let actualId = cardId;
                
                const { data: shortData, error: shortError } = await supabase
                    .from('short_urls')
                    .select('full_id')
                    .eq('short_id', cardId)
                    .maybeSingle();
                
                console.log("Short URL lookup:", shortData, shortError);
                
                if (shortData) {
                    actualId = shortData.full_id;
                    console.log("Found full ID:", actualId);
                }
                
                // Get card data
                const { data: card, error } = await supabase
                    .from('cards')
                    .select('*')
                    .eq('id', actualId)
                    .maybeSingle();
                
                console.log("Card data:", card, error);
                
                if (error) {
                    throw error;
                }
                
                if (card) {
                    // Parse the JSON data
                    let cardData;
                    try {
                        cardData = typeof card.data === 'string' ? JSON.parse(card.data) : card.data;
                    } catch (e) {
                        console.error("Parse error:", e);
                        cardData = card.data;
                    }
                    
                    console.log("Parsed card data:", cardData);
                    
                    // Render the card
                    renderCard(cardData, actualId);
                    
                    // Update view count
                    await supabase
                        .from('cards')
                        .update({ views: (card.views || 0) + 1 })
                        .eq('id', actualId);
                    
                    // Show live badge
                    document.getElementById('liveBadge').style.display = 'flex';
                    
                } else {
                    showError('Card not found. Please check the ID.');
                }
                
            } catch (error) {
                console.error('Error loading card:', error);
                showError('Failed to load card: ' + error.message);
            }
        }

        // ========== RENDER CARD ==========
        function renderCard(data, cardId) {
            const container = document.getElementById('cardContent');
            
            // Format phone for WhatsApp
            const whatsappNumber = data.payments?.whatsapp?.number || data.phone || '';
            const cleanNumber = whatsappNumber.replace(/[^0-9]/g, '');
            
            // Build products HTML
            let productsHTML = '';
            if (data.products && data.products.length > 0) {
                productsHTML = '<h5 class="fw-700 mt-4 mb-3">Products</h5>';
                data.products.forEach(p => {
                    productsHTML += `
                        <div class="product-card">
                            <h6 class="fw-700">${p.title || 'Product'}</h6>
                            <p class="small text-muted">${p.desc || ''}</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    ${p.originalPrice ? `<small class="text-muted text-decoration-line-through">PKR ${p.originalPrice}</small>` : ''}
                                    <span class="fw-800 text-primary">PKR ${p.discountPrice || '0'}</span>
                                </div>
                                <button class="btn btn-sm btn-primary" onclick="addToCart('${p.title}', ${p.discountPrice || 0})">
                                    <i class="fas fa-cart-plus"></i>
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Build delivery HTML
            let deliveryHTML = '';
            if (data.deliverySettings) {
                deliveryHTML = `
                    <h5 class="fw-700 mt-4 mb-3">Delivery</h5>
                    <div class="bg-light p-3 rounded-3">
                        <div class="d-flex justify-content-between">
                            <span>Within City:</span>
                            <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeCity || '150'}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <span>Other Cities:</span>
                            <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeOther || '300'}</span>
                        </div>
                    </div>
                `;
            }
            
            // Build social links
            let socialHTML = '';
            if (data.socialMedia) {
                const activeSocials = Object.entries(data.socialMedia)
                    .filter(([key, value]) => value && value.trim())
                    .map(([key, value]) => `
                        <a href="${value}" target="_blank" class="btn btn-outline-secondary btn-sm me-2 mb-2">
                            <i class="fab fa-${key}"></i>
                        </a>
                    `).join('');
                
                if (activeSocials) {
                    socialHTML = `<div class="mt-4">${activeSocials}</div>`;
                }
            }
            
            // Build complete card HTML
            const cardHTML = `
                <div class="digital-card">
                    <!-- Profile -->
                    <div class="text-center">
                        ${data.profileImage ? 
                            `<img src="${data.profileImage}" class="profile-image">` : 
                            `<div class="profile-image mx-auto bg-primary d-flex align-items-center justify-content-center">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>`
                        }
                        <h2 class="business-name">${data.businessName || 'Business Name'}</h2>
                        <p class="text-muted">${data.name || 'Owner Name'}</p>
                        ${data.address ? `<p class="small"><i class="fas fa-map-marker-alt me-2"></i>${data.address}</p>` : ''}
                    </div>
                    
                    <!-- Contact -->
                    <div class="row g-2 mt-4">
                        <div class="col-6">
                            <a href="tel:${data.phone || ''}" class="contact-item">
                                <i class="fas fa-phone-alt mb-2"></i>
                                <div>Call</div>
                                <small>${data.phone || 'Not set'}</small>
                            </a>
                        </div>
                        <div class="col-6">
                            <a href="mailto:${data.email || ''}" class="contact-item">
                                <i class="fas fa-envelope mb-2"></i>
                                <div>Email</div>
                                <small>${data.email || 'Not set'}</small>
                            </a>
                        </div>
                    </div>
                    
                    <!-- About -->
                    ${data.business?.about ? `
                        <div class="mt-4">
                            <h5 class="fw-700">About</h5>
                            <p class="text-muted">${data.business.about}</p>
                        </div>
                    ` : ''}
                    
                    <!-- WhatsApp -->
                    ${cleanNumber ? `
                        <a href="https://wa.me/${cleanNumber}?text=Hello%20${data.businessName || ''}%21%20I%27m%20interested%20in%20your%20products." 
                           target="_blank" 
                           class="whatsapp-btn">
                            <i class="fab fa-whatsapp me-2"></i>
                            Order via WhatsApp
                        </a>
                    ` : ''}
                    
                    <!-- Products -->
                    ${productsHTML}
                    
                    <!-- Delivery -->
                    ${deliveryHTML}
                    
                    <!-- Social -->
                    ${socialHTML}
                    
                    <!-- Website -->
                    ${data.website ? `
                        <div class="text-center mt-4">
                            <a href="${data.website}" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-globe me-2"></i>Visit Website
                            </a>
                        </div>
                    ` : ''}
                    
                    <!-- Card ID -->
                    <div class="text-center mt-4 pt-3 border-top">
                        <small class="text-muted">
                            <i class="fas fa-id-card me-1"></i>
                            ID: ${cardId}
                        </small>
                    </div>
                </div>
            `;
            
            container.innerHTML = cardHTML;
            document.title = `${data.businessName || 'Digital Card'} - Business Card`;
        }

        // ========== ADD TO CART ==========
        window.addToCart = function(name, price) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.push({
                name: name,
                price: price,
                quantity: 1,
                date: new Date().toISOString()
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            alert('✅ Added to cart!');
        };

        // ========== SHOW ERROR ==========
        function showError(message) {
            const container = document.getElementById('cardContent');
            container.innerHTML = `
                <div class="digital-card error-box">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h4 class="fw-700 mb-3">Error</h4>
                    <p>${message}</p>
                    <button class="btn btn-primary mt-3" onclick="location.reload()">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary mt-3 ms-2">
                        <i class="fas fa-home me-2"></i>Home
                    </a>
                </div>
            `;
        }

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', loadCard);
    </script>
</body>
</html>
