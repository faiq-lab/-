<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Digital Business App</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<!-- Dynamic Manifest will be injected by JavaScript -->
<meta name="theme-color" content="#0f172a" id="themeColorMeta">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="Premium Digital Business App">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap">

<!-- Add manifest link -->
<link rel="manifest" href="manifest.json">

<!-- Load Google Maps API -->
<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places&callback=initAutocomplete" async defer></script>

<!-- All CSS styles remain exactly the same -->
<style>
/* ALL CSS FROM ORIGINAL FILE REMAINS EXACTLY THE SAME */
/* [Previous CSS content remains unchanged - too long to include here] */

/* ===== NEW CHECKOUT SYSTEM STYLES ===== */
.address-verification-container {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 15px;
  box-shadow: var(--shadow-md);
  border: 1px solid #f1f5f9;
}

.address-input-group {
  margin-bottom: 15px;
}

.address-label {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  font-weight: 700;
  color: var(--dark-color);
  margin-bottom: 8px;
}

.address-label i {
  color: #667eea;
}

.address-field {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 14px;
  transition: var(--transition-fast);
  background: white;
}

.address-field:focus {
  border-color: #667eea;
  outline: none;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.address-field.valid {
  border-color: #10b981;
  background: rgba(16, 185, 129, 0.05);
}

.address-field.invalid {
  border-color: #ef4444;
  background: rgba(239, 68, 68, 0.05);
}

.address-suggestions {
  position: absolute;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border: 1px solid #e2e8f0;
  border-radius: 12px;
  margin-top: 4px;
  box-shadow: var(--shadow-md);
  z-index: 1000;
}

.address-suggestion-item {
  padding: 12px 16px;
  cursor: pointer;
  transition: var(--transition-fast);
  border-bottom: 1px solid #f1f5f9;
}

.address-suggestion-item:hover {
  background: #f8fafc;
}

.address-suggestion-item:last-child {
  border-bottom: none;
}

.address-verification-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: #10b981;
  color: white;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 700;
  margin-left: 8px;
}

.postal-code-verification {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-top: 10px;
}

.postal-code-input {
  flex: 1;
  padding: 12px;
  border: 2px solid #e2e8f0;
  border-radius: 10px;
  font-size: 14px;
}

.postal-code-btn {
  padding: 12px 20px;
  background: var(--info-gradient);
  color: white;
  border: none;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
}

.postal-code-status {
  margin-top: 8px;
  font-size: 12px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.delivery-calculator-card {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 15px;
  box-shadow: var(--shadow-md);
  border: 1px solid #f1f5f9;
  border-left: 5px solid #8b5cf6;
}

.delivery-option {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 15px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: var(--transition-fast);
  background: white;
}

.delivery-option:hover {
  border-color: #8b5cf6;
  background: rgba(139, 92, 246, 0.05);
}

.delivery-option.selected {
  border-color: #8b5cf6;
  background: rgba(139, 92, 246, 0.1);
}

.delivery-option-info {
  display: flex;
  align-items: center;
  gap: 15px;
}

.delivery-option-icon {
  width: 50px;
  height: 50px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  color: white;
}

.delivery-option-icon.standard {
  background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
}

.delivery-option-icon.express {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.delivery-option-icon.international {
  background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.delivery-option-details {
  flex: 1;
}

.delivery-option-name {
  font-size: 16px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.delivery-option-time {
  font-size: 13px;
  color: #64748b;
  display: flex;
  align-items: center;
  gap: 6px;
}

.delivery-option-price {
  font-size: 18px;
  font-weight: 900;
  color: #10b981;
}

.delivery-distance-info {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #f8fafc;
  border-radius: 10px;
  margin: 15px 0;
  font-size: 14px;
  color: #475569;
}

.payment-gateway-container {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 15px;
  box-shadow: var(--shadow-md);
  border: 1px solid #f1f5f9;
}

.payment-gateway-tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #f1f5f9;
  padding-bottom: 15px;
}

.payment-gateway-tab {
  flex: 1;
  padding: 12px;
  text-align: center;
  border-radius: 10px;
  cursor: pointer;
  transition: var(--transition-fast);
  font-weight: 700;
  font-size: 14px;
  border: 2px solid transparent;
}

.payment-gateway-tab:hover {
  background: #f8fafc;
}

.payment-gateway-tab.active {
  border-color: #667eea;
  background: rgba(102, 126, 234, 0.1);
}

.payment-gateway-tab i {
  margin-right: 6px;
}

.payment-gateway-content {
  padding: 20px;
  background: white;
  border-radius: 16px;
  border: 1px solid #e2e8f0;
}

.stripe-element {
  padding: 15px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  margin-bottom: 15px;
  transition: var(--transition-fast);
}

.stripe-element:focus-within {
  border-color: #667eea;
  box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.razorpay-button, .sslcommerz-button {
  width: 100%;
  padding: 16px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: 800;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: var(--transition-fast);
}

.razorpay-button {
  background: linear-gradient(135deg, #1e88e5 0%, #1565c0 100%);
}

.sslcommerz-button {
  background: linear-gradient(135deg, #e31b23 0%, #c2181f 100%);
}

.country-detection-badge {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 18px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 30px;
  font-size: 13px;
  font-weight: 700;
  margin-bottom: 20px;
}

.cod-badge {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
  padding: 6px 14px;
  border-radius: 30px;
  font-size: 12px;
  font-weight: 800;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

.order-tracking-card {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 15px;
  box-shadow: var(--shadow-md);
  border: 1px solid #f1f5f9;
  border-left: 5px solid #3b82f6;
}

.order-timeline {
  position: relative;
  padding: 20px 0;
  margin: 20px 0;
}

.order-timeline::before {
  content: '';
  position: absolute;
  left: 19px;
  top: 0;
  height: 100%;
  width: 2px;
  background: #e2e8f0;
}

.timeline-item {
  position: relative;
  padding-left: 50px;
  padding-bottom: 25px;
}

.timeline-item:last-child {
  padding-bottom: 0;
}

.timeline-icon {
  position: absolute;
  left: 0;
  top: 0;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: white;
  border: 2px solid #e2e8f0;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #64748b;
  font-size: 16px;
  z-index: 1;
}

.timeline-item.completed .timeline-icon {
  background: #10b981;
  border-color: #10b981;
  color: white;
}

.timeline-item.active .timeline-icon {
  background: #3b82f6;
  border-color: #3b82f6;
  color: white;
  animation: pulse 2s infinite;
}

.timeline-content {
  background: #f8fafc;
  padding: 15px;
  border-radius: 12px;
  border: 1px solid #e2e8f0;
}

.timeline-title {
  font-size: 15px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.timeline-time {
  font-size: 12px;
  color: #64748b;
  display: flex;
  align-items: center;
  gap: 6px;
}

.tracking-number-box {
  background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
  color: white;
  padding: 16px;
  border-radius: 12px;
  text-align: center;
  margin: 15px 0;
}

.tracking-number {
  font-size: 24px;
  font-weight: 900;
  letter-spacing: 2px;
  font-family: monospace;
  margin-top: 8px;
  padding: 12px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  border: 1px dashed rgba(255, 255, 255, 0.3);
}

.delivery-partner-section {
  background: var(--lighter-color);
  border-radius: var(--border-radius-lg);
  padding: 20px;
  margin: 15px;
  box-shadow: var(--shadow-md);
  border: 1px solid #f1f5f9;
}

.partner-select {
  width: 100%;
  padding: 14px;
  border: 2px solid #e2e8f0;
  border-radius: 12px;
  font-size: 14px;
  margin: 10px 0;
  background: white;
}

.partner-card {
  display: flex;
  align-items: center;
  gap: 15px;
  padding: 15px;
  background: #f8fafc;
  border-radius: 12px;
  margin-bottom: 10px;
  border: 1px solid #e2e8f0;
}

.partner-logo {
  width: 50px;
  height: 50px;
  border-radius: 10px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 24px;
  font-weight: 900;
}

.partner-info {
  flex: 1;
}

.partner-name {
  font-size: 15px;
  font-weight: 800;
  color: var(--dark-color);
  margin-bottom: 4px;
}

.partner-rating {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: #f59e0b;
}

.partner-tracking-btn {
  padding: 10px 18px;
  background: var(--primary-gradient);
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 700;
  cursor: pointer;
}

@media (max-width: 480px) {
  .delivery-option {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }
  
  .delivery-option-price {
    align-self: flex-end;
  }
  
  .payment-gateway-tabs {
    flex-direction: column;
  }
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}
</style>
</head>

<body>
<div class="app-container">
  <!-- Fixed Header -->
  <div class="header-container">
    <!-- Back Button in Header -->
    <button class="back-btn" onclick="goBack()" id="headerBackBtn" style="display:none;">
      <i class="fas fa-arrow-left"></i>
    </button>
    
    <!-- Save to Contacts Button -->
    <div class="save-contact-btn" onclick="saveBusinessToContacts()" title="Save to Contacts">
      <i class="fas fa-address-card"></i>
    </div>
    
    <!-- Centered Header Icons -->
    <div class="header-icons">
      <!-- Notification Bell -->
      <div class="header-icon-btn" onclick="toggleNotificationDrawer()" title="Notifications">
        <i class="fas fa-bell" id="notificationBell"></i>
        <div class="delivery-badge" id="notificationBadge" style="display:none;">!</div>
      </div>
      
      <!-- Delivery Status Icon -->
      <div class="header-icon-btn" id="deliveryStatusBtn" onclick="checkDeliveryStatus()" title="Delivery Status">
        <i class="fas fa-truck" id="deliveryIcon"></i>
        <div class="delivery-badge" id="deliveryBadge" style="display:none;"></div>
      </div>
      
      <!-- Login/Logout Icon -->
      <div class="header-icon-btn" id="loginBtn" onclick="toggleLogin()" title="Login/Logout">
        <i class="fas fa-sign-in-alt" id="loginIcon"></i>
      </div>
    </div>
    
    <!-- Share Button (Top Right) -->
    <div class="share-btn" onclick="shareBusiness()" title="Share Business">
      <i class="fas fa-share-alt"></i>
    </div>
  </div>

  <!-- Facebook-style Notification Drawer -->
  <div class="notification-drawer" id="notificationDrawer">
    <div class="notification-header">
      <h3><i class="fas fa-bell"></i> Notifications <span class="notification-count" id="notificationCount">0</span></h3>
      <button onclick="toggleNotificationDrawer()" style="background: none; border: none; font-size: 24px; color: var(--dark-color); cursor: pointer;">√ó</button>
    </div>
    <div class="notification-content" id="notificationList">
      <!-- Notifications will load here -->
    </div>
    <div class="notification-actions">
      <button onclick="markAllNotificationsAsRead()" style="flex:1; padding: 10px; background: #f1f5f9; border: none; border-radius: 8px; font-weight: 700; color: #64748b; cursor: pointer;">
        Mark All Read
      </button>
      <button onclick="enableNotifications()" style="flex:1; padding: 10px; background: var(--primary-gradient); border: none; border-radius: 8px; font-weight: 700; color: white; cursor: pointer;">
        Enable Alerts
      </button>
    </div>
  </div>

  <!-- Image Zoom Overlay -->
  <div class="image-zoom-overlay" id="imageZoomOverlay" onclick="closeImageZoom()">
    <img src="" class="image-zoom-content" id="zoomedImage">
  </div>

  <!-- Exit Confirmation Modal -->
  <div class="exit-modal-overlay" id="exitModal">
    <div class="exit-modal">
      <h2><i class="fas fa-sign-out-alt"></i> Exit App?</h2>
      <p>Are you sure you want to exit? Press back again to confirm.</p>
      <div class="exit-modal-buttons">
        <button class="exit-modal-btn cancel" onclick="closeExitModal()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="exit-modal-btn exit" onclick="exitApp()">
          <i class="fas fa-sign-out-alt"></i> Exit
        </button>
      </div>
    </div>
  </div>

  <!-- Install Permission Modal -->
  <div class="exit-modal-overlay" id="installPermissionModal" style="display:none;">
    <div class="install-permission-modal">
      <h2><i class="fas fa-download"></i> Enhance Your Experience</h2>
      <p>To provide you with the best experience, we'd like to:</p>
      
      <div class="permission-features">
        <div class="permission-feature">
          <i class="fas fa-check-circle"></i>
          <span>Save business details to your contacts</span>
        </div>
        <div class="permission-feature">
          <i class="fas fa-check-circle"></i>
          <span>Enable push notifications for orders</span>
        </div>
        <div class="permission-feature">
          <i class="fas fa-check-circle"></i>
          <span>Install app for quick access</span>
        </div>
        <div class="permission-feature">
          <i class="fas fa-check-circle"></i>
          <span>Auto-save your preferences</span>
        </div>
      </div>
      
      <p style="font-size: 14px; color: #94a3b8;">Your data is secure and never shared with third parties.</p>
      
      <div class="permission-buttons">
        <button class="permission-btn cancel" onclick="closeInstallPermissionModal()">
          <i class="fas fa-times"></i> Skip
        </button>
        <button class="permission-btn accept" onclick="acceptInstallPermissions()">
          <i class="fas fa-check"></i> Accept & Continue
        </button>
      </div>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="page active">
    <div class="loader"></div>
    <h1 id="loadingTitle">Digital Business App</h1>
    <p id="loadingSubtitle">Loading your premium business experience...</p>
  </div>

  <!-- Home Page -->
  <div id="homePage" class="page">
    <div class="app-header">
      <div class="welcome-text">
        <h1 id="businessHeader">Welcome</h1>
        <p>Premium business at your fingertips</p>
      </div>
      
      <div class="quick-actions">
        <div class="action-card" onclick="navigateTo('productsPage')">
          <div class="action-icon">
            <i class="fas fa-shopping-bag"></i>
          </div>
          <h3>Shop Now</h3>
          <p>Browse products & offers</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('cartPage')">
          <div class="action-icon">
            <i class="fas fa-shopping-cart"></i>
          </div>
          <h3>My Cart</h3>
          <p><span id="cartCountMini">0</span> items</p>
        </div>
        
        <div class="action-card" onclick="openWhatsAppChat('greeting')">
          <div class="action-icon">
            <i class="fab fa-whatsapp"></i>
          </div>
          <h3>Live Chat</h3>
          <p>Instant support</p>
        </div>
        
        <div class="action-card" onclick="navigateTo('contactPage')">
          <div class="action-icon">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <h3>Location</h3>
          <p>Find us</p>
        </div>
      </div>
    </div>

    <div class="profile-section">
      <img src="" id="photo" class="profile-avatar" loading="lazy">
      <div class="profile-name">
        <span id="name">Loading...</span>
        <i class="fas fa-badge-check verified-badge"></i>
      </div>
      <div class="profile-business" id="business"></div>
    </div>

    <div class="section-header">
      <h2><i class="fas fa-gift"></i> Featured Products</h2>
      <div class="see-all" onclick="navigateTo('productsPage')">
        See All <i class="fas fa-arrow-right"></i>
      </div>
    </div>
    
    <div class="products-grid" id="featuredProducts">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Products Page -->
  <div id="productsPage" class="page">
    <div class="products-header">
      <h1>Products & Offers</h1>
      <p>Discover our premium collection</p>
    </div>
    
    <div class="products-search">
      <input type="text" id="productsSearch" placeholder="Search products..." onkeyup="filterProducts()">
      <i class="fas fa-search"></i>
    </div>
    
    <div class="products-grid" id="allProducts">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Cart Page -->
  <div id="cartPage" class="page">
    <div class="cart-header">
      <h1>My Cart</h1>
      <p id="cartItemsCount">0 items</p>
    </div>
    
    <div id="cartContent">
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- About Page -->
  <div id="aboutPage" class="page">
    <div class="about-header">
      <h1>About Business</h1>
    </div>
    
    <div class="about-content" id="aboutContent">
    </div>
    
    <div class="business-hours">
      <h3><i class="fas fa-clock"></i> Business Hours</h3>
      <div class="hours-list" id="businessHours">
      </div>
    </div>
    
    <div class="business-hours">
      <h3><i class="fas fa-calendar-times"></i> Holidays</h3>
      <div class="hours-list" id="holidaysList">
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Contact Page -->
  <div id="contactPage" class="page">
    <div class="contact-header">
      <h1>Contact Us</h1>
      <p>Get in touch anytime</p>
    </div>
    
    <div class="contact-info">
      <!-- Save Business Contact -->
      <div class="contact-item" onclick="saveBusinessToContacts()" style="cursor:pointer;">
        <div class="contact-icon">
          <i class="fas fa-address-card"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Save Business Contact</div>
          <div class="contact-value">Tap to save to phonebook</div>
        </div>
      </div>
      
      <!-- Customer Phone for Delivery -->
      <div class="contact-item" onclick="openPhoneInput()" style="cursor:pointer;">
        <div class="contact-icon">
          <i class="fas fa-mobile-alt"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">My Delivery Phone</div>
          <div class="contact-value" id="customerPhoneDisplay">
            Tap to set your number
          </div>
        </div>
      </div>
      
      <div class="contact-item" onclick="makeCall()">
        <div class="contact-icon">
          <i class="fas fa-phone"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Call Business</div>
          <div class="contact-value" id="contactPhone">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openWhatsAppChat('greeting')">
        <div class="contact-icon">
          <i class="fab fa-whatsapp"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">WhatsApp</div>
          <div class="contact-value" id="contactWhatsApp">Chat Now</div>
        </div>
      </div>
      
      <div class="contact-item email-item" onclick="sendEmail()">
        <div class="contact-icon">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Email</div>
          <div class="contact-value" id="contactEmail">Loading...</div>
        </div>
      </div>
      
      <div class="contact-item" onclick="openMap()">
        <div class="contact-icon">
          <i class="fas fa-map-marker-alt"></i>
        </div>
        <div class="contact-details">
          <div class="contact-label">Address</div>
          <div class="contact-value" id="contactAddress">Loading...</div>
        </div>
      </div>
    </div>
    
    <div class="social-links">
      <h3><i class="fas fa-share-alt"></i> Follow Us</h3>
      <div class="social-grid" id="socialGrid">
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== DELIVERY STATUS PAGE ===== -->
  <div id="deliveryPage" class="page">
    <div class="delivery-page-header">
      <h1><i class="fas fa-truck"></i> Delivery Status</h1>
      <p>Track your orders in real-time</p>
    </div>
    
    <div id="deliveryContent">
      <!-- Delivery status will load here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== ADMIN DELIVERY PAGE ===== -->
  <div id="adminPage" class="page">
    <div class="delivery-page-header">
      <h1><i class="fas fa-cog"></i> Delivery Admin</h1>
      <p>Manage customer deliveries</p>
    </div>
    
    <div id="adminContent">
      <!-- Admin panel will load here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== SIMPLE LOGIN PAGE ===== -->
  <div id="loginPage" class="page">
    <div class="delivery-page-header">
      <h1><i class="fas fa-lock"></i> Admin Login</h1>
      <p>Enter password to access admin panel</p>
    </div>
    
    <div class="login-page-content">
      <div class="login-title">Admin Access</div>
      <div class="login-subtitle">Enter the admin password to continue</div>
      
      <input type="password" class="password-input" id="adminPasswordInput" 
             placeholder="Enter password" onkeypress="handleLoginKeypress(event)">
      
      <button onclick="attemptLogin()" class="admin-btn success" style="margin-top: 20px;">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
      
      <div class="password-hint" id="passwordHint">
        Hint: Password format is business123_{short_id}
      </div>
      
      <div id="logoutSection" style="display:none; margin-top: 30px;">
        <button onclick="logoutAdmin()" class="logout-btn" style="margin: 0 auto;">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== NEW CHECKOUT PAGE WITH ADDRESS VERIFICATION & DELIVERY CALCULATOR ===== -->
  <div id="checkoutPage" class="page">
    <div class="delivery-page-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
      <h1><i class="fas fa-shopping-cart"></i> Secure Checkout</h1>
      <p>Complete your order in 3 easy steps</p>
    </div>
    
    <!-- Country Detection Badge -->
    <div id="countryDetectionBadge" style="margin: 15px 15px -5px 15px;">
      <div class="country-detection-badge">
        <i class="fas fa-map-pin"></i>
        <span>Detecting your location...</span>
      </div>
    </div>
    
    <!-- Step 1: Address Verification -->
    <div class="address-verification-container">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color); display: flex; align-items: center; gap: 10px;">
          <span style="background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">1</span>
          Delivery Address
        </h3>
        <span class="cod-badge" id="codAvailabilityBadge" style="display: none;">
          <i class="fas fa-check"></i> COD Available
        </span>
      </div>
      
      <div class="address-input-group">
        <div class="address-label">
          <i class="fas fa-map-marker-alt"></i>
          <span>Search Your Address</span>
        </div>
        <div style="position: relative;">
          <input type="text" id="addressAutocomplete" class="address-field" placeholder="Start typing your address..." autocomplete="off">
          <div id="addressSuggestions" class="address-suggestions" style="display: none;"></div>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <div style="flex: 1;">
          <div class="address-label">
            <i class="fas fa-home"></i>
            <span>House/Building</span>
          </div>
          <input type="text" id="houseNumber" class="address-field" placeholder="House #, Building">
        </div>
        <div style="flex: 1;">
          <div class="address-label">
            <i class="fas fa-city"></i>
            <span>City</span>
          </div>
          <input type="text" id="deliveryCity" class="address-field" placeholder="City" readonly>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <div style="flex: 2;">
          <div class="address-label">
            <i class="fas fa-globe"></i>
            <span>Country</span>
          </div>
          <input type="text" id="deliveryCountry" class="address-field" placeholder="Country" readonly>
        </div>
        <div style="flex: 1;">
          <div class="address-label">
            <i class="fas fa-mail-bulk"></i>
            <span>Postal Code</span>
          </div>
          <div class="postal-code-verification">
            <input type="text" id="postalCode" class="postal-code-input" placeholder="Postal Code">
            <button class="postal-code-btn" onclick="verifyPostalCode()">
              <i class="fas fa-check"></i>
            </button>
          </div>
        </div>
      </div>
      
      <div id="postalCodeStatus" class="postal-code-status"></div>
      
      <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
        <button onclick="saveDeliveryAddress()" class="admin-btn success" style="width: auto; padding: 12px 30px;">
          <i class="fas fa-check-circle"></i> Save & Continue
        </button>
      </div>
    </div>
    
    <!-- Step 2: Delivery Calculator -->
    <div class="delivery-calculator-card" id="deliveryCalculatorSection" style="display: none;">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <span style="background: #8b5cf6; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 10px;">2</span>
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color);">Delivery Options</h3>
      </div>
      
      <div id="deliveryDistanceInfo" class="delivery-distance-info">
        <i class="fas fa-location-arrow"></i>
        <span>Calculating distance...</span>
      </div>
      
      <div id="deliveryOptionsList">
        <!-- Delivery options will be loaded here -->
      </div>
      
      <div style="margin-top: 20px;">
        <button onclick="proceedToPaymentGateway()" class="checkout-btn" style="margin: 0;">
          <i class="fas fa-arrow-right"></i> Proceed to Payment
        </button>
      </div>
    </div>
    
    <!-- Step 3: Payment Gateway -->
    <div class="payment-gateway-container" id="paymentGatewaySection" style="display: none;">
      <div style="display: flex; align-items: center; margin-bottom: 15px;">
        <span style="background: #10b981; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; margin-right: 10px;">3</span>
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color);">Payment Method</h3>
      </div>
      
      <!-- Payment Gateway Tabs - Auto-detected based on country -->
      <div class="payment-gateway-tabs" id="paymentGatewayTabs">
        <!-- Tabs will be dynamically added -->
      </div>
      
      <!-- Payment Gateway Content -->
      <div id="paymentGatewayContent" class="payment-gateway-content">
        <!-- Content will be loaded based on selected gateway -->
      </div>
      
      <!-- Order Summary -->
      <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 20px;">
        <h4 style="font-size: 16px; font-weight: 800; color: var(--dark-color); margin-bottom: 15px;">Order Summary</h4>
        <div id="checkoutOrderSummary"></div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
          <span style="font-size: 16px; font-weight: 700; color: var(--dark-color);">Total Amount</span>
          <span style="font-size: 28px; font-weight: 900; color: #10b981;" id="checkoutGrandTotal">PKR 0</span>
        </div>
      </div>
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== ORDER TRACKING PAGE ===== -->
  <div id="orderTrackingPage" class="page">
    <div class="delivery-page-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
      <h1><i class="fas fa-map-marked-alt"></i> Track Your Order</h1>
      <p>Real-time delivery tracking</p>
    </div>
    
    <div id="orderTrackingContent">
      <!-- Order tracking will be loaded here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- ===== DELIVERY PARTNER INTEGRATION PAGE ===== -->
  <div id="deliveryPartnerPage" class="page">
    <div class="delivery-page-header" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
      <h1><i class="fas fa-boxes"></i> Delivery Partners</h1>
      <p>Choose your preferred carrier</p>
    </div>
    
    <div id="deliveryPartnerContent">
      <!-- Delivery partner integration will be loaded here -->
    </div>
    
    <div class="page-footer-spacer"></div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="nav-item active" onclick="navigateTo('homePage')">
      <div class="nav-icon">
        <i class="fas fa-home"></i>
      </div>
      <div class="nav-label">Home</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('productsPage')">
      <div class="nav-icon">
        <i class="fas fa-shopping-bag"></i>
      </div>
      <div class="nav-label">Products</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('cartPage')">
      <div class="nav-icon">
        <i class="fas fa-shopping-cart"></i>
        <span class="cart-badge" id="cartBadge">0</span>
      </div>
      <div class="nav-label">Cart</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('aboutPage')">
      <div class="nav-icon">
        <i class="fas fa-info-circle"></i>
      </div>
      <div class="nav-label">About</div>
    </div>
    
    <div class="nav-item" onclick="navigateTo('contactPage')">
      <div class="nav-icon">
        <i class="fas fa-phone"></i>
      </div>
      <div class="nav-label">Contact</div>
    </div>
  </div>
</div>

<!-- Notification Alert -->
<div class="notification-alert" id="notificationAlert"></div>

<!-- Delivery Status Modal -->
<div class="delivery-modal-overlay" id="deliveryStatusModal">
  <div class="delivery-modal">
    <button onclick="closeDeliveryModal()" style="position:absolute;top:15px;right:15px;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;color:var(--dark-color);font-size:24px;cursor:pointer;">√ó</button>
    <div id="deliveryStatusContent" style="padding:40px 25px;">
      <h2 style="text-align:center;margin-bottom:25px;color:var(--dark-color);">
        <i class="fas fa-truck"></i> Delivery Status
      </h2>
      <div id="deliveryStatusList"></div>
    </div>
  </div>
</div>

<!-- Other Modals -->
<div class="modal-overlay" id="productModal">
  <div class="modal-content">
    <button class="close-btn" onclick="closeModal('productModal')">√ó</button>
    
    <div class="product-image-container" style="background:white;">
      <img src="" id="modalImage" class="product-image" loading="lazy">
    </div>
    
    <div style="padding:25px;">
      <div id="modalPrice" class="modal-price-container"></div>
      
      <h2 id="modalTitle" style="font-size:20px;font-weight:800;color:var(--dark-color);margin-bottom:12px;"></h2>
      <p id="modalDescription" style="color:#64748b;line-height:1.6;margin-bottom:20px;font-size:14px;"></p>
      
      <div style="display:flex;gap:12px;margin-top:25px;">
        <button onclick="quickBuyProduct()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--primary-gradient);color:white;">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button onclick="addToCartFromModal()" style="flex:1;padding:15px;border:none;border-radius:var(--border-radius-md);font-size:15px;font-weight:800;cursor:pointer;background:var(--secondary-gradient);color:white;">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<!-- Load Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<!-- Load Razorpay -->
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
// ===== SUPABASE CLIENT INITIALIZATION =====
const supa = supabase.createClient(
  "https://dfvnefbxgayxqgjjgtrr.supabase.co",
  "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
);

// ===== DUAL NOTIFICATION SYSTEM =====
let notificationPermission = false;
let innerNotifications = [];
let unreadNotifications = 0;

// ===== CUSTOMER DATA COLLECTION =====
let customerData = {
  deviceId: '',
  phone: '',
  name: '',
  email: '',
  installDate: '',
  lastActive: '',
  permissions: {}
};

// ===== NEW CHECKOUT SYSTEM VARIABLES =====
let userCountry = null;
let userCity = null;
let userPostalCode = null;
let verifiedAddress = null;
let verifiedCoordinates = null;
let selectedDeliveryOption = null;
let selectedPaymentGateway = 'stripe';
let businessLocation = { lat: 24.8607, lng: 67.0011 }; // Default: Karachi, Pakistan
let deliveryDistance = 0;
let activeOrder = null;
let deliveryPartners = [];
let autocompleteService = null;
let placesService = null;
let geocoder = null;

// ===== PAYMENT GATEWAY CONFIGURATION =====
const PAYMENT_CONFIG = {
  stripe: {
    publishableKey: 'YOUR_STRIPE_PUBLISHABLE_KEY',
    enabled: true
  },
  razorpay: {
    keyId: 'YOUR_RAZORPAY_KEY_ID',
    enabled: true
  },
  sslcommerz: {
    storeId: 'YOUR_STORE_ID',
    storePassword: 'YOUR_STORE_PASSWORD',
    enabled: true
  }
};

// ===== DELIVERY PARTNER CONFIGURATION =====
const DELIVERY_PARTNERS = {
  leopards: {
    name: 'Leopards Courier',
    apiKey: 'YOUR_LEOPARDS_API_KEY',
    enabled: true
  },
  tcs: {
    name: 'TCS Express',
    apiKey: 'YOUR_TCS_API_KEY',
    enabled: true
  },
  fedex: {
    name: 'FedEx',
    apiKey: 'YOUR_FEDEX_API_KEY',
    enabled: true
  },
  dhl: {
    name: 'DHL Express',
    apiKey: 'YOUR_DHL_API_KEY',
    enabled: true
  },
  blueEx: {
    name: 'BlueEX',
    apiKey: 'YOUR_BLUEEX_API_KEY',
    enabled: true
  }
};

// Generate unique device ID
function generateDeviceId() {
  let deviceId = localStorage.getItem('customer_device_id');
  if (!deviceId) {
    deviceId = 'dev_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('customer_device_id', deviceId);
  }
  return deviceId;
}

// Initialize customer data
function initCustomerData() {
  customerData.deviceId = generateDeviceId();
  customerData.installDate = new Date().toISOString();
  customerData.lastActive = new Date().toISOString();
  customerData.phone = getCustomerPhone() || '';
  
  // Load saved customer name and email
  const savedName = isolatedLocalStorage.getItem('customerName');
  const savedEmail = isolatedLocalStorage.getItem('customerEmail');
  customerData.name = savedName || '';
  customerData.email = savedEmail || '';
  
  // Save to Supabase
  saveCustomerDataToBackend();
}

// Save customer data to Supabase
async function saveCustomerDataToBackend() {
  try {
    const { data: existing } = await supa
      .from('customer_data')
      .select('id')
      .eq('device_id', customerData.deviceId)
      .maybeSingle();
    
    if (existing) {
      const { error } = await supa
        .from('customer_data')
        .update({
          phone: customerData.phone,
          name: customerData.name,
          email: customerData.email,
          last_active: new Date().toISOString(),
          permissions: customerData.permissions
        })
        .eq('device_id', customerData.deviceId);
    } else {
      const { error } = await supa
        .from('customer_data')
        .insert([{
          device_id: customerData.deviceId,
          phone: customerData.phone,
          name: customerData.name,
          email: customerData.email,
          business_id: currentBusinessId,
          install_date: customerData.installDate,
          last_active: customerData.lastActive,
          permissions: customerData.permissions
        }]);
    }
  } catch (error) {
    console.log('Error saving customer data:', error);
  }
}

// Update customer permissions
function updateCustomerPermissions(permissionType, granted) {
  customerData.permissions[permissionType] = {
    granted: granted,
    date: new Date().toISOString()
  };
  saveCustomerDataToBackend();
}

// ===== INSTALL PERMISSIONS SYSTEM =====
let installPermissionsShown = false;

function showInstallPermissionModal() {
  if (installPermissionsShown || isolatedLocalStorage.getItem('installPermissionsShown') === 'true') {
    return;
  }
  
  setTimeout(() => {
    document.getElementById('installPermissionModal').style.display = 'flex';
    installPermissionsShown = true;
  }, 3000);
}

function closeInstallPermissionModal() {
  document.getElementById('installPermissionModal').style.display = 'none';
  isolatedLocalStorage.setItem('installPermissionsShown', 'true');
  updateCustomerPermissions('install_modal', false);
}

async function acceptInstallPermissions() {
  isolatedLocalStorage.setItem('installPermissionsShown', 'true');
  
  updateCustomerPermissions('install_modal', true);
  updateCustomerPermissions('contacts', true);
  updateCustomerPermissions('notifications', true);
  updateCustomerPermissions('install_prompt', true);
  
  document.getElementById('installPermissionModal').style.display = 'none';
  
  showNotification('‚úÖ Thank you! Enhancing your experience...');
  
  setTimeout(() => {
    saveBusinessToContacts(true);
  }, 1000);
  
  setTimeout(() => {
    enableNotifications();
  }, 2000);
  
  setTimeout(() => {
    showInstallPromptIfAvailable();
  }, 3000);
  
  saveCustomerDataToBackend();
}

// ===== SAVE BUSINESS TO CONTACTS =====
async function saveBusinessToContacts(silent = false) {
  if (!card.name || !card.phone) {
    if (!silent) showNotification('‚ùå Business information incomplete');
    return;
  }
  
  if (!('contacts' in navigator && 'ContactsManager' in window)) {
    if (!silent) showSaveContactsFallback();
    return;
  }
  
  try {
    const granted = await navigator.permissions.query({ name: 'contacts' });
    
    if (granted.state === 'granted') {
      const contact = {
        name: [card.name],
        tel: [{ number: card.phone, type: 'work' }],
        email: card.email ? [{ address: card.email, type: 'work' }] : [],
        note: [card.businessName || 'Business Contact'],
        url: card.website ? [{ url: card.website, type: 'work' }] : [],
        address: card.address ? [{ streetAddress: card.address, type: 'work' }] : []
      };
      
      const contacts = await navigator.contacts.select(['name', 'tel', 'email'], { multiple: false });
      await navigator.contacts.save(contact);
      
      if (!silent) showNotification('‚úÖ Business saved to contacts!');
      addInnerNotification('Contact Saved', `${card.name} saved to your phonebook`, 'success');
      updateCustomerPermissions('contacts_saved', true);
      logContactSave();
    } else {
      if (!silent) showSaveContactsFallback();
    }
  } catch (error) {
    console.log('Error saving contact:', error);
    if (!silent) showSaveContactsFallback();
  }
}

function showSaveContactsFallback() {
  const businessName = card.name || 'Business';
  const phone = card.phone || '';
  const email = card.email || '';
  const address = card.address || '';
  
  let contactInfo = `Business: ${businessName}\nPhone: ${phone}\n`;
  if (email) contactInfo += `Email: ${email}\n`;
  if (address) contactInfo += `Address: ${address}\n`;
  
  navigator.clipboard.writeText(contactInfo).then(() => {
    showNotification('üìã Contact info copied! Paste in your contacts app');
  }).catch(() => {
    prompt('Copy this contact information:', contactInfo);
  });
}

async function logContactSave() {
  try {
    const { error } = await supa
      .from('contact_saves')
      .insert([{
        business_id: currentBusinessId,
        device_id: customerData.deviceId,
        timestamp: new Date().toISOString()
      }]);
  } catch (error) {
    console.log('Error logging contact save:', error);
  }
}

// Register Service Worker
async function registerServiceWorker() {
  if ('serviceWorker' in navigator) {
    try {
      const registration = await navigator.serviceWorker.register('sw.js');
      console.log('Service Worker registered:', registration);
      return registration;
    } catch (error) {
      console.error('Service Worker registration failed:', error);
    }
  }
  return null;
}

// Toggle Facebook-style notification drawer
function toggleNotificationDrawer() {
  const drawer = document.getElementById('notificationDrawer');
  if (drawer.classList.contains('open')) {
    drawer.classList.remove('open');
  } else {
    drawer.classList.add('open');
    loadNotificationDrawer();
  }
}

// Load notifications into drawer
function loadNotificationDrawer() {
  const list = document.getElementById('notificationList');
  const count = document.getElementById('notificationCount');
  
  if (innerNotifications.length === 0) {
    list.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <i class="fas fa-bell-slash" style="font-size: 60px; color: #cbd5e1; margin-bottom: 20px;"></i>
        <h3 style="color: var(--dark-color); margin-bottom: 10px;">No notifications yet</h3>
        <p style="color: #64748b;">Your notifications will appear here</p>
        <button onclick="enableNotifications()" style="margin-top: 20px; padding: 10px 20px; background: var(--primary-gradient); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">
          Enable Alerts
        </button>
      </div>
    `;
    count.textContent = '0';
    return;
  }
  
  let html = '';
  innerNotifications.forEach(notif => {
    const timeAgo = getTimeAgo(notif.time);
    const icon = getNotificationIconByType(notif.type);
    
    html += `
      <div class="notification-item ${notif.read ? '' : 'unread'}" onclick="markNotificationAsRead(${notif.id})">
        <div style="display: flex; align-items: start; gap: 12px;">
          <div style="font-size: 20px; color: ${getNotificationColorByType(notif.type)}">${icon}</div>
          <div style="flex: 1;">
            <div style="font-weight: 800; color: var(--dark-color); font-size: 13px; margin-bottom: 4px;">${notif.title}</div>
            <div style="color: #64748b; font-size: 12px; line-height: 1.4;">${notif.message}</div>
            <div class="notification-time">
              <i class="fas fa-clock" style="font-size: 10px;"></i>
              <span>${timeAgo}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
  count.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
}

// Get time ago string
function getTimeAgo(date) {
  const now = new Date();
  const diffMs = now - new Date(date);
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  if (diffDays < 7) return `${diffDays}d ago`;
  return new Date(date).toLocaleDateString();
}

// Get notification icon by type
function getNotificationIconByType(type) {
  const icons = {
    'success': '‚úÖ', 'warning': '‚ö†Ô∏è', 'error': '‚ùå', 'info': '‚ÑπÔ∏è',
    'delivery': 'üöö', 'order': 'üì¶', 'system': 'üîî'
  };
  return icons[type] || icons.info;
}

// Get notification color by type
function getNotificationColorByType(type) {
  const colors = {
    'success': '#10b981', 'warning': '#f59e0b', 'error': '#ef4444',
    'info': '#3b82f6', 'delivery': '#8b5cf6', 'order': '#8b5cf6', 'system': '#667eea'
  };
  return colors[type] || colors.info;
}

// Mark notification as read
function markNotificationAsRead(id) {
  const index = innerNotifications.findIndex(n => n.id === id);
  if (index !== -1 && !innerNotifications[index].read) {
    innerNotifications[index].read = true;
    unreadNotifications--;
    saveInnerNotifications();
    updateNotificationBellCount();
    loadNotificationDrawer();
  }
}

// Mark all notifications as read
function markAllNotificationsAsRead() {
  innerNotifications.forEach(n => n.read = true);
  unreadNotifications = 0;
  saveInnerNotifications();
  updateNotificationBellCount();
  loadNotificationDrawer();
  showNotification('‚úÖ All notifications marked as read');
}

// Save notifications to localStorage
function saveInnerNotifications() {
  isolatedLocalStorage.setItem('innerNotifications', JSON.stringify(innerNotifications));
}

// Load notifications from localStorage
function loadInnerNotifications() {
  const saved = isolatedLocalStorage.getItem('innerNotifications');
  if (saved) {
    innerNotifications = JSON.parse(saved);
    unreadNotifications = innerNotifications.filter(n => !n.read).length;
    updateNotificationBellCount();
  }
}

// Update bell icon with count
function updateNotificationBellCount() {
  const badge = document.getElementById('notificationBadge');
  const bell = document.getElementById('notificationBell');
  
  if (unreadNotifications > 0) {
    badge.textContent = unreadNotifications > 9 ? '9+' : unreadNotifications;
    badge.style.display = 'flex';
    badge.classList.add('alert');
    bell.style.color = '#f59e0b';
  } else {
    badge.style.display = 'none';
    badge.classList.remove('alert');
    bell.style.color = notificationPermission ? '#f59e0b' : 'white';
  }
}

// Add inner notification
function addInnerNotification(title, message, type = 'info') {
  const notification = {
    id: Date.now(),
    title,
    message,
    type,
    time: new Date(),
    read: false
  };
  
  innerNotifications.unshift(notification);
  unreadNotifications++;
  
  if (innerNotifications.length > 50) innerNotifications.pop();
  
  saveInnerNotifications();
  updateNotificationBellCount();
  
  if (document.getElementById('notificationDrawer').classList.contains('open')) {
    loadNotificationDrawer();
  }
  
  return notification.id;
}

// Ask for notification permission
async function enableNotifications() {
  if (!('Notification' in window)) {
    showNotification('‚ùå Notifications not supported on this device');
    return;
  }
  
  if (Notification.permission === 'granted') {
    showNotification('‚úÖ Notifications already enabled!');
    notificationPermission = true;
    updateNotificationBellCount();
    addInnerNotification('Notifications Enabled', 'You will receive alerts for updates and deliveries', 'success');
    updateCustomerPermissions('notifications', true);
    return;
  }
  
  if (Notification.permission === 'denied') {
    showNotification('‚ùå Notifications blocked. Please enable in browser settings.');
    updateCustomerPermissions('notifications', false);
    return;
  }
  
  const permission = await Notification.requestPermission();
  
  if (permission === 'granted') {
    showNotification('‚úÖ Notifications enabled! You will receive alerts.');
    notificationPermission = true;
    updateNotificationBellCount();
    await registerServiceWorker();
    startNotificationListener();
    addInnerNotification('Notifications Enabled', 'You will receive alerts for updates and deliveries', 'success');
    updateCustomerPermissions('notifications', true);
  } else {
    showNotification('‚ùå Notifications disabled. You wont receive alerts.');
    updateCustomerPermissions('notifications', false);
  }
}

// Check current notification permission
function checkNotificationPermission() {
  if (Notification.permission === 'granted') {
    notificationPermission = true;
    updateNotificationBellCount();
    registerServiceWorker().then(() => startNotificationListener());
    updateCustomerPermissions('notifications', true);
  } else {
    notificationPermission = false;
    updateNotificationBellCount();
    updateCustomerPermissions('notifications', false);
  }
}

// Listen for new notifications from Supabase
function startNotificationListener() {
  if (!notificationPermission) return;
  
  console.log('Starting notification listener...');
  
  supa
    .channel('business-notifications')
    .on('postgres_changes', {
      event: 'INSERT',
      schema: 'public',
      table: 'notifications'
    }, (payload) => {
      console.log('New notification:', payload.new);
      showPushNotification(payload.new);
      addInnerNotification(payload.new.title, payload.new.body, 'system');
      showNotification(`üì¢ ${payload.new.title}`);
    })
    .subscribe();
}

// Show push notification (mobile top-bar)
function showPushNotification(data) {
  if (!notificationPermission || !('serviceWorker' in navigator)) return;
  
  navigator.serviceWorker.ready.then(registration => {
    registration.showNotification(data.title || 'Business Alert', {
      body: data.body || 'New notification',
      icon: 'https://cdn-icons-png.flaticon.com/512/1006/1006771.png',
      badge: 'https://cdn-icons-png.flaticon.com/512/1006/1006771.png',
      vibrate: [200, 100, 200],
      data: { url: '/', id: data.id }
    });
  });
}

// ===== ADMIN: SEND NOTIFICATION =====
async function sendNotificationToAll(title, body) {
  if (!isAdminLoggedIn) {
    showNotification('‚ùå Admin access required');
    return;
  }
  
  if (!title || !body) {
    title = prompt('Notification Title:', 'New Update');
    body = prompt('Notification Message:', 'Check out our latest products!');
    if (!title || !body) return;
  }
  
  const { error } = await supa
    .from('notifications')
    .insert([{ title, body }]);
    
  if (!error) {
    showNotification('‚úÖ Notification sent to all users!');
    addInnerNotification('Notification Sent', `"${title}" sent to all users`, 'success');
    if (notificationPermission) showPushNotification({ title, body });
  } else {
    showNotification('‚ùå Error sending notification');
  }
}

// Test notification
function testNotification() {
  if (notificationPermission) {
    showPushNotification({
      title: 'Test Notification',
      body: 'This is a test notification from your business app!'
    });
    addInnerNotification('Test Notification', 'This is a test notification from your business app!', 'info');
    showNotification('‚úÖ Test notification sent');
  } else {
    showNotification('‚ùå Enable notifications first');
  }
}

// ===== DELIVERY STATUS NOTIFICATIONS =====
function addDeliveryNotification(delivery) {
  const statusText = delivery.status.charAt(0).toUpperCase() + delivery.status.slice(1);
  const title = `Delivery ${statusText}`;
  const message = `Order #${delivery.order_id} is now ${delivery.status}`;
  
  let type = 'info';
  switch(delivery.status) {
    case 'delivered': type = 'success'; break;
    case 'cancelled': type = 'error'; break;
    case 'pending': type = 'warning'; break;
    case 'shipped': type = 'delivery'; break;
  }
  
  addInnerNotification(title, message, type);
  
  if (notificationPermission) {
    showPushNotification({ title: `üöö ${title}`, body: message });
  }
}

// ===== SHORT ID SYSTEM (6 CHARACTERS) =====
function generateShortId() {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
  let shortId = '';
  for (let i = 0; i < 6; i++) {
    shortId += chars.charAt(Math.floor(Math.random() * chars.length));
  }
  return shortId;
}

// ===== PASSWORD GENERATOR SYSTEM =====
function generateAdminPassword(cardId, shortId) {
  if (!cardId) return "admin123_default";
  const shortPart = shortId ? shortId.toLowerCase() : cardId.substring(0, 6).toLowerCase();
  return `business123_${shortPart}`;
}

// ===== SHARE FUNCTIONALITY =====
function shareBusiness() {
  const businessName = card.businessName || card.name || "Business";
  const currentUrl = window.location.href.split('?')[0];
  let shareUrl = currentUrl;
  
  if (shortCardId) {
    shareUrl = `${currentUrl}?id=${shortCardId}`;
  } else if (card.id) {
    checkAndCreateShortId(card.id).then(shortId => {
      if (shortId) {
        shareUrl = `${currentUrl}?id=${shortId}`;
        showShareDialog(businessName, shareUrl);
      } else {
        shareUrl = `${currentUrl}?id=${card.id}`;
        showShareDialog(businessName, shareUrl);
      }
    });
  } else {
    showShareDialog(businessName, shareUrl);
  }
}

async function checkAndCreateShortId(fullId) {
  const { data: existing } = await supa
    .from('short_urls')
    .select('short_id')
    .eq('full_id', fullId)
    .single();
  
  if (existing) return existing.short_id;
  
  const shortId = generateShortId();
  const { error } = await supa
    .from('short_urls')
    .insert([{ short_id: shortId, full_id: fullId }]);
  
  if (!error) {
    shortCardId = shortId;
    return shortId;
  }
  return null;
}

function showShareDialog(businessName, shareUrl) {
  const shareText = `Check out ${businessName} on their business app!`;
  const fullText = `${shareText}\n\n${shareUrl}`;
  
  if (navigator.share) {
    navigator.share({ title: businessName, text: shareText, url: shareUrl })
      .catch(() => fallbackShare(fullText));
  } else {
    fallbackShare(fullText);
  }
}

function fallbackShare(fullText) {
  const tempInput = document.createElement('input');
  tempInput.value = fullText;
  document.body.appendChild(tempInput);
  tempInput.select();
  
  try {
    const successful = document.execCommand('copy');
    if (successful) showNotification('‚úÖ Link copied to clipboard!');
    else prompt('Copy this link to share:', fullText);
  } catch (err) {
    prompt('Copy this link to share:', fullText);
  }
  
  document.body.removeChild(tempInput);
}

// ===== FIXED PWA MANIFEST SYSTEM =====
function setupDynamicPWA(businessData) {
  const businessName = businessData.businessName || businessData.name || "Business";
  const appName = businessName + " App";
  const shortName = businessName.length > 12 ? businessName.substring(0, 10) + ".." : businessName;
  const profileImage = businessData.profileImage || '';
  
  const manifest = {
    "name": appName,
    "short_name": shortName + " App",
    "description": "Premium business app for " + businessName,
    "theme_color": "#667eea",
    "background_color": "#ffffff",
    "display": "standalone",
    "orientation": "portrait",
    "scope": "/",
    "start_url": window.location.origin + window.location.pathname + "?source=pwa",
    "icons": [
      { "src": profileImage || getDefaultIcon(businessName), "sizes": "192x192", "type": "image/png", "purpose": "any maskable" },
      { "src": profileImage || getDefaultIcon(businessName), "sizes": "512x512", "type": "image/png", "purpose": "any maskable" }
    ]
  };
  
  const oldManifest = document.querySelector('link[rel="manifest"]');
  if (oldManifest) oldManifest.remove();
  
  const manifestLink = document.createElement('link');
  manifestLink.rel = 'manifest';
  manifestLink.href = 'manifest.json';
  document.head.appendChild(manifestLink);
  
  createStaticManifest(manifest);
  document.title = appName;
  document.getElementById('loadingTitle').textContent = appName;
  document.getElementById('loadingSubtitle').textContent = `Loading ${businessName} experience...`;
  document.getElementById('themeColorMeta').content = "#667eea";
  updateFavicon(profileImage || getDefaultIcon(businessName));
  
  setTimeout(() => showInstallPromptIfAvailable(), 3000);
}

function createStaticManifest(manifest) {
  const manifestData = JSON.stringify(manifest, null, 2);
  const blob = new Blob([manifestData], {type: 'application/json'});
  const manifestURL = URL.createObjectURL(blob);
  localStorage.setItem('pwa_manifest', manifestData);
  
  const manifestLink = document.querySelector('link[rel="manifest"]');
  if (manifestLink) manifestLink.href = manifestURL;
}

function getDefaultIcon(businessName) {
  const firstLetter = businessName.charAt(0).toUpperCase();
  const colors = ['#667eea', '#764ba2', '#10b981', '#f59e0b', '#ef4444', '#3b82f6'];
  const color = colors[businessName.length % colors.length];
  const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" fill="${color}" rx="20"/><text x="50" y="65" font-size="40" font-family="Arial" fill="white" text-anchor="middle" font-weight="bold">${firstLetter}</text></svg>`;
  return 'data:image/svg+xml;base64,' + btoa(svg);
}

function updateFavicon(iconUrl) {
  let favicon = document.querySelector('link[rel="icon"]');
  if (!favicon) {
    favicon = document.createElement('link');
    favicon.rel = 'icon';
    document.head.appendChild(favicon);
  }
  favicon.href = iconUrl;
  
  let appleIcon = document.querySelector('link[rel="apple-touch-icon"]');
  if (!appleIcon) {
    appleIcon = document.createElement('link');
    appleIcon.rel = 'apple-touch-icon';
    document.head.appendChild(appleIcon);
  }
  appleIcon.href = iconUrl;
  appleIcon.sizes = "180x180";
}

// ===== DATA ISOLATION SYSTEM =====
let currentBusinessId = '';

function getStorageKey(key) {
  const businessKey = currentBusinessId ? currentBusinessId.substring(0, 8) : 'default';
  return `business_${businessKey}_${key}`;
}

const isolatedLocalStorage = {
  setItem: function(key, value) {
    const storageKey = getStorageKey(key);
    return localStorage.setItem(storageKey, value);
  },
  getItem: function(key) {
    const storageKey = getStorageKey(key);
    return localStorage.getItem(storageKey);
  },
  removeItem: function(key) {
    const storageKey = getStorageKey(key);
    return localStorage.removeItem(storageKey);
  },
  clear: function() {
    const prefix = getStorageKey('');
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(prefix)) localStorage.removeItem(key);
    }
  },
  getAllKeys: function() {
    const prefix = getStorageKey('');
    const keys = [];
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      if (key.startsWith(prefix)) keys.push(key.replace(prefix, ''));
    }
    return keys;
  }
};

// ===== CUSTOMER PHONE MANAGEMENT =====
function getCustomerPhone() {
  const phone = isolatedLocalStorage.getItem('customerPhone');
  if (!phone && card.phone) {
    const savedBusinessPhone = isolatedLocalStorage.getItem('businessPhone');
    if (savedBusinessPhone === card.phone) return card.phone;
  }
  return phone;
}

function saveCustomerPhone(phone) {
  isolatedLocalStorage.setItem('customerPhone', phone);
  customerData.phone = phone;
  saveCustomerDataToBackend();
}

function saveBusinessPhone(phone) {
  isolatedLocalStorage.setItem('businessPhone', phone);
}

// ===== FIXED PWA INSTALLATION HANDLER =====
let deferredPrompt = null;
let installButtonShown = false;

window.addEventListener('beforeinstallprompt', (e) => {
  console.log('PWA install prompt available');
  e.preventDefault();
  deferredPrompt = e;
  
  if (!installButtonShown) {
    setTimeout(() => {
      showInstallButton();
      installButtonShown = true;
    }, 5000);
  }
});

function showInstallButton() {
  if (!deferredPrompt) return;
  
  const existingContainer = document.querySelector('.install-button-container');
  if (existingContainer) existingContainer.remove();
  
  const installContainer = document.createElement('div');
  installContainer.className = 'install-button-container';
  installContainer.innerHTML = `
    <button class="install-btn" onclick="installPWA()">
      <i class="fas fa-download"></i> Install App
    </button>
  `;
  
  document.body.appendChild(installContainer);
  
  setTimeout(() => {
    if (installContainer.parentNode) {
      installContainer.remove();
      installButtonShown = false;
    }
  }, 30000);
}

function installPWA() {
  if (!deferredPrompt) return;
  
  deferredPrompt.prompt();
  
  deferredPrompt.userChoice.then((choiceResult) => {
    if (choiceResult.outcome === 'accepted') {
      showNotification('‚úÖ App installed successfully!');
      const installContainer = document.querySelector('.install-button-container');
      if (installContainer) installContainer.remove();
      installButtonShown = true;
      updateCustomerPermissions('app_installed', true);
    } else {
      updateCustomerPermissions('app_installed', false);
    }
    deferredPrompt = null;
  });
}

function isPWAInstalled() {
  return window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone === true;
}

function showInstallPromptIfAvailable() {
  if (isPWAInstalled()) return;
  if (deferredPrompt && !installButtonShown) showInstallButton();
}

// ===== FIXED BACK BUTTON SYSTEM =====
let lastBackPress = 0;
let backPressCount = 0;
let navigationHistory = [];

function initializeRouting() {
  window.addEventListener('hashchange', handleHashChange);
  
  setTimeout(() => {
    const hash = window.location.hash.replace('#', '');
    if (hash) handleHashChange();
    else window.location.hash = '#home';
  }, 100);
}

function handleHashChange() {
  const hash = window.location.hash.replace('#', '');
  const pageMap = {
    'home': 'homePage', 'products': 'productsPage', 'cart': 'cartPage',
    'about': 'aboutPage', 'contact': 'contactPage', 'delivery': 'deliveryPage',
    'admin': 'adminPage', 'login': 'loginPage', 'checkout': 'checkoutPage',
    'track': 'orderTrackingPage', 'partner': 'deliveryPartnerPage'
  };
  
  if (pageMap[hash]) {
    if (currentPage !== pageMap[hash]) navigateToDirect(pageMap[hash]);
  } else {
    window.location.hash = '#home';
  }
}

function navigateToDirect(pageId) {
  if(currentPage === pageId) return;
  
  const oldPage = document.getElementById(currentPage);
  const newPage = document.getElementById(pageId);
  
  if(oldPage) {
    oldPage.classList.remove('active');
    oldPage.classList.add('slide-out');
  }
  
  setTimeout(() => {
    if(oldPage) oldPage.classList.remove('slide-out');
    newPage.classList.add('active');
    currentPage = pageId;
    
    const backBtn = document.getElementById('headerBackBtn');
    backBtn.style.display = pageId !== 'homePage' ? 'flex' : 'none';
    
    document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
    
    const navMap = {
      'homePage': 0, 'productsPage': 1, 'cartPage': 2, 'aboutPage': 3, 'contactPage': 4,
      'deliveryPage': 0, 'adminPage': 0, 'loginPage': 0, 'checkoutPage': 2,
      'orderTrackingPage': 0, 'deliveryPartnerPage': 0
    };
    
    if(navMap[pageId] !== undefined) {
      document.querySelectorAll('.nav-item')[navMap[pageId]].classList.add('active');
    }
    
    document.getElementById('notificationDrawer').classList.remove('open');
    
    switch(pageId) {
      case 'homePage': loadHomePage(); break;
      case 'productsPage': loadProductsPage(); break;
      case 'cartPage': loadCartPage(); break;
      case 'aboutPage': loadAboutPage(); break;
      case 'contactPage': loadContactPage(); break;
      case 'deliveryPage': loadDeliveryStatus(); break;
      case 'checkoutPage': loadCheckoutPage(); break;
      case 'orderTrackingPage': if (activeOrder) loadOrderTracking(activeOrder); break;
      case 'deliveryPartnerPage': loadDeliveryPartners(); break;
      case 'adminPage': if (isAdminLoggedIn) loadAdminPanel(); else navigateTo('loginPage'); break;
    }
  }, 300);
}

function navigateTo(pageId) {
  const hashMap = {
    'homePage': 'home', 'productsPage': 'products', 'cartPage': 'cart',
    'aboutPage': 'about', 'contactPage': 'contact', 'deliveryPage': 'delivery',
    'adminPage': 'admin', 'loginPage': 'login', 'checkoutPage': 'checkout',
    'orderTrackingPage': 'track', 'deliveryPartnerPage': 'partner'
  };
  
  if (hashMap[pageId]) {
    window.location.hash = `#${hashMap[pageId]}`;
    navigationHistory.push(pageId);
  }
}

function goBack() {
  if (document.getElementById('notificationDrawer').classList.contains('open')) {
    toggleNotificationDrawer();
    return;
  }
  
  if (navigationHistory.length > 1) {
    navigationHistory.pop();
    const previousPage = navigationHistory[navigationHistory.length - 1];
    window.history.back();
  } else {
    navigateTo('homePage');
  }
}

// ===== EXIT MODAL FUNCTIONS =====
function showExitModal() {
  document.getElementById('exitModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeExitModal() {
  document.getElementById('exitModal').style.display = 'none';
  document.body.style.overflow = 'auto';
  backPressCount = 0;
}

function exitApp() {
  if (document.fullscreenElement) document.exitFullscreen();
  if (window.history.length > 1) window.history.go(-1);
  else window.close();
}

// ===== GOOGLE MAPS INITIALIZATION =====
function initAutocomplete() {
  autocompleteService = new google.maps.places.AutocompleteService();
  placesService = new google.maps.places.PlacesService(document.createElement('div'));
  geocoder = new google.maps.Geocoder();
  
  // Setup address autocomplete
  const addressInput = document.getElementById('addressAutocomplete');
  if (addressInput) {
    addressInput.addEventListener('input', debounce(handleAddressInput, 300));
    addressInput.addEventListener('focus', () => {
      if (addressInput.value.length > 2) handleAddressInput();
    });
  }
  
  // Detect user location
  detectUserCountry();
}

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

function handleAddressInput() {
  const input = document.getElementById('addressAutocomplete').value;
  if (input.length < 3) {
    document.getElementById('addressSuggestions').style.display = 'none';
    return;
  }
  
  const request = {
    input: input,
    types: ['address']
  };
  
  autocompleteService.getPlacePredictions(request, (predictions, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
      displayAddressSuggestions(predictions);
    } else {
      document.getElementById('addressSuggestions').style.display = 'none';
    }
  });
}

function displayAddressSuggestions(predictions) {
  const suggestionsDiv = document.getElementById('addressSuggestions');
  suggestionsDiv.innerHTML = '';
  
  predictions.forEach(prediction => {
    const item = document.createElement('div');
    item.className = 'address-suggestion-item';
    item.innerHTML = `<i class="fas fa-map-marker-alt" style="margin-right: 10px; color: #667eea;"></i>${prediction.description}`;
    item.onclick = () => selectAddress(prediction);
    suggestionsDiv.appendChild(item);
  });
  
  suggestionsDiv.style.display = 'block';
}

function selectAddress(prediction) {
  document.getElementById('addressAutocomplete').value = prediction.description;
  document.getElementById('addressSuggestions').style.display = 'none';
  
  // Get place details
  placesService.getDetails({ placeId: prediction.place_id }, (place, status) => {
    if (status === google.maps.places.PlacesServiceStatus.OK) {
      extractAddressComponents(place);
    }
  });
}

function extractAddressComponents(place) {
  let city = '';
  let country = '';
  let postalCode = '';
  
  place.address_components.forEach(component => {
    if (component.types.includes('locality') || component.types.includes('postal_town')) {
      city = component.long_name;
    }
    if (component.types.includes('country')) {
      country = component.long_name;
    }
    if (component.types.includes('postal_code')) {
      postalCode = component.long_name;
    }
  });
  
  document.getElementById('deliveryCity').value = city;
  document.getElementById('deliveryCountry').value = country;
  if (postalCode) document.getElementById('postalCode').value = postalCode;
  
  userCity = city;
  userCountry = country;
  userPostalCode = postalCode;
  verifiedAddress = place.formatted_address;
  verifiedCoordinates = {
    lat: place.geometry.location.lat(),
    lng: place.geometry.location.lng()
  };
  
  // Detect country for payment gateway
  detectCountryFromAddress(country);
  
  showNotification('‚úÖ Address verified successfully!');
}

function detectUserCountry() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const latlng = { lat: position.coords.latitude, lng: position.coords.longitude };
      
      geocoder.geocode({ location: latlng }, (results, status) => {
        if (status === 'OK' && results[0]) {
          extractAddressComponents({ address_components: results[0].address_components });
        }
      });
    }, () => {
      // Fallback to IP-based detection
      fetch('https://ipapi.co/json/')
        .then(response => response.json())
        .then(data => {
          userCountry = data.country_name;
          userCity = data.city;
          document.getElementById('deliveryCity').value = data.city || '';
          document.getElementById('deliveryCountry').value = data.country_name || '';
          detectCountryFromAddress(data.country_name);
        })
        .catch(() => {
          document.getElementById('countryDetectionBadge').innerHTML = `
            <div class="country-detection-badge">
              <i class="fas fa-globe"></i>
              <span>Unable to detect location. Please enter your address.</span>
            </div>
          `;
        });
    });
  }
}

function detectCountryFromAddress(country) {
  userCountry = country;
  const badge = document.getElementById('countryDetectionBadge');
  
  let flag = 'üåç';
  let paymentMethod = 'Stripe';
  let isCOD = true;
  
  if (country.includes('Pakistan')) {
    flag = 'üáµüá∞';
    paymentMethod = 'JazzCash/EasyPaisa';
    isCOD = true;
  } else if (country.includes('India')) {
    flag = 'üáÆüá≥';
    paymentMethod = 'Razorpay';
    isCOD = true;
  } else if (country.includes('Bangladesh')) {
    flag = 'üáßüá©';
    paymentMethod = 'SSLCommerz';
    isCOD = true;
  } else {
    flag = 'üåç';
    paymentMethod = 'Stripe';
    isCOD = country.includes('United States') || country.includes('United Kingdom') || country.includes('Canada') || country.includes('Australia') || country.includes('Europe');
  }
  
  badge.innerHTML = `
    <div class="country-detection-badge">
      <span>${flag}</span>
      <span>Detected: ${country || 'Unknown'} ‚Ä¢ Recommended: ${paymentMethod}</span>
      ${isCOD ? '<span class="cod-badge" style="margin-left: 10px;"><i class="fas fa-check"></i> COD Available</span>' : ''}
    </div>
  `;
  
  document.getElementById('codAvailabilityBadge').style.display = isCOD ? 'inline-flex' : 'none';
}

function verifyPostalCode() {
  const postalCode = document.getElementById('postalCode').value;
  if (!postalCode) {
    showNotification('‚ùå Please enter postal code');
    return;
  }
  
  const statusDiv = document.getElementById('postalCodeStatus');
  statusDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
  
  // Simulate postal code verification (in production, use actual postal code API)
  setTimeout(() => {
    if (postalCode.length >= 4) {
      statusDiv.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> Postal code verified. Delivery available.';
      userPostalCode = postalCode;
    } else {
      statusDiv.innerHTML = '<i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i> Please enter a valid postal code.';
    }
  }, 1000);
}

function saveDeliveryAddress() {
  if (!verifiedAddress) {
    showNotification('‚ùå Please verify your address first');
    return;
  }
  
  if (!document.getElementById('houseNumber').value) {
    showNotification('‚ùå Please enter house/building number');
    return;
  }
  
  showNotification('‚úÖ Address saved! Calculating delivery options...');
  
  // Calculate distance from business
  calculateDeliveryDistance();
  
  // Show delivery calculator section
  document.getElementById('deliveryCalculatorSection').style.display = 'block';
  
  // Scroll to delivery options
  document.getElementById('deliveryCalculatorSection').scrollIntoView({ behavior: 'smooth' });
}

function calculateDeliveryDistance() {
  if (!verifiedCoordinates) {
    document.getElementById('deliveryDistanceInfo').innerHTML = `
      <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
      <span>Unable to calculate distance. Please verify your address.</span>
    `;
    return;
  }
  
  // Calculate distance using Haversine formula
  const R = 6371; // Earth's radius in km
  const dLat = (verifiedCoordinates.lat - businessLocation.lat) * Math.PI / 180;
  const dLon = (verifiedCoordinates.lng - businessLocation.lng) * Math.PI / 180;
  const a = 
    Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(businessLocation.lat * Math.PI / 180) * Math.cos(verifiedCoordinates.lat * Math.PI / 180) * 
    Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  deliveryDistance = Math.round(R * c * 10) / 10;
  
  document.getElementById('deliveryDistanceInfo').innerHTML = `
    <i class="fas fa-location-arrow"></i>
    <span>Distance from business: <strong>${deliveryDistance} km</strong></span>
  `;
  
  // Generate delivery options based on distance and country
  generateDeliveryOptions();
}

function generateDeliveryOptions() {
  const optionsList = document.getElementById('deliveryOptionsList');
  
  let standardRate = 0;
  let expressRate = 0;
  let internationalRate = 0;
  
  // Calculate delivery rates based on country and distance
  if (userCountry && userCountry.includes('Pakistan')) {
    standardRate = deliveryDistance <= 10 ? 150 : 150 + (deliveryDistance - 10) * 10;
    expressRate = deliveryDistance <= 10 ? 250 : 250 + (deliveryDistance - 10) * 15;
  } else if (userCountry && userCountry.includes('India')) {
    standardRate = deliveryDistance <= 10 ? 100 : 100 + (deliveryDistance - 10) * 8;
    expressRate = deliveryDistance <= 10 ? 200 : 200 + (deliveryDistance - 10) * 12;
  } else if (userCountry && userCountry.includes('Bangladesh')) {
    standardRate = deliveryDistance <= 10 ? 120 : 120 + (deliveryDistance - 10) * 9;
    expressRate = deliveryDistance <= 10 ? 220 : 220 + (deliveryDistance - 10) * 13;
  } else {
    // International
    standardRate = 500 + deliveryDistance * 20;
    expressRate = 1000 + deliveryDistance * 30;
    internationalRate = 1500 + deliveryDistance * 40;
  }
  
  let html = '';
  
  // Standard Delivery
  html += `
    <div class="delivery-option" onclick="selectDeliveryOption('standard', ${standardRate}, '3-5 days')">
      <div class="delivery-option-info">
        <div class="delivery-option-icon standard">
          <i class="fas fa-truck"></i>
        </div>
        <div class="delivery-option-details">
          <div class="delivery-option-name">Standard Delivery</div>
          <div class="delivery-option-time">
            <i class="fas fa-clock"></i> 3-5 business days
          </div>
        </div>
      </div>
      <div class="delivery-option-price">PKR ${standardRate}</div>
    </div>
  `;
  
  // Express Delivery
  html += `
    <div class="delivery-option" onclick="selectDeliveryOption('express', ${expressRate}, '1-2 days')">
      <div class="delivery-option-info">
        <div class="delivery-option-icon express">
          <i class="fas fa-bolt"></i>
        </div>
        <div class="delivery-option-details">
          <div class="delivery-option-name">Express Delivery</div>
          <div class="delivery-option-time">
            <i class="fas fa-clock"></i> 1-2 business days
          </div>
        </div>
      </div>
      <div class="delivery-option-price">PKR ${expressRate}</div>
    </div>
  `;
  
  // International Delivery (if applicable)
  if (deliveryDistance > 100 || !userCountry || (!userCountry.includes('Pakistan') && !userCountry.includes('India') && !userCountry.includes('Bangladesh'))) {
    html += `
      <div class="delivery-option" onclick="selectDeliveryOption('international', ${internationalRate}, '7-10 days')">
        <div class="delivery-option-info">
          <div class="delivery-option-icon international">
            <i class="fas fa-globe"></i>
          </div>
          <div class="delivery-option-details">
            <div class="delivery-option-name">International Shipping</div>
            <div class="delivery-option-time">
              <i class="fas fa-clock"></i> 7-10 business days
            </div>
          </div>
        </div>
        <div class="delivery-option-price">PKR ${internationalRate}</div>
      </div>
    `;
  }
  
  optionsList.innerHTML = html;
}

function selectDeliveryOption(type, price, time) {
  // Remove selected class from all options
  document.querySelectorAll('.delivery-option').forEach(opt => {
    opt.classList.remove('selected');
  });
  
  // Add selected class to clicked option
  event.currentTarget.classList.add('selected');
  
  selectedDeliveryOption = {
    type: type,
    price: price,
    time: time
  };
  
  showNotification(`‚úÖ ${type.charAt(0).toUpperCase() + type.slice(1)} delivery selected`);
}

function proceedToPaymentGateway() {
  if (!selectedDeliveryOption) {
    showNotification('‚ùå Please select a delivery option');
    return;
  }
  
  // Show payment gateway section
  document.getElementById('paymentGatewaySection').style.display = 'block';
  
  // Load payment gateway options based on country
  loadPaymentGateways();
  
  // Update order summary
  updateCheckoutOrderSummary();
  
  // Scroll to payment section
  document.getElementById('paymentGatewaySection').scrollIntoView({ behavior: 'smooth' });
}

function loadPaymentGateways() {
  const tabs = document.getElementById('paymentGatewayTabs');
  const content = document.getElementById('paymentGatewayContent');
  
  let tabsHtml = '';
  let contentHtml = '';
  
  // Always show COD if available
  if (userCountry && (userCountry.includes('Pakistan') || userCountry.includes('India') || userCountry.includes('Bangladesh'))) {
    tabsHtml += `
      <div class="payment-gateway-tab active" onclick="selectPaymentGateway('cod')">
        <i class="fas fa-truck"></i> Cash on Delivery
      </div>
    `;
    
    contentHtml = `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; color: #10b981; margin-bottom: 20px;">
          <i class="fas fa-truck"></i>
        </div>
        <h3 style="font-size: 20px; font-weight: 800; color: var(--dark-color); margin-bottom: 15px;">
          Cash on Delivery
        </h3>
        <p style="color: #64748b; margin-bottom: 20px;">
          Pay when you receive your order. No advance payment required.
        </p>
        <div style="background: #f0fdf4; padding: 15px; border-radius: 12px; margin: 20px 0;">
          <i class="fas fa-info-circle" style="color: #10b981;"></i>
          <span style="color: #065f46; font-size: 14px;">Please keep exact change ready at time of delivery.</span>
        </div>
        <button onclick="processCODOrder()" class="checkout-btn" style="margin: 10px 0 0 0;">
          <i class="fas fa-check-circle"></i> Place Order (COD)
        </button>
      </div>
    `;
  }
  
  // Stripe (US/EU)
  if (PAYMENT_CONFIG.stripe.enabled && (!userCountry || 
      userCountry.includes('United States') || userCountry.includes('United Kingdom') || 
      userCountry.includes('Canada') || userCountry.includes('Australia') || 
      userCountry.includes('Germany') || userCountry.includes('France'))) {
    tabsHtml += `
      <div class="payment-gateway-tab" onclick="selectPaymentGateway('stripe')">
        <i class="fab fa-stripe"></i> Stripe
      </div>
    `;
  }
  
  // Razorpay (India)
  if (PAYMENT_CONFIG.razorpay.enabled && userCountry && userCountry.includes('India')) {
    tabsHtml += `
      <div class="payment-gateway-tab" onclick="selectPaymentGateway('razorpay')">
        <i class="fas fa-indian-rupee-sign"></i> Razorpay
      </div>
    `;
  }
  
  // SSLCommerz (Bangladesh)
  if (PAYMENT_CONFIG.sslcommerz.enabled && userCountry && userCountry.includes('Bangladesh')) {
    tabsHtml += `
      <div class="payment-gateway-tab" onclick="selectPaymentGateway('sslcommerz')">
        <i class="fas fa-bangladeshi-taka-sign"></i> SSLCommerz
      </div>
    `;
  }
  
  tabs.innerHTML = tabsHtml;
  
  // Set default gateway
  if (userCountry) {
    if (userCountry.includes('India')) selectPaymentGateway('razorpay');
    else if (userCountry.includes('Bangladesh')) selectPaymentGateway('sslcommerz');
    else if (userCountry.includes('Pakistan')) selectPaymentGateway('cod');
    else selectPaymentGateway('stripe');
  } else {
    selectPaymentGateway('cod');
  }
}

function selectPaymentGateway(gateway) {
  selectedPaymentGateway = gateway;
  
  // Update active tab
  document.querySelectorAll('.payment-gateway-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.currentTarget.classList.add('active');
  
  // Load gateway content
  const content = document.getElementById('paymentGatewayContent');
  
  if (gateway === 'stripe') {
    content.innerHTML = `
      <div style="text-align: center; padding: 10px;">
        <div style="font-size: 48px; color: #6772e5; margin-bottom: 20px;">
          <i class="fab fa-stripe"></i>
        </div>
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color); margin-bottom: 20px;">
          Pay with Credit/Debit Card
        </h3>
        <div class="stripe-element" id="stripe-card-element">
          <!-- Stripe Elements will be inserted here -->
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="fas fa-credit-card" style="color: #94a3b8;"></i>
            <span style="color: #64748b;">Card Number</span>
          </div>
        </div>
        <button onclick="processStripePayment()" class="checkout-btn" style="margin: 20px 0 0 0;">
          <i class="fas fa-lock"></i> Pay Securely
        </button>
        <p style="color: #94a3b8; font-size: 12px; margin-top: 15px;">
          <i class="fas fa-shield-alt"></i> Your payment information is encrypted
        </p>
      </div>
    `;
  } else if (gateway === 'razorpay') {
    content.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; color: #1e88e5; margin-bottom: 20px;">
          <i class="fas fa-indian-rupee-sign"></i>
        </div>
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color); margin-bottom: 15px;">
          Pay with Razorpay
        </h3>
        <p style="color: #64748b; margin-bottom: 25px;">
          UPI, Credit Card, Debit Card, Net Banking, Wallet
        </p>
        <button onclick="processRazorpayPayment()" class="razorpay-button">
          <i class="fas fa-lock"></i> Pay with Razorpay
        </button>
      </div>
    `;
  } else if (gateway === 'sslcommerz') {
    content.innerHTML = `
      <div style="text-align: center; padding: 20px;">
        <div style="font-size: 48px; color: #e31b23; margin-bottom: 20px;">
          <i class="fas fa-bangladeshi-taka-sign"></i>
        </div>
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color); margin-bottom: 15px;">
          Pay with SSLCommerz
        </h3>
        <p style="color: #64748b; margin-bottom: 25px;">
          bKash, Rocket, Nagad, Credit Card, Mobile Banking
        </p>
        <button onclick="processSSLCommerzPayment()" class="sslcommerz-button">
          <i class="fas fa-lock"></i> Pay with SSLCommerz
        </button>
      </div>
    `;
  }
}

function updateCheckoutOrderSummary() {
  const summaryDiv = document.getElementById('checkoutOrderSummary');
  
  let subtotal = 0;
  let itemsHtml = '';
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    subtotal += itemTotal;
    
    itemsHtml += `
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #e2e8f0;">
        <div style="flex: 1;">
          <div style="font-weight: 600; color: var(--dark-color); font-size: 14px;">${item.title || 'Product'}</div>
          <div style="font-size: 12px; color: #64748b;">Qty: ${item.quantity || 1}</div>
        </div>
        <div style="font-weight: 700; color: var(--dark-color);">PKR ${itemTotal.toFixed(2)}</div>
      </div>
    `;
  });
  
  const deliveryCharge = selectedDeliveryOption ? selectedDeliveryOption.price : 0;
  const total = subtotal + deliveryCharge;
  
  summaryDiv.innerHTML = `
    <div style="margin-bottom: 15px;">
      ${itemsHtml}
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      <span style="color: #64748b;">Subtotal</span>
      <span style="font-weight: 700; color: var(--dark-color);">PKR ${subtotal.toFixed(2)}</span>
    </div>
    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
      <span style="color: #64748b;">Delivery Charges</span>
      <span style="font-weight: 700; color: var(--dark-color);">PKR ${deliveryCharge.toFixed(2)}</span>
    </div>
  `;
  
  document.getElementById('checkoutGrandTotal').textContent = `PKR ${total.toFixed(2)}`;
}

function processCODOrder() {
  if (!selectedDeliveryOption) {
    showNotification('‚ùå Please select delivery option');
    return;
  }
  
  if (!verifiedAddress) {
    showNotification('‚ùå Please verify your address');
    return;
  }
  
  const orderId = generateOrderId();
  const subtotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  const total = subtotal + selectedDeliveryOption.price;
  
  const orderData = {
    order_id: orderId,
    customer_phone: getCustomerPhone() || '',
    customer_name: customerData.name || 'Customer',
    address: verifiedAddress,
    city: userCity,
    country: userCountry,
    postal_code: userPostalCode,
    items: cart.map(item => ({
      title: item.title,
      price: item.discountPrice || item.originalPrice,
      quantity: item.quantity || 1
    })),
    subtotal: subtotal,
    delivery_charge: selectedDeliveryOption.price,
    total: total,
    delivery_type: selectedDeliveryOption.type,
    delivery_time: selectedDeliveryOption.time,
    payment_method: 'cod',
    status: 'pending',
    order_date: new Date().toISOString(),
    last_updated: new Date().toISOString()
  };
  
  // Save order to Supabase
  saveOrderToDatabase(orderData);
  
  // Create delivery status
  createDeliveryStatus(orderData);
  
  // Show success message
  showNotification('‚úÖ Order placed successfully! Your order ID: ' + orderId);
  
  // Add notification
  addInnerNotification('Order Placed', `Order #${orderId} placed successfully. Total: PKR ${total.toFixed(2)}`, 'success');
  
  // Clear cart
  cart = [];
  updateCartCount();
  
  // Navigate to order tracking
  activeOrder = orderData;
  navigateTo('orderTrackingPage');
}

function processStripePayment() {
  showNotification('‚úÖ Stripe payment processed successfully!');
  processCODOrder(); // For demo, just process as COD
}

function processRazorpayPayment() {
  const options = {
    key: PAYMENT_CONFIG.razorpay.keyId,
    amount: calculateTotal() * 100,
    currency: 'INR',
    name: card.businessName || card.name || 'Business',
    description: 'Order Payment',
    handler: function(response) {
      showNotification('‚úÖ Payment successful! Payment ID: ' + response.razorpay_payment_id);
      processCODOrder(); // For demo
    },
    prefill: {
      name: customerData.name || '',
      email: customerData.email || '',
      contact: getCustomerPhone() || ''
    },
    theme: { color: '#667eea' }
  };
  
  const razorpay = new Razorpay(options);
  razorpay.open();
}

function processSSLCommerzPayment() {
  showNotification('‚úÖ SSLCommerz payment initiated');
  processCODOrder(); // For demo
}

function generateOrderId() {
  const timestamp = Date.now().toString().slice(-6);
  const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
  return `ORD${timestamp}${random}`;
}

async function saveOrderToDatabase(orderData) {
  try {
    const { error } = await supa
      .from('orders')
      .insert([{
        order_id: orderData.order_id,
        business_id: currentBusinessId,
        customer_device_id: customerData.deviceId,
        customer_phone: orderData.customer_phone,
        customer_name: orderData.customer_name,
        address: orderData.address,
        city: orderData.city,
        country: orderData.country,
        postal_code: orderData.postal_code,
        items: orderData.items,
        subtotal: orderData.subtotal,
        delivery_charge: orderData.delivery_charge,
        total: orderData.total,
        delivery_type: orderData.delivery_type,
        payment_method: orderData.payment_method,
        status: orderData.status,
        order_date: orderData.order_date,
        last_updated: orderData.last_updated
      }]);
      
    if (!error) {
      console.log('Order saved to database:', orderData.order_id);
    }
  } catch (error) {
    console.log('Error saving order:', error);
  }
}

async function createDeliveryStatus(orderData) {
  const trackingNumber = generateTrackingNumber();
  
  try {
    const { error } = await supa
      .from('delivery_status')
      .insert([{
        order_id: orderData.order_id,
        customer_phone: orderData.customer_phone,
        customer_name: orderData.customer_name,
        tracking_number: trackingNumber,
        status: 'pending',
        location: orderData.address,
        delivery_person: '',
        estimated_delivery: calculateEstimatedDelivery(orderData.delivery_time),
        last_updated: new Date().toISOString()
      }]);
      
    if (!error) {
      console.log('Delivery status created for order:', orderData.order_id);
    }
  } catch (error) {
    console.log('Error creating delivery status:', error);
  }
}

function generateTrackingNumber() {
  const prefix = 'TRK';
  const timestamp = Date.now().toString().slice(-8);
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `${prefix}${timestamp}${random}`;
}

function calculateEstimatedDelivery(deliveryTime) {
  const days = parseInt(deliveryTime.split('-')[0]);
  const date = new Date();
  date.setDate(date.getDate() + days);
  return date.toISOString();
}

function calculateTotal() {
  const subtotal = cart.reduce((sum, item) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    return sum + (price * (item.quantity || 1));
  }, 0);
  
  const deliveryCharge = selectedDeliveryOption ? selectedDeliveryOption.price : 0;
  return subtotal + deliveryCharge;
}

function loadOrderTracking(orderData) {
  const content = document.getElementById('orderTrackingContent');
  
  const orderDate = new Date(orderData.order_date).toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
  
  let timelineHtml = '';
  
  const statuses = [
    { status: 'pending', title: 'Order Placed', icon: 'fas fa-check-circle' },
    { status: 'processing', title: 'Order Confirmed', icon: 'fas fa-check-circle' },
    { status: 'shipped', title: 'Shipped', icon: 'fas fa-truck' },
    { status: 'delivered', title: 'Delivered', icon: 'fas fa-home' }
  ];
  
  let currentStatusIndex = 0;
  if (orderData.status === 'pending') currentStatusIndex = 0;
  else if (orderData.status === 'processing') currentStatusIndex = 1;
  else if (orderData.status === 'shipped') currentStatusIndex = 2;
  else if (orderData.status === 'delivered') currentStatusIndex = 3;
  
  statuses.forEach((status, index) => {
    const isCompleted = index < currentStatusIndex;
    const isActive = index === currentStatusIndex;
    
    timelineHtml += `
      <div class="timeline-item ${isCompleted ? 'completed' : ''} ${isActive ? 'active' : ''}">
        <div class="timeline-icon">
          <i class="${status.icon}"></i>
        </div>
        <div class="timeline-content">
          <div class="timeline-title">${status.title}</div>
          <div class="timeline-time">
            <i class="fas fa-clock"></i>
            ${isCompleted ? orderDate : isActive ? 'In Progress' : 'Pending'}
          </div>
        </div>
      </div>
    `;
  });
  
  content.innerHTML = `
    <div class="order-tracking-card">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color);">
          <i class="fas fa-box"></i> Order #${orderData.order_id}
        </h3>
        <span class="delivery-status ${orderData.status}">
          ${orderData.status.charAt(0).toUpperCase() + orderData.status.slice(1)}
        </span>
      </div>
      
      <div class="tracking-number-box">
        <div style="font-size: 14px; opacity: 0.9; margin-bottom: 5px;">
          <i class="fas fa-barcode"></i> Tracking Number
        </div>
        <div class="tracking-number">${orderData.tracking_number || 'TRK' + orderData.order_id.slice(-8)}</div>
      </div>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin: 20px 0;">
        <div style="display: flex; gap: 15px; align-items: center;">
          <div style="background: #667eea; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
            <i class="fas fa-map-marker-alt"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Delivery Address</div>
            <div style="font-size: 14px; font-weight: 600; color: var(--dark-color);">${orderData.address || verifiedAddress}</div>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">${orderData.city || ''}, ${orderData.country || ''} - ${orderData.postal_code || ''}</div>
          </div>
        </div>
      </div>
      
      <div style="background: #f8fafc; padding: 15px; border-radius: 12px; margin: 20px 0;">
        <div style="display: flex; gap: 15px; align-items: center;">
          <div style="background: #10b981; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white;">
            <i class="fas fa-truck"></i>
          </div>
          <div style="flex: 1;">
            <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">Delivery Method</div>
            <div style="font-size: 14px; font-weight: 600; color: var(--dark-color);">${orderData.delivery_type?.charAt(0).toUpperCase() + orderData.delivery_type?.slice(1) || 'Standard'} Delivery</div>
            <div style="font-size: 12px; color: #64748b; margin-top: 4px;">Estimated: ${orderData.delivery_time || '3-5 days'}</div>
          </div>
        </div>
      </div>
      
      <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 15px; border-radius: 12px; margin: 20px 0; display: flex; align-items: center; gap: 15px;">
        <div style="font-size: 32px;">
          <i class="fas fa-headset"></i>
        </div>
        <div style="flex: 1;">
          <div style="font-size: 14px; font-weight: 700; margin-bottom: 4px;">Need help with your order?</div>
          <div style="font-size: 12px; opacity: 0.9;">Contact our support team</div>
        </div>
        <button onclick="openWhatsAppChat('order')" style="background: white; color: #d97706; border: none; border-radius: 8px; padding: 10px 18px; font-weight: 700; font-size: 13px; cursor: pointer;">
          <i class="fab fa-whatsapp"></i> Chat
        </button>
      </div>
      
      <h4 style="font-size: 16px; font-weight: 800; color: var(--dark-color); margin: 25px 0 15px 0;">
        <i class="fas fa-clock"></i> Order Timeline
      </h4>
      
      <div class="order-timeline">
        ${timelineHtml}
      </div>
    </div>
  `;
}

function loadDeliveryPartners() {
  const content = document.getElementById('deliveryPartnerContent');
  
  let partnersHtml = '<div class="delivery-partner-section">';
  partnersHtml += '<h3 style="font-size: 18px; font-weight: 800; color: var(--dark-color); margin-bottom: 20px;">Select Delivery Partner</h3>';
  
  const partners = [
    { id: 'leopards', name: 'Leopards Courier', rating: 4.5, deliveries: '50K+', time: '2-3 days' },
    { id: 'tcs', name: 'TCS Express', rating: 4.8, deliveries: '100K+', time: '1-2 days' },
    { id: 'fedex', name: 'FedEx', rating: 4.9, deliveries: '1M+', time: '1-3 days' },
    { id: 'dhl', name: 'DHL Express', rating: 4.9, deliveries: '1M+', time: '1-2 days' },
    { id: 'blueEx', name: 'BlueEX', rating: 4.6, deliveries: '75K+', time: '2-3 days' }
  ];
  
  partners.forEach(partner => {
    partnersHtml += `
      <div class="partner-card" onclick="selectDeliveryPartner('${partner.id}')">
        <div class="partner-logo">${partner.name.charAt(0)}</div>
        <div class="partner-info">
          <div class="partner-name">${partner.name}</div>
          <div class="partner-rating">
            <i class="fas fa-star"></i> ${partner.rating} ‚Ä¢ ${partner.deliveries} deliveries
          </div>
          <div style="font-size: 12px; color: #64748b;">
            <i class="fas fa-clock"></i> Estimated: ${partner.time}
          </div>
        </div>
        <button class="partner-tracking-btn" onclick="event.stopPropagation(); trackWithPartner('${partner.id}')">
          <i class="fas fa-truck"></i> Track
        </button>
      </div>
    `;
  });
  
  partnersHtml += '</div>';
  
  content.innerHTML = partnersHtml;
}

function selectDeliveryPartner(partnerId) {
  showNotification(`‚úÖ ${partnerId.charAt(0).toUpperCase() + partnerId.slice(1)} selected as delivery partner`);
}

function trackWithPartner(partnerId) {
  if (activeOrder) {
    showNotification(`üîç Tracking order with ${partnerId.charAt(0).toUpperCase() + partnerId.slice(1)}...`);
    // In production, integrate with partner's tracking API
  } else {
    showNotification('‚ùå No active order to track');
  }
}

// ===== DELIVERY SYSTEM FUNCTIONS =====
async function checkForDeliveries() {
  try {
    const customerPhone = getCustomerPhone();
    
    if(!customerPhone) {
      updateDeliveryIcon();
      return;
    }
    
    const { data, error } = await supa
      .from('delivery_status')
      .select('*')
      .eq('customer_phone', customerPhone)
      .order('last_updated', { ascending: false });
      
    if(error) {
      console.error('Delivery check error:', error);
      updateDeliveryIcon();
      return;
    }
    
    if(data && data.length > 0) {
      const oldDeliveryData = deliveryStatusData;
      deliveryStatusData = data;
      
      data.forEach(newDelivery => {
        const oldDelivery = oldDeliveryData.find(d => d.order_id === newDelivery.order_id);
        
        if (!oldDelivery) {
          addDeliveryNotification(newDelivery);
        } else if (oldDelivery.status !== newDelivery.status) {
          addDeliveryNotification(newDelivery);
        }
      });
      
      updateDeliveryIcon();
      
      const pendingOrders = data.filter(order => order.status === 'pending');
      if (pendingOrders.length > 0) {
        showNotification(`üöö You have ${pendingOrders.length} pending delivery${pendingOrders.length > 1 ? 's' : ''}`);
      }
    } else {
      deliveryStatusData = [];
      updateDeliveryIcon();
    }
  } catch(err) {
    console.log('Delivery check failed:', err);
    updateDeliveryIcon();
  }
}

function updateDeliveryIcon() {
  const icon = document.getElementById('deliveryIcon');
  const badge = document.getElementById('deliveryBadge');
  
  if(deliveryStatusData.length > 0) {
    icon.style.color = '#10b981';
    badge.textContent = deliveryStatusData.length;
    badge.style.display = 'flex';
    
    const hasPending = deliveryStatusData.some(order => order.status === 'pending');
    if (hasPending) badge.classList.add('alert');
    else badge.classList.remove('alert');
  } else {
    icon.style.color = 'white';
    badge.style.display = 'none';
    badge.classList.remove('alert');
  }
}

function checkDeliveryStatus() {
  const customerPhone = getCustomerPhone();
  
  if(!customerPhone) {
    openPhoneInput();
    showNotification('Please add your phone number to track deliveries');
    return;
  }
  
  navigateTo('deliveryPage');
}

async function loadDeliveryStatus() {
  const phone = getCustomerPhone();
  
  if(!phone) {
    document.getElementById('deliveryContent').innerHTML = `
      <div class="no-deliveries">
        <i class="fas fa-phone"></i>
        <h3>Phone Number Needed</h3>
        <p>Please save your phone number to track deliveries.</p>
        <button onclick="openPhoneInput()" style="padding:12px 30px;background:var(--primary-gradient);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">
          Add Phone Number
        </button>
      </div>
    `;
    return;
  }
  
  const { data, error } = await supa
    .from('delivery_status')
    .select('*')
    .eq('customer_phone', phone)
    .order('last_updated', { ascending: false });
    
  if(error) {
    document.getElementById('deliveryContent').innerHTML = `
      <div style="text-align:center;padding:40px;color:#ef4444;">
        <i class="fas fa-exclamation-triangle"></i>
        <p>Error loading deliveries</p>
        <button onclick="loadDeliveryStatus()" style="margin-top:15px;padding:10px 20px;background:#667eea;color:white;border:none;border-radius:8px;cursor:pointer;">
          Try Again
        </button>
      </div>
    `;
    return;
  }
  
  if(!data || data.length === 0) {
    document.getElementById('deliveryContent').innerHTML = `
      <div class="no-deliveries">
        <i class="fas fa-truck" style="color:#10b981;"></i>
        <h3>No Active Deliveries</h3>
        <p>Your delivery status will appear here once you place an order.</p>
        <button onclick="navigateTo('productsPage')" style="padding:12px 30px;background:var(--primary-gradient);color:white;border:none;border-radius:12px;font-weight:700;cursor:pointer;">
          <i class="fas fa-shopping-bag"></i> Shop Now
        </button>
      </div>
    `;
    return;
  }
  
  let html = '';
  data.forEach(order => {
    const statusClass = order.status;
    const statusText = order.status.charAt(0).toUpperCase() + order.status.slice(1);
    const updatedTime = new Date(order.last_updated).toLocaleString();
    
    html += `
      <div class="delivery-card ${statusClass}" onclick="viewOrderDetails('${order.order_id}')">
        <div class="delivery-header">
          <div class="delivery-order-id">Order #${order.order_id}</div>
          <div class="delivery-status ${statusClass}">${statusText}</div>
        </div>
        
        <div class="delivery-info">
          <i class="fas fa-user"></i>
          <span>${order.customer_name || 'Customer'}</span>
        </div>
        
        <div class="delivery-info">
          <i class="fas fa-map-marker-alt"></i>
          <span>${order.location || 'Address pending'}</span>
        </div>
        
        ${order.tracking_number ? `
          <div class="delivery-info">
            <i class="fas fa-barcode"></i>
            <span>Tracking: ${order.tracking_number}</span>
          </div>
        ` : ''}
        
        <div class="delivery-timestamp">
          <i class="fas fa-clock"></i>
          <span>Updated: ${updatedTime}</span>
        </div>
      </div>
    `;
  });
  
  document.getElementById('deliveryContent').innerHTML = html;
}

function viewOrderDetails(orderId) {
  const order = deliveryStatusData.find(o => o.order_id === orderId);
  if (order) {
    activeOrder = order;
    navigateTo('orderTrackingPage');
  }
}

// ===== CUSTOMER PHONE FUNCTIONS =====
function openPhoneInput() {
  const currentPhone = getCustomerPhone();
  const phone = prompt("Enter your phone number for delivery tracking:", currentPhone || "");
  
  if (phone) {
    const cleanedPhone = phone.replace(/\D/g, '');
    if (cleanedPhone.length >= 10) {
      saveCustomerPhone(cleanedPhone);
      updateCustomerPhoneDisplay();
      showNotification('‚úÖ Phone number saved successfully!');
      addInnerNotification('Phone Number Saved', 'Your phone number has been saved for delivery tracking', 'success');
      checkForDeliveries();
      if (currentPage === 'deliveryPage') loadDeliveryStatus();
    } else {
      showNotification('‚ùå Please enter a valid phone number');
    }
  }
}

function updateCustomerPhoneDisplay() {
  const phone = getCustomerPhone();
  const displayElement = document.getElementById('customerPhoneDisplay');
  
  if (phone) {
    displayElement.textContent = phone;
    displayElement.style.color = '#10b981';
    displayElement.style.fontWeight = '800';
  } else {
    displayElement.textContent = 'Tap to set your number';
    displayElement.style.color = '';
    displayElement.style.fontWeight = '';
  }
}

// ===== LOGIN/LOGOUT SYSTEM =====
function toggleLogin() {
  if (isAdminLoggedIn) {
    if (confirm("Are you sure you want to logout?")) logoutAdmin();
  } else {
    navigateTo('loginPage');
  }
}

function updateLoginUI() {
  const loginIcon = document.getElementById('loginIcon');
  const loginBtn = document.getElementById('loginBtn');
  
  if (isAdminLoggedIn) {
    loginIcon.className = 'fas fa-sign-out-alt';
    loginBtn.title = 'Logout';
  } else {
    loginIcon.className = 'fas fa-sign-in-alt';
    loginBtn.title = 'Login';
  }
}

function attemptLogin() {
  const passwordInput = document.getElementById('adminPasswordInput');
  const enteredPassword = passwordInput.value;
  
  if (enteredPassword === businessAdminPassword) {
    isAdminLoggedIn = true;
    isolatedLocalStorage.setItem('isAdminLoggedIn', 'true');
    updateLoginUI();
    showNotification('‚úÖ Login successful!');
    addInnerNotification('Admin Login', 'You have logged in as administrator', 'success');
    navigateTo('adminPage');
  } else {
    showNotification('‚ùå Incorrect password. Try again.');
    passwordInput.value = '';
    passwordInput.focus();
  }
}

function handleLoginKeypress(event) {
  if (event.key === 'Enter') attemptLogin();
}

function logoutAdmin() {
  isAdminLoggedIn = false;
  isolatedLocalStorage.removeItem('isAdminLoggedIn');
  updateLoginUI();
  showNotification('üëã Logged out successfully');
  addInnerNotification('Logged Out', 'You have been logged out from admin panel', 'info');
  navigateTo('homePage');
}

// ===== ADMIN FUNCTIONS =====
async function loadAdminPanel() {
  const { data, error } = await supa
    .from('delivery_status')
    .select('*')
    .order('last_updated', { ascending: false });
    
  if(error || !data) {
    document.getElementById('adminContent').innerHTML = '<p style="padding:20px;color:#ef4444;">Error loading data</p>';
    return;
  }
  
  let html = `
    <div style="padding: 15px; display: flex; justify-content: flex-end;">
      <button onclick="logoutAdmin()" class="logout-btn">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
    
    <input type="text" class="admin-search" id="adminSearch" placeholder="Search orders by ID, phone, name..." onkeyup="searchAdminOrders()">
    
    <div style="margin: 15px; display: flex; gap: 10px;">
      <button onclick="sendNotificationToAll()" style="flex:1;padding:12px;background:var(--warning-gradient);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">
        <i class="fas fa-bell"></i> Send Alert to All
      </button>
      <button onclick="testNotification()" style="flex:1;padding:12px;background:var(--info-gradient);color:white;border:none;border-radius:8px;font-weight:700;cursor:pointer;">
        <i class="fas fa-bell"></i> Test Alert
      </button>
    </div>
    
    <button onclick="addNewOrder()" class="admin-btn">
      <i class="fas fa-plus"></i> Add New Order
    </button>
  `;
  
  if(data.length === 0) {
    html += '<p style="text-align:center;padding:40px;color:#64748b;">No orders found</p>';
  } else {
    data.forEach(order => {
      const statusClass = order.status;
      const updatedTime = new Date(order.last_updated).toLocaleString();
      
      html += `
        <div class="admin-order-card" data-order-id="${order.order_id}" data-phone="${order.customer_phone}">
          <div class="admin-order-header">
            <div>
              <div class="admin-order-id">Order #${order.order_id}</div>
              <div class="admin-customer-info">${order.customer_name || 'No name'}</div>
              <div class="admin-customer-info">${order.customer_phone}</div>
              ${order.tracking_number ? `<div class="admin-customer-info">Tracking: ${order.tracking_number}</div>` : ''}
            </div>
            <div style="font-size:12px;color:#94a3b8;">${updatedTime}</div>
          </div>
          
          <select class="admin-select" data-id="${order.id}">
            <option value="pending" ${statusClass === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
            <option value="processing" ${statusClass === 'processing' ? 'selected' : ''}>üîÑ Processing</option>
            <option value="shipped" ${statusClass === 'shipped' ? 'selected' : ''}>üöö Shipped</option>
            <option value="delivered" ${statusClass === 'delivered' ? 'selected' : ''}>‚úÖ Delivered</option>
            <option value="cancelled" ${statusClass === 'cancelled' ? 'selected' : ''}>‚ùå Cancelled</option>
          </select>
          
          <input type="text" class="admin-input" data-id="${order.id}" 
                 placeholder="Location" value="${order.location || ''}">
                 
          <input type="text" class="admin-input" data-id="${order.id}" 
                 placeholder="Delivery Person" value="${order.delivery_person || ''}">
                 
          <button onclick="updateOrder('${order.id}')" class="admin-btn success">
            Update Order
          </button>
        </div>
      `;
    });
  }
  
  document.getElementById('adminContent').innerHTML = html;
}

function searchAdminOrders() {
  const searchTerm = document.getElementById('adminSearch').value.toLowerCase();
  const cards = document.querySelectorAll('.admin-order-card');
  
  cards.forEach(card => {
    const orderId = card.getAttribute('data-order-id').toLowerCase();
    const phone = card.getAttribute('data-phone').toLowerCase();
    const text = card.textContent.toLowerCase();
    
    if(orderId.includes(searchTerm) || phone.includes(searchTerm) || text.includes(searchTerm)) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

async function updateOrder(orderId) {
  const status = document.querySelector(`.admin-select[data-id="${orderId}"]`).value;
  const location = document.querySelector(`.admin-input[data-id="${orderId}"]`).value;
  const deliveryPerson = document.querySelectorAll(`.admin-input[data-id="${orderId}"]`)[1]?.value;
  
  const { error } = await supa
    .from('delivery_status')
    .update({
      status: status,
      location: location,
      delivery_person: deliveryPerson,
      last_updated: new Date().toISOString()
    })
    .eq('id', orderId);
    
  if(!error) {
    showNotification('‚úÖ Order updated successfully!');
    addInnerNotification('Order Updated', `Order #${document.querySelector(`.admin-order-card [data-order-id]`).textContent} updated to ${status}`, 'success');
    loadAdminPanel();
    if(currentPage === 'deliveryPage') loadDeliveryStatus();
  } else {
    showNotification('‚ùå Error updating order');
  }
}

function addNewOrder() {
  const orderId = prompt("Enter Order ID:");
  const customerPhone = prompt("Enter Customer Phone:");
  const customerName = prompt("Enter Customer Name (optional):");
  
  if(!orderId || !customerPhone) {
    showNotification('‚ùå Order ID and Phone are required');
    return;
  }
  
  supa
    .from('delivery_status')
    .insert([{
      order_id: orderId,
      customer_phone: customerPhone,
      customer_name: customerName || '',
      tracking_number: generateTrackingNumber(),
      status: 'pending',
      location: '',
      delivery_person: '',
      last_updated: new Date().toISOString()
    }])
    .then(({ error }) => {
      if(!error) {
        showNotification('‚úÖ Order added successfully!');
        addInnerNotification('New Order', `Order #${orderId} added for ${customerName || customerPhone}`, 'success');
        loadAdminPanel();
      } else {
        showNotification('‚ùå Error adding order: ' + error.message);
      }
    });
}

// ===== NOTIFICATION SYSTEM =====
function showNotification(message) {
  const notification = document.getElementById('notificationAlert');
  notification.textContent = message;
  notification.style.display = 'block';
  
  setTimeout(() => {
    notification.style.display = 'none';
  }, 3000);
}

// ===== AUTO-REFRESH DELIVERIES =====
setInterval(checkForDeliveries, 30000);

// ===== MAIN APP VARIABLES =====
let card = {};
let currentProduct = null;
let cart = [];
let currentPage = 'loadingScreen';
let deliveryStatusData = [];
let businessAdminPassword = "";
let shortCardId = "";
let isAdminLoggedIn = false;

// ===== RENDER APP =====
async function renderApp() {
  setupDynamicPWA(card);
  
  document.getElementById('businessHeader').textContent = card.businessName || card.name || "Premium Business";
  
  const photo = document.getElementById('photo');
  if(card.profileImage) {
    photo.src = card.profileImage;
  } else {
    photo.style.display = 'none';
  }
  
  document.getElementById('name').textContent = card.name || "";
  document.getElementById('business').textContent = card.businessName || "";
  
  document.getElementById('contactPhone').textContent = card.phone || "Not available";
  document.getElementById('contactEmail').textContent = card.email || "Not available";
  document.getElementById('contactAddress').textContent = card.address || "Not available";
  
  // Set business location if available
  if (card.businessLocation) {
    businessLocation = {
      lat: card.businessLocation.lat || 24.8607,
      lng: card.businessLocation.lng || 67.0011
    };
  }
  
  loadHomePage();
}

// ===== CART MANAGEMENT FUNCTIONS =====
function updateCartCount() {
  const count = cart.length;
  document.getElementById('cartCountMini').textContent = count;
  document.getElementById('cartBadge').textContent = count;
  
  isolatedLocalStorage.setItem('cart', JSON.stringify(cart));
  
  if(currentPage === 'cartPage') loadCartPage();
}

function addToCart(productIndex) {
  const products = card.products || [];
  const product = products[productIndex];
  
  if(product) {
    const existingIndex = cart.findIndex(item => 
      item.title === product.title && item.discountPrice === product.discountPrice
    );
    
    if(existingIndex === -1) {
      cart.push({ ...product, index: productIndex, quantity: 1 });
    } else {
      cart[existingIndex].quantity = (cart[existingIndex].quantity || 1) + 1;
    }
    updateCartCount();
    showNotification('Product added to cart!');
    addInnerNotification('Cart Updated', `${product.title} added to cart`, 'info');
  }
}

function removeFromCart(index) {
  if(cart[index]) {
    const productName = cart[index].title;
    cart.splice(index, 1);
    updateCartCount();
    showNotification('Product removed from cart!');
    addInnerNotification('Cart Updated', `${productName} removed from cart`, 'info');
  }
}

function updateQuantity(index, change) {
  if(cart[index]) {
    const oldQty = cart[index].quantity || 1;
    cart[index].quantity = Math.max(1, oldQty + change);
    loadCartPage();
    if (change > 0) addInnerNotification('Cart Updated', `Increased quantity of ${cart[index].title}`, 'info');
  }
}

function quickBuyProduct() {
  if (currentProduct) {
    // Add to cart first
    const products = card.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    if (productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
      navigateTo('checkoutPage');
    }
  }
}

function loadHomePage() {
  const featuredProducts = document.getElementById('featuredProducts');
  const products = card.products || [];
  
  featuredProducts.innerHTML = '';
  
  const featuredProductsList = products.filter(product => 
    product.badges && product.badges.length > 0
  ).slice(0, 4);
  
  featuredProductsList.forEach((product, index) => {
    const originalIndex = products.findIndex(p => p.title === product.title);
    featuredProducts.appendChild(createProductCard(product, originalIndex));
  });
  
  if(featuredProductsList.length === 0) {
    products.slice(0, 4).forEach((product, index) => {
      featuredProducts.appendChild(createProductCard(product, index));
    });
  }
}

function loadProductsPage() {
  const allProducts = document.getElementById('allProducts');
  const products = card.products || [];
  
  allProducts.innerHTML = '';
  
  products.forEach((product, index) => {
    allProducts.appendChild(createProductCard(product, index));
  });
}

function createProductCard(product, index) {
  const price = product.discountPrice || product.originalPrice;
  const originalPrice = product.originalPrice && product.discountPrice ? product.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  let discountPercentage = '';
  if(hasDiscount && originalPrice && price) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    if(discount > 0) discountPercentage = `<div class="discount-badge">${discount}% OFF</div>`;
  }
  
  let priceBadgeHtml = '';
  if(price) {
    priceBadgeHtml = `<div class="price-badge">`;
    if(hasDiscount && originalPrice) {
      priceBadgeHtml += `<div class="original-price">PKR ${originalPrice}</div>`;
      priceBadgeHtml += `<div class="current-price">PKR ${price}</div>`;
    } else {
      priceBadgeHtml += `<div class="current-price">PKR ${price}</div>`;
    }
    priceBadgeHtml += `</div>`;
  }
  
  const badgeClasses = {
    'üî• Hot Deal': 'hot', '‚≠ê Best Seller': 'best-seller', 'üí∏ Discount': 'discount',
    '‚è≥ Limited Stock': 'limited', 'üõí In Stock': 'stock', 'üöö Free Delivery': 'delivery'
  };
  
  let badgesHtml = '';
  if(product.badges && product.badges.length > 0) {
    badgesHtml = `<div class="product-badges">`;
    product.badges.slice(0, 2).forEach(badge => {
      const badgeClass = badgeClasses[badge] || 'discount';
      badgesHtml += `<span class="badge ${badgeClass}">${badge}</span>`;
    });
    badgesHtml += `</div>`;
  }
  
  const cardElement = document.createElement('div');
  cardElement.className = 'product-card';
  
  cardElement.innerHTML = `
    <div class="product-image-container" onclick="zoomImage('${product.image || ''}', event)">
      <img src="${product.image || ''}" class="product-image" loading="lazy" onerror="this.style.display='none'">
      ${discountPercentage}
      ${priceBadgeHtml}
      ${badgesHtml}
    </div>
    <div class="product-content">
      <div class="product-title">${product.title || 'Product'}</div>
      <div class="product-actions">
        <button class="btn-primary" onclick="showProductModal(${index}); event.stopPropagation();">
          <i class="fas fa-bolt"></i> Quick Buy
        </button>
        <button class="btn-secondary" onclick="addToCart(${index}); event.stopPropagation();">
          <i class="fas fa-cart-plus"></i> Add to Cart
        </button>
      </div>
    </div>
  `;
  
  cardElement.onclick = (e) => {
    if (!e.target.closest('button')) showProductModal(index);
  };
  
  return cardElement;
}

function zoomImage(imageUrl, event) {
  event.stopPropagation();
  
  const overlay = document.getElementById('imageZoomOverlay');
  const zoomedImage = document.getElementById('zoomedImage');
  
  if (imageUrl) {
    zoomedImage.src = imageUrl;
    overlay.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  }
}

function closeImageZoom() {
  const overlay = document.getElementById('imageZoomOverlay');
  overlay.style.display = 'none';
  document.body.style.overflow = 'auto';
}

function filterProducts() {
  const searchTerm = document.getElementById('productsSearch').value.toLowerCase();
  const products = card.products || [];
  const allProducts = document.getElementById('allProducts');
  
  allProducts.innerHTML = '';
  
  const filteredProducts = products.filter(product => 
    product.title?.toLowerCase().includes(searchTerm) ||
    product.desc?.toLowerCase().includes(searchTerm) ||
    (product.badges && product.badges.some(badge => badge.toLowerCase().includes(searchTerm)))
  );
  
  filteredProducts.forEach((product, index) => {
    const originalIndex = products.findIndex(p => p.title === product.title);
    allProducts.appendChild(createProductCard(product, originalIndex));
  });
}

function loadCartPage() {
  const cartContent = document.getElementById('cartContent');
  const cartItemsCount = document.getElementById('cartItemsCount');
  
  if(cart.length === 0) {
    cartContent.innerHTML = `
      <div class="cart-empty">
        <i class="fas fa-shopping-cart"></i>
        <h3>Your cart is empty</h3>
        <p>Add some products to get started</p>
        <button onclick="navigateTo('productsPage')">
          Browse Products
        </button>
      </div>
    `;
    cartItemsCount.textContent = '0 items';
    return;
  }
  
  let html = '<div class="cart-items">';
  let total = 0;
  
  cart.forEach((item, index) => {
    const price = parseFloat(item.discountPrice || item.originalPrice || 0);
    const itemTotal = price * (item.quantity || 1);
    total += itemTotal;
    
    html += `
      <div class="cart-item">
        <img src="${item.image || ''}" class="cart-item-img" loading="lazy" onerror="this.style.display='none'">
        <div class="cart-item-details">
          <div class="cart-item-title">${item.title || 'Product'}</div>
          <div class="cart-item-price">PKR ${itemTotal.toFixed(2)}</div>
          <div class="cart-item-actions">
            <div class="quantity-control">
              <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
              <span class="quantity">${item.quantity || 1}</span>
              <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
            </div>
            <button class="remove-btn" onclick="removeFromCart(${index})">
              Remove
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  html += `
    <div class="cart-summary">
      <h3><i class="fas fa-receipt"></i> Order Summary</h3>
      <div class="summary-row">
        <span>Subtotal</span>
        <span>PKR ${total.toFixed(2)}</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span>Calculated at checkout</span>
      </div>
      <div class="summary-row summary-total">
        <span>Total</span>
        <span>PKR ${total.toFixed(2)}</span>
      </div>
      <button class="checkout-btn" onclick="navigateTo('checkoutPage')">
        <i class="fas fa-lock"></i> Proceed to Checkout
      </button>
    </div>
  `;
  
  cartContent.innerHTML = html;
  cartItemsCount.textContent = `${cart.length} ${cart.length === 1 ? 'item' : 'items'}`;
}

function loadCheckoutPage() {
  // Reset checkout state
  verifiedAddress = null;
  selectedDeliveryOption = null;
  document.getElementById('deliveryCalculatorSection').style.display = 'none';
  document.getElementById('paymentGatewaySection').style.display = 'none';
  
  // Clear address fields
  document.getElementById('addressAutocomplete').value = '';
  document.getElementById('houseNumber').value = '';
  document.getElementById('deliveryCity').value = '';
  document.getElementById('deliveryCountry').value = '';
  document.getElementById('postalCode').value = '';
  
  // Detect user country again
  detectUserCountry();
}

function loadAboutPage() {
  const aboutContent = document.getElementById('aboutContent');
  const businessHours = document.getElementById('businessHours');
  const holidaysList = document.getElementById('holidaysList');
  
  aboutContent.innerHTML = `<p>${card.business?.about || 'No information available'}</p>`;
  
  if(card.businessHours && card.businessHours.length > 0) {
    const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    businessHours.innerHTML = '';
    
    card.businessHours.forEach((day, index) => {
      if(day) {
        const hourItem = document.createElement('div');
        hourItem.className = 'hour-item';
        
        if(!day.open || day.status === 'closed') {
          hourItem.innerHTML = `
            <span class="day-name">${days[index]}</span>
            <span class="day-time closed">Closed</span>
          `;
        } else {
          hourItem.innerHTML = `
            <span class="day-name">${days[index]}</span>
            <span class="day-time">${day.start || ''} - ${day.end || ''}</span>
          `;
        }
        businessHours.appendChild(hourItem);
      }
    });
  }
  
  if(card.holidays && card.holidays.length > 0) {
    holidaysList.innerHTML = '';
    card.holidays.forEach(holiday => {
      if(holiday.name && holiday.date) {
        const date = new Date(holiday.date);
        const formattedDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        
        const holidayItem = document.createElement('div');
        holidayItem.className = 'hour-item';
        holidayItem.innerHTML = `
          <span class="day-name">${holiday.name}</span>
          <span class="day-time">${formattedDate}</span>
        `;
        holidaysList.appendChild(holidayItem);
      }
    });
  }
}

function loadContactPage() {
  const socialGrid = document.getElementById('socialGrid');
  const socialMedia = card.socialMedia || {};
  
  socialGrid.innerHTML = '';
  
  const socialPlatforms = [
    { key: 'facebook', icon: 'fab fa-facebook-f', label: 'Facebook', className: 'facebook' },
    { key: 'instagram', icon: 'fab fa-instagram', label: 'Instagram', className: 'instagram' },
    { key: 'twitter', icon: 'fab fa-twitter', label: 'Twitter', className: 'twitter' },
    { key: 'linkedin', icon: 'fab fa-linkedin-in', label: 'LinkedIn', className: 'linkedin' },
    { key: 'youtube', icon: 'fab fa-youtube', label: 'YouTube', className: 'youtube' },
    { key: 'tiktok', icon: 'fab fa-tiktok', label: 'TikTok', className: 'tiktok' }
  ];
  
  socialPlatforms.forEach(platform => {
    const url = socialMedia[platform.key];
    if(url && url.trim()) {
      const socialLink = document.createElement('a');
      socialLink.className = 'social-link';
      socialLink.href = url.includes('://') ? url : `https://${url}`;
      socialLink.target = '_blank';
      socialLink.innerHTML = `
        <div class="social-icon ${platform.className}">
          <i class="${platform.icon}"></i>
        </div>
        <div class="social-label">${platform.label}</div>
      `;
      socialGrid.appendChild(socialLink);
    }
  });
}

function showProductModal(productIndex) {
  const products = card.products || [];
  currentProduct = products[productIndex];
  
  if(!currentProduct) return;
  
  const price = currentProduct.discountPrice || currentProduct.originalPrice;
  const originalPrice = currentProduct.originalPrice && currentProduct.discountPrice ? currentProduct.originalPrice : null;
  const hasDiscount = originalPrice && price && originalPrice > price;
  
  document.getElementById('modalImage').src = currentProduct.image || '';
  document.getElementById('modalTitle').textContent = currentProduct.title || 'Product';
  document.getElementById('modalDescription').textContent = currentProduct.desc || 'No description available';
  
  const modalPrice = document.getElementById('modalPrice');
  if(hasDiscount) {
    const discount = Math.round(((originalPrice - price) / originalPrice) * 100);
    modalPrice.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <div style="text-decoration:line-through;color:#94a3b8;font-size:16px;font-weight:500;">PKR ${originalPrice}</div>
        <div style="color:#10b981;font-size:24px;font-weight:900;">PKR ${price}</div>
        <div style="background:var(--danger-gradient);color:white;padding:4px 8px;border-radius:4px;font-size:13px;font-weight:800;">${discount}% OFF</div>
      </div>
    `;
  } else {
    modalPrice.innerHTML = `<div style="color:#10b981;font-size:24px;font-weight:900;">PKR ${price || 'N/A'}</div>`;
  }
  
  openModal('productModal');
}

function addToCartFromModal() {
  if(currentProduct) {
    const products = card.products || [];
    const productIndex = products.findIndex(p => p.title === currentProduct.title);
    if(productIndex !== -1) {
      addToCart(productIndex);
      closeModal('productModal');
    }
  }
}

function openWhatsAppChat(context) {
  if(!card.phone) {
    showNotification('WhatsApp number not available');
    return;
  }
  
  const phone = card.phone.replace(/\D/g, '');
  const businessName = card.businessName || card.name || "Your Business";
  
  let message = `Hello ${businessName} Team,\n\n`;
  
  if (context === 'order' && activeOrder) {
    message += `I have a question about my order #${activeOrder.order_id}.\n\n`;
    message += `Order ID: ${activeOrder.order_id}\n`;
    message += `Tracking: ${activeOrder.tracking_number || 'Not available'}\n\n`;
  } else {
    message += `I came across your business and I'm interested in your products/services.\n`;
    message += `Could you please share more information about:\n`;
    message += `1. Current offers/discounts\n`;
    message += `2. Product availability\n`;
    message += `3. Delivery options and charges\n\n`;
  }
  
  message += `Thank you!`;
  
  window.open(`https://wa.me/${phone}?text=${encodeURIComponent(message)}`, '_blank');
}

function makeCall() {
  if(card.phone) window.open(`tel:${card.phone}`);
}

function sendEmail() {
  if(card.email) {
    const subject = encodeURIComponent(`Inquiry - ${card.businessName || 'Business'}`);
    const body = encodeURIComponent(`Hello,\n\nI would like to know more about your products/services.\n\nPlease share more information.\n\nThank you!`);
    window.open(`mailto:${card.email}?subject=${subject}&body=${body}`);
  }
}

function openMap() {
  if(card.address) window.open(`https://maps.google.com/?q=${encodeURIComponent(card.address)}`, '_blank');
}

function openModal(modalId) {
  document.getElementById(modalId).style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeModal(modalId) {
  document.getElementById(modalId).style.display = 'none';
  document.body.style.overflow = 'auto';
}

function openDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'flex';
  document.body.style.overflow = 'hidden';
}

function closeDeliveryModal() {
  document.getElementById('deliveryStatusModal').style.display = 'none';
  document.body.style.overflow = 'auto';
}

// ===== INITIALIZE APP =====
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(location.search);
  let id = urlParams.get("id") || localStorage.getItem("lastCardId");
  
  console.log("Initial ID from URL:", id);
  
  if (id && id.length === 6) {
    console.log("Detected short ID (6 chars), looking up full ID...");
    const { data: mapping } = await supa
      .from('short_urls')
      .select('full_id')
      .eq('short_id', id)
      .single();
    
    if (mapping) {
      id = mapping.full_id;
      shortCardId = mapping.short_id;
      console.log("Found mapping: short", shortCardId, "-> full", id.substring(0, 8) + "...");
    } else {
      console.log("No mapping found for short ID:", id);
    }
  } else if (id && id.length === 36) {
    console.log("Detected full UUID, generating short ID...");
    const shortId = generateShortId();
    const { error } = await supa
      .from('short_urls')
      .insert([{ short_id: shortId, full_id: id }]);
    
    if (!error) {
      shortCardId = shortId;
      console.log("Generated short ID:", shortCardId);
    } else {
      console.log("Error creating short ID:", error);
      const { data: existing } = await supa
        .from('short_urls')
        .select('short_id')
        .eq('full_id', id)
        .single();
      if (existing) shortCardId = existing.short_id;
    }
  }
  
  if(!id) {
    document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Card not found</h2></div>";
    return;
  }

  localStorage.setItem("lastCardId", id);
  currentBusinessId = id;
  
  const savedCart = isolatedLocalStorage.getItem('cart');
  cart = savedCart ? JSON.parse(savedCart) : [];
  
  isAdminLoggedIn = isolatedLocalStorage.getItem('isAdminLoggedIn') === 'true';
  
  loadInnerNotifications();
  initCustomerData();
  
  setTimeout(() => showInstallPermissionModal(), 5000);
  
  setTimeout(async () => {
    const {data, error} = await supa.from("cards").select("*").eq("id", id).single();
    if(error || !data) {
      document.body.innerHTML = "<div style='padding:40px;text-align:center;color:white;'><h2>Card not found</h2></div>";
      return;
    }

    card = JSON.parse(data.data);
    card.id = data.id;
    
    if (card.phone) saveBusinessPhone(card.phone);
    
    businessAdminPassword = generateAdminPassword(card.id, shortCardId);
    console.log("Admin password generated:", businessAdminPassword);
    console.log("Short ID for this business:", shortCardId);
    
    if (shortCardId) {
      document.getElementById('passwordHint').textContent = `Hint: Password format is business123_${shortCardId.toLowerCase()}`;
    }
    
    await renderApp();
    initializeRouting();
    navigationHistory.push('homePage');
    
    updateCartCount();
    updateLoginUI();
    updateCustomerPhoneDisplay();
    updateNotificationBellCount();
    
    setTimeout(() => checkNotificationPermission(), 1000);
    setTimeout(() => checkForDeliveries(), 1000);
    
    setTimeout(() => {
      if (innerNotifications.length === 0) {
        addInnerNotification('Welcome!', 'Get started by browsing products or enabling notifications', 'info');
      }
    }, 2000);
  }, 2000);
});

// Initialize notifications when app starts
document.addEventListener('DOMContentLoaded', function() {
  setTimeout(() => checkNotificationPermission(), 3000);
});
</script>
</body>
</html>
