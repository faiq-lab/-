<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Business Card ‚Ä¢ Real-Time</title>
    
    <!-- Core Dependencies -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- SQL.js for Offline -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <style>
        :root {
            --primary: linear-gradient(135deg, #667eea, #764ba2);
            --gold: linear-gradient(135deg, #bf9530, #fcf6ba, #b38728);
            --success: #10b981;
            --danger: #ef4444;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(145deg, #f8fafc, #f1f5f9);
            min-height: 100vh;
            padding: 20px;
        }
        
        .card-container {
            max-width: 500px;
            margin: 0 auto;
        }
        
        .digital-card {
            background: white;
            border-radius: 32px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
            padding: 28px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            animation: slideIn 0.5s ease;
        }
        
        .digital-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: var(--primary);
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .profile-section {
            text-align: center;
            margin-bottom: 24px;
        }
        
        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #667eea;
            padding: 4px;
            background: white;
            margin-bottom: 16px;
        }
        
        .business-name {
            font-size: 24px;
            font-weight: 800;
            background: var(--primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        
        .owner-name {
            color: #64748b;
            font-size: 16px;
            margin-bottom: 4px;
        }
        
        .contact-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .contact-item {
            background: #f8fafc;
            padding: 16px;
            border-radius: 16px;
            text-align: center;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
            cursor: pointer;
        }
        
        .contact-item:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102,126,234,0.2);
        }
        
        .contact-item i {
            font-size: 20px;
            color: #667eea;
            margin-bottom: 8px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #0f172a;
        }
        
        .about-text {
            background: #f8fafc;
            padding: 16px;
            border-radius: 16px;
            color: #334155;
            line-height: 1.6;
            margin-bottom: 24px;
            border: 1px solid #e2e8f0;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .product-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s;
        }
        
        .product-card:hover {
            border-color: #667eea;
            box-shadow: 0 10px 25px rgba(102,126,234,0.1);
            transform: translateY(-2px);
        }
        
        .product-image {
            width: 100%;
            height: 120px;
            object-fit: contain;
            margin-bottom: 12px;
        }
        
        .product-title {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .product-price {
            font-weight: 800;
            color: #667eea;
            font-size: 16px;
        }
        
        .original-price {
            text-decoration: line-through;
            color: #94a3b8;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .whatsapp-button {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 16px 24px;
            font-size: 18px;
            font-weight: 700;
            width: 100%;
            margin-bottom: 20px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .whatsapp-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(37,211,102,0.3);
            color: white;
        }
        
        .delivery-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .social-links {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .social-link {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #f1f5f9;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #334155;
            font-size: 20px;
            transition: all 0.3s;
        }
        
        .social-link:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            flex-direction: column;
            gap: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-card {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 32px;
        }
        
        .error-card i {
            font-size: 64px;
            color: #ef4444;
            margin-bottom: 20px;
        }
        
        .live-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 10px 30px rgba(16,185,129,0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s infinite;
        }
        
        .pulse {
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            animation: pulseDot 1.5s infinite;
        }
        
        @keyframes pulseDot {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        @media (max-width: 480px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .contact-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="card-container">
        <div id="cardContent">
            <!-- Loading State -->
            <div class="digital-card loading-spinner" id="loadingState">
                <div class="spinner"></div>
                <p class="text-muted">Loading your digital card...</p>
                <small class="text-muted">Fetching real-time data from server</small>
            </div>
        </div>
    </div>
    
    <!-- Live Status Badge (Only shows when data loaded) -->
    <div class="live-badge" id="liveBadge" style="display: none;">
        <span class="pulse"></span>
        LIVE ‚Ä¢ Real Data from Supabase
    </div>

    <script>
        // ========== SUPABASE CONNECTION ==========
        const supabase = supabase.createClient(
            "https://dfvnefbxgayxqgjjgtrr.supabase.co",
            "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
        );

        // ========== GET CARD ID FROM URL ==========
        function getCardId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || urlParams.get('short_id');
        }

        // ========== MAIN FUNCTION ==========
        async function loadCard() {
            const cardId = getCardId();
            
            if (!cardId) {
                showError('No Card ID provided. Please check the URL.');
                return;
            }

            try {
                // 1. Try short URL first
                let actualId = cardId;
                
                const { data: shortData, error: shortError } = await supabase
                    .from('short_urls')
                    .select('full_id')
                    .eq('short_id', cardId)
                    .single();
                
                if (shortData) {
                    actualId = shortData.full_id;
                }
                
                // 2. Get card data
                const { data: card, error } = await supabase
                    .from('cards')
                    .select('*')
                    .eq('id', actualId)
                    .single();
                
                if (error) throw error;
                
                if (card) {
                    // Parse the JSON data
                    const cardData = JSON.parse(card.data);
                    
                    // Render the card
                    renderCard(cardData, actualId);
                    
                    // Update view count
                    await supabase
                        .from('cards')
                        .update({ views: (card.views || 0) + 1 })
                        .eq('id', actualId);
                    
                    // Show live badge
                    document.getElementById('liveBadge').style.display = 'flex';
                    
                    // Setup realtime subscription
                    setupRealtimeSubscription(actualId);
                } else {
                    showError('Card not found');
                }
                
            } catch (error) {
                console.error('Error loading card:', error);
                showError('Failed to load card: ' + error.message);
            }
        }

        // ========== RENDER CARD ==========
        function renderCard(data, cardId) {
            const container = document.getElementById('cardContent');
            
            // Hide loading state
            document.getElementById('loadingState').style.display = 'none';
            
            // Generate WhatsApp link
            const whatsappNumber = data.payments?.whatsapp?.number || data.phone;
            const cleanNumber = whatsappNumber ? whatsappNumber.replace(/[^0-9]/g, '') : '';
            const whatsappGreeting = data.payments?.whatsapp?.greeting || 
                `Hello ${data.businessName || 'there'}! I'm interested in your products.`;
            
            // Build products HTML
            let productsHTML = '';
            if (data.products && data.products.length > 0) {
                productsHTML = `
                    <div class="section-title">
                        <i class="fas fa-tag" style="color: #667eea;"></i>
                        Products & Offers
                    </div>
                    <div class="products-grid">
                        ${data.products.map(p => `
                            <div class="product-card">
                                ${p.image ? `<img src="${p.image}" class="product-image" alt="${p.title}">` : ''}
                                <h4 class="product-title">${p.title || 'Product'}</h4>
                                <p class="small text-muted">${p.desc || ''}</p>
                                <div>
                                    ${p.originalPrice ? `<span class="original-price">PKR ${p.originalPrice}</span>` : ''}
                                    <span class="product-price">PKR ${p.discountPrice || '0'}</span>
                                </div>
                                <button class="btn btn-sm btn-primary w-100 mt-2" onclick="addToCart('${p.title}', ${p.discountPrice || 0})">
                                    <i class="fas fa-shopping-cart me-2"></i>Add to Cart
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Build delivery HTML
            let deliveryHTML = '';
            if (data.deliverySettings) {
                deliveryHTML = `
                    <div class="section-title">
                        <i class="fas fa-truck" style="color: #667eea;"></i>
                        Delivery Information
                    </div>
                    <div class="delivery-info">
                        <div class="d-flex justify-content-between mb-2">
                            <span>üìç Within City:</span>
                            <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeCity || '150'}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>üöö Other Cities:</span>
                            <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeOther || '300'}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>üéÅ Free Delivery:</span>
                            <span class="fw-700 text-success">Above PKR ${data.deliverySettings.freeDeliveryMin || '2000'}</span>
                        </div>
                        <hr class="my-2">
                        <small class="text-muted">Delivery Time: ${data.deliverySettings.deliveryTimeCity || '1-2 days'} (City) / ${data.deliverySettings.deliveryTimeOther || '3-5 days'} (Other)</small>
                    </div>
                `;
            }
            
            // Build social links
            let socialHTML = '';
            if (data.socialMedia) {
                const socialIcons = {
                    facebook: 'fab fa-facebook',
                    instagram: 'fab fa-instagram',
                    twitter: 'fab fa-twitter',
                    linkedin: 'fab fa-linkedin',
                    youtube: 'fab fa-youtube',
                    tiktok: 'fab fa-tiktok'
                };
                
                const socialLinks = Object.entries(data.socialMedia)
                    .filter(([key, value]) => value && value.trim() !== '')
                    .map(([key, value]) => `
                        <a href="${value}" target="_blank" class="social-link" title="${key}">
                            <i class="${socialIcons[key] || 'fas fa-link'}"></i>
                        </a>
                    `).join('');
                
                if (socialLinks) {
                    socialHTML = `
                        <div class="section-title">
                            <i class="fas fa-share-alt" style="color: #667eea;"></i>
                            Connect With Us
                        </div>
                        <div class="social-links">
                            ${socialLinks}
                        </div>
                    `;
                }
            }
            
            // Build complete card HTML
            const cardHTML = `
                <div class="digital-card">
                    <!-- Profile Section -->
                    <div class="profile-section">
                        ${data.profileImage ? 
                            `<img src="${data.profileImage}" class="profile-image" alt="Profile">` : 
                            `<div class="profile-image" style="background: linear-gradient(135deg, #667eea20, #764ba220); display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-user fa-4x" style="color: #667eea;"></i>
                            </div>`
                        }
                        <h1 class="business-name">${data.businessName || 'Business Name'}</h1>
                        <p class="owner-name">${data.name || 'Owner Name'}</p>
                        ${data.address ? `<p class="text-muted small"><i class="fas fa-map-marker-alt me-2"></i>${data.address}</p>` : ''}
                    </div>
                    
                    <!-- Contact Information -->
                    <div class="contact-info">
                        ${data.phone ? `
                            <a href="tel:${data.phone}" class="contact-item" style="text-decoration: none;">
                                <i class="fas fa-phone-alt"></i>
                                <div class="fw-600">Call Now</div>
                                <small>${data.phone}</small>
                            </a>
                        ` : ''}
                        ${data.email ? `
                            <a href="mailto:${data.email}" class="contact-item" style="text-decoration: none;">
                                <i class="fas fa-envelope"></i>
                                <div class="fw-600">Email</div>
                                <small>${data.email}</small>
                            </a>
                        ` : ''}
                    </div>
                    
                    <!-- About Business -->
                    ${data.business?.about ? `
                        <div class="section-title">
                            <i class="fas fa-info-circle" style="color: #667eea;"></i>
                            About
                        </div>
                        <div class="about-text">
                            ${data.business.about}
                        </div>
                    ` : ''}
                    
                    <!-- WhatsApp Order Button -->
                    ${cleanNumber ? `
                        <a href="https://wa.me/${cleanNumber}?text=${encodeURIComponent(whatsappGreeting)}" 
                           target="_blank" 
                           class="whatsapp-button">
                            <i class="fab fa-whatsapp fa-lg"></i>
                            Order via WhatsApp
                        </a>
                    ` : ''}
                    
                    <!-- Products -->
                    ${productsHTML}
                    
                    <!-- Delivery Settings -->
                    ${deliveryHTML}
                    
                    <!-- Social Media -->
                    ${socialHTML}
                    
                    <!-- Website Link -->
                    ${data.website ? `
                        <div class="text-center mt-4">
                            <a href="${data.website}" target="_blank" class="btn btn-outline-primary">
                                <i class="fas fa-globe me-2"></i>Visit Website
                            </a>
                        </div>
                    ` : ''}
                    
                    <!-- Card ID for reference -->
                    <div class="text-center mt-4 pt-3 border-top">
                        <small class="text-muted">
                            <i class="fas fa-id-card me-1"></i>
                            Card ID: ${cardId}
                        </small>
                    </div>
                </div>
            `;
            
            container.innerHTML = cardHTML;
            
            // Update page title
            document.title = `${data.businessName || 'Digital Card'} - Digital Business Card`;
        }

        // ========== ADD TO CART ==========
        window.addToCart = function(productName, price) {
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.push({
                name: productName,
                price: price,
                quantity: 1,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            
            // Show notification
            showNotification('‚úÖ Added to cart!');
            
            // Redirect to checkout page
            setTimeout(() => {
                window.location.href = 'card-checkout.html';
            }, 1500);
        };

        // ========== SHOW NOTIFICATION ==========
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 12px 24px;
                border-radius: 50px;
                font-weight: 600;
                z-index: 99999;
                animation: slideDown 0.3s ease;
                box-shadow: 0 10px 30px rgba(16,185,129,0.3);
            `;
            notification.innerHTML = `<i class="fas fa-check-circle me-2"></i>${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // ========== SHOW ERROR ==========
        function showError(message) {
            const container = document.getElementById('cardContent');
            document.getElementById('loadingState').style.display = 'none';
            
            container.innerHTML = `
                <div class="digital-card error-card">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3 class="fw-700 mb-3">Oops! Something went wrong</h3>
                    <p class="text-muted mb-4">${message}</p>
                    <button onclick="location.reload()" class="btn btn-primary">
                        <i class="fas fa-redo me-2"></i>Try Again
                    </button>
                    <a href="index.html" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-home me-2"></i>Home
                    </a>
                </div>
            `;
        }

        // ========== REALTIME SUBSCRIPTION ==========
        function setupRealtimeSubscription(cardId) {
            supabase
                .channel('card-updates')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'cards',
                    filter: `id=eq.${cardId}`
                }, (payload) => {
                    // Card was updated in real-time
                    const newData = JSON.parse(payload.new.data);
                    renderCard(newData, cardId);
                    
                    // Show update notification
                    showNotification('‚ú® Card updated in real-time!');
                })
                .subscribe();
        }

        // ========== CHECK FOR CART REDIRECT ==========
        function checkCartRedirect() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            if (cart.length > 0) {
                // Show mini cart notification
                const cartBtn = document.createElement('a');
                cartBtn.href = 'card-checkout.html';
                cartBtn.style.cssText = `
                    position: fixed;
                    bottom: 100px;
                    right: 20px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    color: white;
                    padding: 16px 24px;
                    border-radius: 50px;
                    font-weight: 600;
                    z-index: 9998;
                    text-decoration: none;
                    box-shadow: 0 10px 30px rgba(102,126,234,0.4);
                    display: flex;
                    align-items: center;
                    gap: 12px;
                `;
                cartBtn.innerHTML = `
                    <i class="fas fa-shopping-cart"></i>
                    <span>${cart.length} item${cart.length > 1 ? 's' : ''} in cart</span>
                    <i class="fas fa-arrow-right"></i>
                `;
                document.body.appendChild(cartBtn);
            }
        }

        // ========== INITIALIZE ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadCard();
            checkCartRedirect();
        });
    </script>
</body>
</html>
