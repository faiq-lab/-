<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digital Business Card • Real System</title>
    
    <!-- Core -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- SQL.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <style>
        /* Your existing premium styles - I'll add real-time updates */
        .real-time-badge {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            box-shadow: 0 10px 30px rgba(16,185,129,0.3);
            z-index: 9999;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .offline-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ef4444;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Real-Time Status -->
    <div class="real-time-badge" id="liveStatus">
        <i class="fas fa-circle me-2" style="color: #fff;"></i>
        LIVE • Real Data
    </div>
    
    <div class="offline-indicator" id="offlineIndicator">
        <i class="fas fa-wifi-slash me-2"></i> Offline Mode
    </div>

    <div class="container py-4">
        <div id="cardContent">
            <!-- Dynamic Content Loaded Here -->
        </div>
    </div>

    <script>
        // ========== REAL SUPABASE CONNECTION ==========
        const supabase = supabase.createClient(
            "https://dfvnefbxgayxqgjjgtrr.supabase.co",
            "sb_publishable_WypeFELCIlVDlqGY4PdWwA_snqoPUSE"
        );

        // ========== LOCAL DATABASE (OFFLINE FIRST) ==========
        let SQL = null;
        let localDB = null;
        let currentCardData = null;
        let cardId = null;

        // ========== INITIALIZE SYSTEM ==========
        async function initSystem() {
            await initLocalDatabase();
            await loadCardData();
            setupRealtimeSubscription();
            setupOfflineSupport();
        }

        // ========== LOCAL DATABASE FOR OFFLINE ==========
        async function initLocalDatabase() {
            try {
                SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                localDB = new SQL.Database();
                
                // Create tables for offline storage
                localDB.run(`
                    CREATE TABLE IF NOT EXISTS offline_cards (
                        id TEXT PRIMARY KEY,
                        data TEXT,
                        last_updated TEXT,
                        synced INTEGER DEFAULT 0
                    );
                    
                    CREATE TABLE IF NOT EXISTS offline_orders (
                        id TEXT PRIMARY KEY,
                        card_id TEXT,
                        order_data TEXT,
                        created_at TEXT,
                        synced INTEGER DEFAULT 0
                    );
                    
                    CREATE TABLE IF NOT EXISTS backups (
                        id INTEGER PRIMARY KEY AUTOINCREMENT,
                        backup_date TEXT,
                        backup_data TEXT,
                        type TEXT
                    );
                `);
                
                console.log('✅ Local database ready');
            } catch (error) {
                console.error('Local DB error:', error);
            }
        }

        // ========== LOAD CARD DATA ==========
        async function loadCardData() {
            const urlParams = new URLSearchParams(window.location.search);
            cardId = urlParams.get('id') || urlParams.get('short_id');
            
            if (!cardId) {
                document.getElementById('cardContent').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-4x text-warning mb-3"></i>
                        <h3>No Card ID Provided</h3>
                        <p class="text-muted">Please provide a valid card ID</p>
                    </div>
                `;
                return;
            }

            // Try to load from local DB first (offline)
            await loadFromLocalDB();
            
            // Then load from Supabase (online)
            await loadFromSupabase();
        }

        // ========== LOAD FROM LOCAL DATABASE ==========
        async function loadFromLocalDB() {
            if (!localDB) return;
            
            try {
                const result = localDB.exec(
                    "SELECT data FROM offline_cards WHERE id = ?",
                    [cardId]
                );
                
                if (result.length > 0 && result[0].values.length > 0) {
                    currentCardData = JSON.parse(result[0].values[0][0]);
                    renderCard(currentCardData);
                    document.getElementById('offlineIndicator').style.display = 'block';
                }
            } catch (error) {
                console.log('No offline data found');
            }
        }

        // ========== LOAD FROM SUPABASE ==========
        async function loadFromSupabase() {
            try {
                // Try short URL first
                let { data: shortData, error: shortError } = await supabase
                    .from('short_urls')
                    .select('full_id')
                    .eq('short_id', cardId)
                    .single();
                
                let actualId = cardId;
                if (shortData) {
                    actualId = shortData.full_id;
                }
                
                // Get card data
                const { data: card, error } = await supabase
                    .from('cards')
                    .select('*')
                    .eq('id', actualId)
                    .single();
                
                if (error) throw error;
                
                if (card) {
                    currentCardData = JSON.parse(card.data);
                    renderCard(currentCardData);
                    
                    // Save to local DB for offline
                    saveToLocalDB(actualId, currentCardData);
                    
                    // Update view count
                    await supabase
                        .from('cards')
                        .update({ views: (card.views || 0) + 1 })
                        .eq('id', actualId);
                }
            } catch (error) {
                console.error('Supabase load error:', error);
                // Already showing offline data
            }
        }

        // ========== SAVE TO LOCAL DATABASE ==========
        function saveToLocalDB(id, data) {
            if (!localDB) return;
            
            try {
                const stmt = localDB.prepare(`
                    INSERT OR REPLACE INTO offline_cards (id, data, last_updated, synced)
                    VALUES (?, ?, ?, 1)
                `);
                
                stmt.run([id, JSON.stringify(data), new Date().toISOString()]);
                stmt.free();
                
                console.log('✅ Saved to local DB');
            } catch (error) {
                console.error('Save to local DB error:', error);
            }
        }

        // ========== REALTIME SUBSCRIPTION ==========
        function setupRealtimeSubscription() {
            if (!cardId) return;
            
            const subscription = supabase
                .channel('card_updates')
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'cards',
                    filter: `id=eq.${cardId}`
                }, (payload) => {
                    // Card was updated
                    const newData = JSON.parse(payload.new.data);
                    currentCardData = newData;
                    renderCard(newData);
                    
                    // Show update notification
                    showNotification('Card updated in real-time', 'info');
                })
                .subscribe();
        }

        // ========== OFFLINE SUPPORT ==========
        function setupOfflineSupport() {
            window.addEventListener('online', function() {
                document.getElementById('offlineIndicator').style.display = 'none';
                syncOfflineData();
            });
            
            window.addEventListener('offline', function() {
                document.getElementById('offlineIndicator').style.display = 'block';
            });
        }

        // ========== SYNC OFFLINE DATA ==========
        async function syncOfflineData() {
            if (!localDB) return;
            
            try {
                // Get unsynced orders
                const result = localDB.exec(
                    "SELECT * FROM offline_orders WHERE synced = 0"
                );
                
                if (result.length > 0) {
                    for (const row of result[0].values) {
                        const orderData = JSON.parse(row[2]);
                        
                        // Upload to Supabase
                        await supabase.from('orders').insert(orderData);
                        
                        // Mark as synced
                        localDB.run(
                            "UPDATE offline_orders SET synced = 1 WHERE id = ?",
                            [row[0]]
                        );
                    }
                    
                    showNotification('Offline data synced!', 'success');
                }
            } catch (error) {
                console.error('Sync error:', error);
            }
        }

        // ========== RENDER CARD ==========
        function renderCard(data) {
            const container = document.getElementById('cardContent');
            
            if (!data) {
                container.innerHTML = '<p class="text-center">No card data</p>';
                return;
            }

            // Create beautiful card display
            container.innerHTML = `
                <div class="dubai-royal-card">
                    <div class="text-center mb-4">
                        ${data.profileImage ? 
                            `<img src="${data.profileImage}" class="rounded-circle mb-3" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid var(--theme-gold);">` : 
                            `<div class="rounded-circle bg-warning d-inline-flex align-items-center justify-content-center mb-3" style="width: 120px; height: 120px;">
                                <i class="fas fa-user fa-4x text-white"></i>
                            </div>`
                        }
                        <h2 class="fw-800 mb-1">${data.businessName || 'Business Name'}</h2>
                        <p class="text-muted">${data.name || 'Owner Name'}</p>
                    </div>
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="bg-light p-3 rounded-3 text-center">
                                <i class="fas fa-phone text-primary mb-2"></i>
                                <h6 class="fw-600 mb-0">${data.phone || 'Not set'}</h6>
                                <small class="text-muted">Click to call</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="bg-light p-3 rounded-3 text-center">
                                <i class="fas fa-envelope text-primary mb-2"></i>
                                <h6 class="fw-600 mb-0">${data.email || 'Not set'}</h6>
                                <small class="text-muted">Email</small>
                            </div>
                        </div>
                    </div>
                    
                    ${data.business?.about ? `
                        <div class="mb-4">
                            <h5 class="fw-700 mb-2">About</h5>
                            <p class="text-muted">${data.business.about}</p>
                        </div>
                    ` : ''}
                    
                    ${data.products && data.products.length > 0 ? `
                        <h5 class="fw-700 mb-3">Products & Offers</h5>
                        <div class="offers-container mb-4">
                            ${data.products.map(p => `
                                <div class="offer-box">
                                    ${p.image ? `<img src="${p.image}" class="product-image mb-2">` : ''}
                                    <h6 class="fw-700">${p.title}</h6>
                                    <p class="small text-muted">${p.desc}</p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            ${p.originalPrice ? `<small class="text-muted text-decoration-line-through">$${p.originalPrice}</small>` : ''}
                                            <span class="fw-800 text-primary">$${p.discountPrice}</span>
                                        </div>
                                        <button class="btn btn-sm btn-warning" onclick="addToCart('${p.title}', ${p.discountPrice})">
                                            Add to Cart
                                        </button>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${data.deliverySettings ? `
                        <div class="delivery-settings mb-4">
                            <h5 class="fw-700 mb-3">Delivery Information</h5>
                            <div class="bg-light p-3 rounded-3">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Within City:</span>
                                    <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeCity}</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Other Cities:</span>
                                    <span class="fw-700">PKR ${data.deliverySettings.deliveryChargeOther}</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Free Delivery:</span>
                                    <span class="fw-700 text-success">Above PKR ${data.deliverySettings.freeDeliveryMin}</span>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${data.payments?.whatsapp?.number ? `
                        <div class="whatsapp-section mb-4">
                            <a href="https://wa.me/${data.payments.whatsapp.number.replace(/[^0-9]/g, '')}?text=${encodeURIComponent(data.payments.whatsapp.greeting || 'Hello! I want to order from your business')}" 
                               class="btn btn-success w-100 py-3" target="_blank">
                                <i class="fab fa-whatsapp me-2"></i> Order via WhatsApp
                            </a>
                        </div>
                    ` : ''}
                    
                    ${data.socialMedia ? `
                        <div class="social-section mt-4">
                            <h5 class="fw-700 mb-3">Connect With Us</h5>
                            <div class="d-flex gap-2 flex-wrap">
                                ${Object.entries(data.socialMedia).map(([key, value]) => value ? `
                                    <a href="${value}" class="btn btn-outline-secondary" target="_blank">
                                        <i class="fab fa-${key}"></i>
                                    </a>
                                ` : '').join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Update page title
            document.title = `${data.businessName || 'Business'} - Digital Card`;
        }

        // ========== NOTIFICATION SYSTEM ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '99999';
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.remove(), 3000);
        }

        // ========== ADD TO CART ==========
        window.addToCart = function(name, price) {
            // Store in local storage for checkout
            let cart = JSON.parse(localStorage.getItem('cart') || '[]');
            cart.push({
                name: name,
                price: price,
                quantity: 1,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('cart', JSON.stringify(cart));
            
            showNotification('Added to cart!', 'success');
            
            // Redirect to checkout if exists
            setTimeout(() => {
                window.location.href = 'card-checkout.html';
            }, 1500);
        };

        // ========== INITIALIZE ==========
        initSystem();
    </script>
</body>
</html>
